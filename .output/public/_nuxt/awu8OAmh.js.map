{"version":3,"file":"awu8OAmh.js","sources":["../../../pages/unsubscribe.vue"],"sourcesContent":["<template>\r\n\t<div class=\"unsubscribe-page\" v-cloak>\r\n\t\t<div class=\"card\">\r\n\t\t\t<h1>{{ t.subscriptionPages.unsubscribe.title }}</h1>\r\n\t\t\t<p v-if=\"status === 'pending'\">\r\n\t\t\t\t{{ t.subscriptionPages.unsubscribe.pending }}\r\n\t\t\t</p>\r\n\t\t\t<p v-else-if=\"status === 'success'\">\r\n\t\t\t\t{{ t.subscriptionPages.unsubscribe.success }}\r\n\t\t\t</p>\r\n\t\t\t<p v-else class=\"error\">\r\n\t\t\t\t{{ errorMessage }}\r\n\t\t\t</p>\r\n\r\n\t\t\t<div class=\"links\">\r\n\t\t\t\t<a :href=\"resubscribeHref\">\r\n\t\t\t\t\t{{ t.subscriptionPages.unsubscribe.linkText }}\r\n\t\t\t\t</a>\r\n\t\t\t\t<a :href=\"appHref\">{{ t.subscriptionPages.common.returnHome }}</a>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { computed, onMounted, ref } from 'vue';\r\nimport { useI18n } from '~/composables/useI18n';\r\n\r\ntype ErrorKey = 'genericError' | 'missingUser' | 'updateFailed';\r\n\r\nconst route = useRoute();\r\nconst status = ref<'pending' | 'success' | 'error'>('pending');\r\nconst { t, setLocale } = useI18n();\r\nconst errorKey = ref<ErrorKey>('genericError');\r\nconst errorMessage = computed(() => {\r\n\tconst common = t.value.subscriptionPages.common;\r\n\treturn (common[errorKey.value] as string) ?? '';\r\n});\r\nconst appHref = 'https://www.distrochess.com';\r\n\r\nconst userId = computed(() => {\r\n\tconst raw = route.query.userId;\r\n\tif (Array.isArray(raw)) return raw[0] ?? '';\r\n\treturn typeof raw === 'string' ? raw : '';\r\n});\r\n\r\nconst resubscribeHref = computed(() => {\r\n\tconst id = userId.value;\r\n\tif (!id) return `${appHref}/resubscribe`;\r\n\treturn `${appHref}/resubscribe?userId=${encodeURIComponent(id)}&unsub=false`;\r\n});\r\n\r\nasync function markUnsubscribed() {\r\n\tif (!userId.value) {\r\n\t\tstatus.value = 'error';\r\n\t\terrorKey.value = 'missingUser';\r\n\t\treturn;\r\n\t}\r\n\r\n\ttry {\r\n\t\tconst response = await fetch('/api/user/manageSub', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: JSON.stringify({ userId: userId.value, isSubscribe: false }),\r\n\t\t});\r\n\r\n\t\tif (!response.ok) {\r\n\t\t\tconst errorText = await response.text();\r\n\t\t\tthrow new Error(errorText || 'Request failed');\r\n\t\t}\r\n\t\tstatus.value = 'success';\r\n\t} catch (_error) {\r\n\t\tstatus.value = 'error';\r\n\t\terrorKey.value = 'updateFailed';\r\n\t}\r\n}\r\n\r\nasync function syncPreferredLocale() {\r\n\tif (!userId.value) return;\r\n\r\n\ttry {\r\n\t\tconst response = await fetch(\r\n\t\t\t`/api/user/preferences?userId=${encodeURIComponent(userId.value)}`\r\n\t\t);\r\n\t\tif (!response.ok) {\r\n\t\t\tconst errorText = await response.text();\r\n\t\t\tthrow new Error(errorText || 'Failed to load locale');\r\n\t\t}\r\n\t\tconst payload = (await response.json()) as {\r\n\t\t\tpreferredLocale?: string;\r\n\t\t};\r\n\t\tif (\r\n\t\t\tpayload.preferredLocale &&\r\n\t\t\ttypeof payload.preferredLocale === 'string'\r\n\t\t) {\r\n\t\t\tsetLocale(payload.preferredLocale, true);\r\n\t\t}\r\n\t} catch (error) {\r\n\t\tconsole.error('Unable to sync preferred locale', error);\r\n\t}\r\n}\r\n\r\nonMounted(() => {\r\n\tvoid syncPreferredLocale();\r\n\tvoid markUnsubscribed();\r\n});\r\n</script>\r\n\r\n<style scoped>\r\n.unsubscribe-page {\r\n\tmin-height: 100vh;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tbackground: #0f1115;\r\n\tcolor: #fff;\r\n\tpadding: 24px;\r\n}\r\n\r\n.card {\r\n\tmax-width: 420px;\r\n\twidth: 100%;\r\n\tbackground: #1f2937;\r\n\tborder-radius: 16px;\r\n\tpadding: 32px;\r\n\tbox-shadow: 0 20px 45px rgba(0, 0, 0, 0.45);\r\n\ttext-align: center;\r\n}\r\n\r\n.card h1 {\r\n\tmargin-bottom: 16px;\r\n\tfont-size: 1.5rem;\r\n}\r\n\r\n.links {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 12px;\r\n\tmargin-top: 24px;\r\n}\r\n\r\n.links a {\r\n\tcolor: #34d399;\r\n\ttext-decoration: none;\r\n\tfont-weight: 600;\r\n}\r\n\r\n.links a:hover {\r\n\ttext-decoration: underline;\r\n}\r\n\r\n.error {\r\n\tcolor: #f87171;\r\n}\r\n</style>\r\n"],"names":["appHref","route","useRoute","status","ref","t","setLocale","useI18n","errorKey","errorMessage","computed","userId","raw","resubscribeHref","id","markUnsubscribed","response","errorText","syncPreferredLocale","payload","error","onMounted","_openBlock","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_unref","_hoisted_5","_toDisplayString","_hoisted_6","_hoisted_7"],"mappings":"6PAsCMA,EAAU,iEARhB,MAAMC,EAAQC,EAAA,EACRC,EAASC,EAAqC,SAAS,EACvD,CAAE,EAAAC,EAAG,UAAAC,CAAA,EAAcC,EAAA,EACnBC,EAAWJ,EAAc,cAAc,EACvCK,EAAeC,EAAS,IACdL,EAAE,MAAM,kBAAkB,OAC1BG,EAAS,KAAK,GAAgB,EAC7C,EAGKG,EAASD,EAAS,IAAM,CAC7B,MAAME,EAAMX,EAAM,MAAM,OACxB,OAAI,MAAM,QAAQW,CAAG,EAAUA,EAAI,CAAC,GAAK,GAClC,OAAOA,GAAQ,SAAWA,EAAM,EACxC,CAAC,EAEKC,EAAkBH,EAAS,IAAM,CACtC,MAAMI,EAAKH,EAAO,MAClB,OAAKG,EACE,GAAGd,CAAO,uBAAuB,mBAAmBc,CAAE,CAAC,eAD9C,GAAGd,CAAO,cAE3B,CAAC,EAED,eAAee,GAAmB,CACjC,GAAI,CAACJ,EAAO,MAAO,CAClBR,EAAO,MAAQ,QACfK,EAAS,MAAQ,cACjB,MACD,CAEA,GAAI,CACH,MAAMQ,EAAW,MAAM,MAAM,sBAAuB,CACnD,OAAQ,OACR,QAAS,CACR,eAAgB,kBAAA,EAEjB,KAAM,KAAK,UAAU,CAAE,OAAQL,EAAO,MAAO,YAAa,EAAA,CAAO,CAAA,CACjE,EAED,GAAI,CAACK,EAAS,GAAI,CACjB,MAAMC,EAAY,MAAMD,EAAS,KAAA,EACjC,MAAM,IAAI,MAAMC,GAAa,gBAAgB,CAC9C,CACAd,EAAO,MAAQ,SAChB,MAAiB,CAChBA,EAAO,MAAQ,QACfK,EAAS,MAAQ,cAClB,CACD,CAEA,eAAeU,GAAsB,CACpC,GAAKP,EAAO,MAEZ,GAAI,CACH,MAAMK,EAAW,MAAM,MACtB,gCAAgC,mBAAmBL,EAAO,KAAK,CAAC,EAAA,EAEjE,GAAI,CAACK,EAAS,GAAI,CACjB,MAAMC,EAAY,MAAMD,EAAS,KAAA,EACjC,MAAM,IAAI,MAAMC,GAAa,uBAAuB,CACrD,CACA,MAAME,EAAW,MAAMH,EAAS,KAAA,EAI/BG,EAAQ,iBACR,OAAOA,EAAQ,iBAAoB,UAEnCb,EAAUa,EAAQ,gBAAiB,EAAI,CAEzC,OAASC,EAAO,CACf,QAAQ,MAAM,kCAAmCA,CAAK,CACvD,CACD,CAEA,OAAAC,EAAU,IAAM,CACVH,EAAA,EACAH,EAAA,CACN,CAAC,UA1GAO,EAAA,EAAAC,EAoBM,MApBNC,EAoBM,CAnBLC,EAkBM,MAlBNC,EAkBM,CAjBLD,EAAoD,YAA7CE,EAAAtB,CAAA,EAAE,kBAAkB,YAAY,KAAK,EAAA,CAAA,EACnCF,EAAA,QAAM,WAAfmB,EAAA,EAAAC,EAEI,QADAI,EAAAtB,CAAA,EAAE,kBAAkB,YAAY,OAAO,EAAA,CAAA,GAE7BF,EAAA,QAAM,WAApBmB,EAAA,EAAAC,EAEI,QADAI,EAAAtB,CAAA,EAAE,kBAAkB,YAAY,OAAO,EAAA,CAAA,QAE3CkB,EAEI,IAFJK,EAEIC,EADApB,EAAA,KAAY,EAAA,CAAA,GAGhBgB,EAKM,MALNK,EAKM,CAJLL,EAEI,IAAA,CAFA,KAAMZ,EAAA,OAAegB,EACrBF,EAAAtB,CAAA,EAAE,kBAAkB,YAAY,QAAQ,EAAA,EAAA0B,CAAA,EAE5CN,EAAkE,IAAA,CAA9D,KAAMzB,GAAO6B,EAAKF,EAAAtB,CAAA,EAAE,kBAAkB,OAAO,UAAU,EAAA,CAAA,CAAA"}