import{p as le,g as ce,j as D,m as c,y as ie,z as ue,c as i,a as t,l as F,t as n,k as u,s as b,A as U,F as j,r as z,T as N,B as re,G as de,o as l,q as V,H as ve,_ as pe}from"./Cy8nOPVn.js";import{u as ge}from"./lqf0okqB.js";import{u as _e,e as W}from"./Dx6LfG2l.js";import{s as me}from"./KdOoEFN1.js";const fe=le("/PopIt Logo small.png"),he={class:"container"},ye={class:"page-header"},Ie={class:"page-title-text"},ke={class:"language-dropdown"},be=["aria-label"],Se=["onClick"],we={class:"content"},Te={key:0},Ce={class:"score-section"},Le={class:"score-item"},Ee={class:"score-label"},Oe={class:"score-value-row"},xe={class:"score-value"},Ae={class:"score-item"},Re={class:"score-label"},Me={class:"score-value"},Pe={class:"images-section"},$e={key:0,class:"error-message"},Be={key:1,class:"loading"},De={key:2,class:"image-grid"},Fe=["onClick"],Ue=["src","alt"],je={class:"image-name"},ze={key:0,class:"selection-count"},Ne={class:"count-number"},Ve={class:"count-label"},We={class:"result-modal"},Ge={key:0,class:"modal-message winner"},Ke={key:1,class:"modal-message"},qe={class:"modal-countdown"},O="popit_total_score",x="popit_num_trials",He=ce({__name:"popit",setup(Ye){const{t:r,locale:A,setLocale:G}=_e(),{isAuthenticated:R,getAuthHeader:M}=ge(),K=Object.keys(W.languages),q=D(()=>K.map(e=>({value:e,label:r.value.languages?.[e]??W.languages[e]??e}))),g=c(!1),T=c(null),P=c({});function H(){g.value=!g.value,g.value&&T.value&&de(()=>{const e=T.value.getBoundingClientRect();P.value={position:"fixed",top:`${e.bottom+8}px`,right:`${window.innerWidth-e.right}px`,zIndex:999999}})}function Y(e){G(e,!0),g.value=!1}function $(e){e.target.closest(".language-dropdown")||(g.value=!1)}const S=c([]),w=c(!1),h=c(null),C=c(null),y=c({}),v=c(!1),_=c(0),L=c(!1),I=c(100);let m=null,f=null;const p=c(0),d=c(0),J=D(()=>d.value===0?0:p.value/d.value);async function Q(){if(typeof window>"u")return;const e=localStorage.getItem(O),a=localStorage.getItem(x);if(p.value=e?parseInt(e,10):0,d.value=a?parseInt(a,10):0,R.value)try{const s=M();if(s){const o=await $fetch("/api/user",{headers:s});p.value=o.popitScore??0,d.value=o.popitTrials??0,localStorage.setItem(O,p.value.toString()),localStorage.setItem(x,d.value.toString())}}catch(s){console.error("Failed to fetch user popit scores:",s)}}async function X(){if(!(typeof window>"u")&&(localStorage.setItem(O,p.value.toString()),localStorage.setItem(x,d.value.toString()),R.value))try{const e=M();e&&await $fetch("/api/popit-score",{method:"POST",headers:e,body:{popitScore:p.value,popitTrials:d.value}})}catch(e){console.error("Failed to save popit scores to server:",e)}}function Z(){let e=-1,a="";for(const[s,o]of Object.entries(y.value))o>e&&(e=o,a=s);return a}function ee(e){return e===Z()}function te(e){return Object.entries(y.value).map(([o,k])=>({id:o,count:k})).sort((o,k)=>k.count-o.count).findIndex(o=>o.id===e)+1}function se(e){const a=S.value.length;return Math.max(0,a-e+1)}function ae(){typeof window<"u"&&ve(()=>import("./C2jkTI5u.js"),[],import.meta.url).then(e=>{e.default({particleCount:200,spread:90,origin:{y:.7}})})}function E(){m&&(clearTimeout(m),m=null),f&&(clearInterval(f),f=null),L.value=!1,I.value=100,B()}function oe(){L.value=!0,I.value=100;const e=4e3,a=50,o=100/(e/a);f=me(()=>{I.value=Math.max(0,I.value-o)},a),m=setTimeout(()=>{E()},e)}async function ne(e){if(!(v.value||w.value)){C.value=e;try{await $fetch("/api/image-selection",{method:"POST",body:{publicId:e}});const a=S.value.map(k=>k.publicId).join(","),s=await $fetch(`/api/image-selection?publicIds=${encodeURIComponent(a)}`);y.value=s.counts,v.value=!0,_.value=te(e);const o=se(_.value);p.value+=o,d.value+=1,X(),_.value===1&&ae(),oe()}catch(a){h.value=a.message||"Failed to record selection",console.error("Error selecting image:",a)}}}async function B(){w.value=!0,h.value=null,v.value=!1,C.value=null,y.value={},_.value=0;try{const e=await $fetch("/api/cloudinary-images");S.value=e.images}catch(e){h.value=e.message||"Failed to load images",console.error("Error fetching images:",e)}finally{w.value=!1}}return ie(()=>{Q(),B(),document.addEventListener("click",$)}),ue(()=>{document.removeEventListener("click",$),m&&clearTimeout(m),f&&clearInterval(f)}),(e,a)=>(l(),i("div",he,[t("div",ye,[t("h1",null,[a[0]||(a[0]=t("img",{src:fe,alt:"PopIt",class:"page-logo"},null,-1)),t("span",Ie,n(u(r).popit.title),1)]),t("div",ke,[t("button",{class:"btn-lang",onClick:H,"aria-label":u(r).landing?.languageLabel||"Language",ref_key:"langButton",ref:T},n(u(A).toUpperCase()),9,be),(l(),F(N,{to:"body"},[g.value?(l(),i("div",{key:0,class:"language-menu",style:U(P.value)},[(l(!0),i(j,null,z(q.value,s=>(l(),i("button",{key:s.value,class:V(["language-option",{active:u(A)===s.value}]),onClick:o=>Y(s.value)},n(s.label),11,Se))),128))],4)):b("",!0)]))])]),t("div",we,[v.value?b("",!0):(l(),i("p",Te,n(u(r).popit.instructions),1)),t("div",Ce,[t("div",Le,[t("span",Ee,n(u(r).popit.averageScore)+":",1),t("div",Oe,[t("span",xe,n(Math.round(100*J.value)),1),a[1]||(a[1]=t("span",{class:"score-label-small"}," / 400",-1))])]),t("div",Ae,[t("span",Re,n(u(r).popit.trials)+":",1),t("span",Me,n(d.value),1)])]),t("div",Pe,[h.value?(l(),i("div",$e,n(h.value),1)):b("",!0),w.value?(l(),i("div",Be,n(u(r).popit.loadingImages),1)):(l(),i("div",De,[(l(!0),i(j,null,z(S.value,s=>(l(),i("div",{key:s.publicId,class:V(["image-card",{selected:C.value===s.publicId,revealed:v.value,winner:v.value&&ee(s.publicId),clickable:!v.value}]),onClick:o=>ne(s.publicId)},[t("img",{src:s.url,alt:s.publicId,loading:"lazy"},null,8,Ue),t("div",je,n(s.query),1),v.value?(l(),i("div",ze,[t("span",Ne,n(y.value[s.publicId]||0),1),t("span",Ve,n(u(r).popit.selections),1)])):b("",!0)],10,Fe))),128))]))])]),(l(),F(N,{to:"body"},[L.value?(l(),i("div",{key:0,class:"modal-overlay",onClick:re(E,["self"])},[t("div",We,[_.value===1?(l(),i("div",Ge," ðŸŽ‰ "+n(u(r).popit.youWon),1)):(l(),i("div",Ke,n(u(r).popit.youSelected)+" #"+n(_.value),1)),t("div",qe,[t("div",{class:"countdown-bar",style:U({width:I.value+"%"})},null,4)]),t("button",{class:"modal-ok-btn",onClick:E},"OK")])])):b("",!0)]))]))}}),et=pe(He,[["__scopeId","data-v-03c6f592"]]);export{et as default};
//# sourceMappingURL=BYR1HF93.js.map
