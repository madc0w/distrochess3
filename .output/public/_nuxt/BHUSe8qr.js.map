{"version":3,"mappings":"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AAI,GAAI,GAAI,EAC3D,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAChD,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAChD,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAEMC,GAAO,CACT,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAChD,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAChD,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,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","names":["_imports_1","publicAssetsURL","rootNode","comment","node","move","suffix","nag","variations","lineToTree","nodes","root","rest","parent","child","pgn","headers","game","next","peg$subclass","C","peg$SyntaxError","message","expected","found","location","self","peg$padEnd","str","targetLength","padString","sources","src","k","s","offset_s","loc","e","filler","line","last","hatLen","DESCRIBE_EXPECTATION_FNS","expectation","literalEscape","escapedParts","part","classEscape","hex","ch","describeExpectation","describeExpected","descriptions","i","j","describeFound","peg$parse","input","options","peg$FAILED","peg$source","peg$startRuleFunctions","peg$parsepgn","peg$startRuleFunction","peg$c0","peg$c1","peg$c2","peg$c3","peg$c4","peg$c5","peg$c6","peg$c7","peg$c8","peg$c9","peg$c10","peg$c11","peg$c12","peg$c13","peg$c14","peg$c15","peg$c16","peg$c17","peg$r0","peg$r1","peg$r2","peg$r3","peg$r4","peg$r5","peg$r6","peg$r7","peg$r8","peg$r9","peg$e0","peg$otherExpectation","peg$e1","peg$literalExpectation","peg$e2","peg$e3","peg$e4","peg$e5","peg$classExpectation","peg$e6","peg$e7","peg$e8","peg$e9","peg$e10","peg$e11","peg$e12","peg$e13","peg$e14","peg$e15","peg$e16","peg$e17","peg$e18","peg$e19","peg$e20","peg$e21","peg$e22","peg$e23","peg$e24","peg$e25","peg$e26","peg$e27","peg$e28","peg$e29","peg$e30","peg$e31","peg$e32","peg$e33","peg$e34","peg$e35","peg$e36","peg$e37","peg$e38","peg$e39","peg$f0","peg$f1","tagPairs","peg$f2","tagName","tagValue","peg$f3","marker","peg$f4","moves","peg$f5","san","peg$f6","peg$f7","peg$f8","peg$f9","peg$f10","result","peg$currPos","peg$posDetailsCache","peg$maxFailPos","peg$maxFailExpected","peg$silentFails","peg$result","text","ignoreCase","parts","inverted","peg$endExpectation","description","peg$computePosDetails","pos","details","p","peg$computeLocation","startPos","endPos","offset","startPosDetails","endPosDetails","res","peg$fail","peg$buildStructuredError","s0","s1","s2","peg$parsetagPairSection","peg$parsemoveTextSection","peg$parsetagPair","peg$parse_","s4","s6","s7","s8","s10","peg$parsetagName","peg$parsetagValue","s3","peg$parseline","peg$parsegameTerminationMarker","peg$parsecomment","peg$parsemove","s5","s9","peg$parsemoveNumber","peg$parsesan","peg$parsesuffixAnnotation","peg$parsenag","peg$parsevariation","peg$parsebraceComment","peg$parserestOfLineComment","MASK64","rotl","x","wrappingMul","y","xoroshiro128","state","rand","PIECE_KEYS","EP_KEYS","CASTLING_KEYS","SIDE_KEY","WHITE","BLACK","PAWN","KNIGHT","BISHOP","ROOK","QUEEN","KING","DEFAULT_POSITION","Move","chess","internal","color","piece","from","to","flags","captured","promotion","fromAlgebraic","algebraic","toAlgebraic","flag","BITS","FLAGS","EMPTY","SEVEN_TAG_ROSTER","SUPLEMENTAL_TAGS","HEADER_TEMPLATE","Ox88","PAWN_OFFSETS","PIECE_OFFSETS","ATTACKS","RAYS","PIECE_MASKS","SYMBOLS","PROMOTIONS","RANK_1","RANK_2","RANK_7","RANK_8","SIDES","ROOKS","SECOND_RANK","SAN_NULLMOVE","rank","square","file","isDigit","c","f","r","swapColor","validateFen","fen","tokens","moveNumber","halfMoves","rows","sumFields","previousWasNumber","kings","regex","char","getDisambiguator","ambiguities","sameRank","sameFile","len","ambigFrom","ambigTo","ambigPiece","addMove","inferPieceType","pieceType","strippedSan","Chess","skipValidation","preserveHeaders","adjustments","ok","error","position","forceEnpassantSquare","empty","castling","epSquare","bigPawnSquare","squares","isLegal","type","colorIndex","typeIndex","index","hash","sq","currentPieceOnSquare","whiteKingInPlace","blackKingInPlace","startSquare","currentSquare","attackers","canCapture","verbose","difference","blocked","attackedBy","pieces","bishops","numPieces","squareColor","sum","legal","forSquare","forPiece","us","them","firstSquare","lastSquare","singleSquare","castlingFrom","castlingTo","legalMoves","strict","moveObj","prettyMove","old","newline","maxWidth","headerExists","appendComment","moveString","delimiter","reversedHistory","prefix","strip","wrapComment","width","token","currentWidth","args","key","value","nonNullHeaders","newlineChar","parsedPgn","output","disambiguator","cleanMove","matches","overlyDisambiguated","symbol","depth","row","moveHistory","currentCount","currentComments","copyComment","rights","side","assertNonEmptyString","assertNumber","number","DB_VERSION_CURRENT","DB_VERSION_INITIAL","STORE_EMOJI","STORE_KEYVALUE","STORE_FAVORITES","FIELD_TOKENS","INDEX_TOKENS","FIELD_UNICODE","INDEX_COUNT","FIELD_GROUP","FIELD_ORDER","INDEX_GROUP_AND_ORDER","KEY_ETAG","KEY_URL","KEY_PREFERRED_SKINTONE","MODE_READONLY","MODE_READWRITE","INDEX_SKIN_UNICODE","FIELD_SKIN_UNICODE","DEFAULT_DATA_SOURCE","DEFAULT_LOCALE","uniqBy","arr","func","set","item","uniqEmoji","emojis","_","initialMigration","db","createObjectStore","name","keyPath","indexes","store","indexName","multiEntry","openIndexedDBRequests","databaseCache","onCloseListeners","handleOpenOrDeleteReq","resolve","reject","req","createDatabase","dbName","closeDatabase","openDatabase","dbPromise","storeName","readOnlyOrReadWrite","cb","txn","listeners","listener","deleteDatabase","addOnCloseListener","irregularEmoticons","extractTokens","word","MIN_SEARCH_TEXT_LENGTH","normalizeTokens","transformEmojiData","emojiData","annotation","emoticon","group","order","shortcodes","skins","tags","emoji","version","tone","callStore","method","getIDB","getAllIDB","commit","minBy","array","minItem","findCommonMembers","arrays","uniqByFunc","shortestArray","results","isEmpty","get","hasData","url","eTag","oldETag","oldUrl","doFullDatabaseScanForSingleResult","predicate","emojiStore","lastKey","processNextBatch","loadData","transformedData","metaStore","todo","checkFetched","onFetched","data","getEmojiByGroup","range","getEmojiBySearchQuery","query","intermediateResults","checkDone","onDone","a","b","getEmojiByShortcode","shortcode","getEmojiByUnicode","unicode","incrementFavoriteEmojiCount","getTopFavoriteEmoji","customEmojiIndex","limit","favoritesStore","cursor","addResult","unicodeOrName","custom","CODA_MARKER","trie","itemToTokens","map","currentMap","nextMap","valuesAtCoda","exact","queue","entriesSortedByKey","requiredKeys$1","assertCustomEmojis","customEmojis","isArray","firstItemIsFaulty","sortByName","all","searchTrie","searchByExactMatch","searchByPrefix","search","shortcodeToEmoji","nameToEmoji","customEmoji","isFirefoxContentScript","cleanEmoji","warnETag","requiredKeys","assertEmojiData","assertStatus","response","dataSource","getETag","getETagAndData","arrayBufferToBinaryString","buffer","binary","bytes","length","binaryStringToArrayBuffer","buf","jsonChecksum","object","inString","inBuffer","outBuffer","outBinString","doCheckForUpdates","eTagAndData","loadDataForFirstTime","checkForUpdates","err","Database","locale","checkReady","customs","natives","skinTone","allGroups","id","groups","NUM_SKIN_TONES","rIC","hasZwj","versionsAndTestEmoji","TIMEOUT_BEFORE_LOADING_MESSAGE","DEFAULT_SKIN_TONE_EMOJI","DEFAULT_NUM_COLUMNS","MOST_COMMONLY_USED_EMOJI","FONT_FAMILY","DEFAULT_CATEGORY_SORTING","getTextFeature","canvas","ctx","compareFeatures","feature1","feature2","feature1Str","feature2Str","testColorEmojiSupported","determineEmojiSupportLevel","entries","promise","detectEmojiSupportLevel","supportedZwjEmojis","VARIATION_SELECTOR","SKINTONE_MODIFIER","ZWJ","LIGHT_SKIN_TONE","LIGHT_SKIN_TONE_MODIFIER","applySkinTone","zwjIndex","halt","event","incrementOrDecrement","decrement","val","summarizeEmojisForUI","emojiSupportLevel","toSimpleSkinsMap","skin","category","rAF","resizeObserverSupported","resizeObserverAction","abortSignal","onUpdate","resizeObserver","calculateTextWidth","baselineEmojiWidth","checkZwjSupport","zwjEmojisToCheck","baselineEmoji","emojiToDomNode","allSupported","domNode","emojiWidth","supported","uniq","resetScrollTopIfPossible","element","getFromMap","cache","cached","toString","parseTemplate","htmlString","template","parseCache","domInstancesCache","unkeyedSymbol","hasReplaceChildren","replaceChildren","parentNode","newChildren","doChildrenNeedRerender","oldChild","oldChildrenCount","patchChildren","instanceBinding","targetNode","targetParentNode","needsRerender","patch","expressions","instanceBindings","currentExpression","expressionIndex","attributeName","attributeValuePre","attributeValuePost","expression","newValue","newNode","parse","withinTag","withinAttribute","elementIndexCounter","elementsToBindings","elementIndexes","skipTokenChars","elementIndex","bindings","attributePreMatch","attributePostMatch","binding","applyBindings","traverseAndSetupBindings","rootElement","topLevelBindings","treeWalker","parseHtml","dom","createFramework","domInstances","domInstanceCacheKey","html","domInstancesForTokens","callback","keyFunction","originalCacheKey","render","container","helpers","events","actions","refs","actionContext","firstRender","labelWithSkin","titleForEmoji","unicodeWithSkin","emojiList","searchMode","rootDom","emojiWithCategory","forElementWithAttribute","eventName","listenerName","ref","action","boundActions","qM","createState","destroyed","currentObserver","propsToObservers","dirtyObservers","queued","flush","observersToRun","observer","target","prop","observers","createEffect","runnable","oldObserver","arraysAreEqualByFunction","left","right","areEqualFunc","intersectionObserverCache","intersectionObserverAction","EMPTY_ARRAY","assign","createRoot","shadowRoot","props","abortController","focus","fireEvent","detail","compareEmojiArrays","compareCurrentEmojisWithCategories","aCategory","aEmojis","bCategory","bEmojis","updateCurrentEmojis","newEmojis","updateSearchMode","newSearchMode","updateCurrentEmojisWithCategories","newEmojisWithCategories","currentSkinTone","onClickSkinToneButton","onEmojiClick","onNavClick","onNavKeydown","onSearchKeydown","onSkinToneOptionsClick","onSkinToneOptionsFocusOut","onSkinToneOptionsKeydown","onSkinToneOptionsKeyup","onSearchInput","calculateEmojiGridStyle","updateOnIntersection","level","handleDatabaseLoading","showingLoadingMessage","timeoutHandle","updateCustomEmoji","updatePreferredSkinTone","updateDefaultFavoriteEmojis","database","favs","databaseCustomEmoji","updateFavorites","defaultFavoriteEmojis","numColumns","dbFavorites","favorites","summarizeEmojis","style","newNumColumns","newIsRtl","isIntersecting","updateEmojis","searchText","currentGroup","databaseLoaded","getEmojisBySearchQuery","currentGroupId","getEmojisByGroup","resetScrollTopInRaf","currentEmojis","emojiVersion","checkZwjSupportAndUpdate","isZwjSupported","filterEmojisByVersion","calculateCurrentEmojisWithCategories","categoriesToEmoji","rawSearchText","goToNextOrPrevious","previous","clickEmoji","closestTarget","groupId","doFocus","el","getDetailForClickEvent","emojiSummary","skinTonedUnicode","promiseForDetail","changeSkinTone","match","changeActiveSkinTone","nextSkinTone","relatedTarget","newState","enI18n","baseStyles","PROPS","EXTRA_STYLES","PickerElement","attrName","oldValue","up","definitions","__props","emit","__emit","selectedSquare","validMoves","draggedPiece","isViewingHistory","computed","isDrawOffered","pieceSymbols","watch","newFen","files","ranks","getPieceAt","getPieceColor","isLightSquare","handleSquareClick","currentTurn","m","makeMove","handleDragStart","handleDragOver","handleDrop","handleDragEnd","handleTouchStart","handleTouchMove","handleTouchEnd","_openBlock","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_Fragment","_renderList","_normalizeClass","$event","_toDisplayString","_hoisted_4","_hoisted_5","maxMoveTimeMins","minMovesToEnableDrawOffers","MOVE_ERROR_MODAL_DURATION_MS","router","useRouter","route","useRoute","t","useI18n","user","isAuthenticated","signout","getAuthHeader","useAuth","currentGame","isGameLoading","timeRemaining","pollIntervalId","timerIntervalId","prevScore","newScore","isShowWinModal","isShowDrawModal","errorMessage","manualSignoutRedirect","loadSequence","isChatOpen","chatMessages","chatInput","chatErrorMessage","isChatLoading","isChatSending","chatUnreadCount","lastSeenChatTimestamp","lastPersistedChatTimestamp","pendingLastSeenUpload","isPersistingLastSeen","chatBodyRef","isEmojiPickerOpen","pendingTimerReload","isMoveErrorModalVisible","moveErrorModalMessage","moveErrorModalTimerId","isShowingProfileMenu","profileButton","profileMenuPosition","freshUserData","isOfferDrawModalVisible","isPulsingDrawButtons","isDrawOfferedToUser","drawOfferUserId","requestedGameId","raw","userTeamSide","listIncludesUser","canUseTeamChat","displayUser","fetchFreshUserData","list","entry","toggleProfileMenu","nextTick","rect","menuWidth","menuHeight","padding","viewportWidth","viewportHeight","top","navigateToSettings","onMounted","handleClickOutside","onUnmounted","useEscapeKey","closeChatModal","triggerWin","_prevScore","_newScore","__vitePreload","mod","currentFen","historyIndex","g","totalPositions","displayFen","idx","isAtStart","isAtEnd","canOfferDraw","goBack","goForward","exitHistory","jumpToHistoryPosition","targetIndex","maxIndex","nextIndex","handleChatMoveJump","currentMovePlayerData","uid","playerColor","handleSignout","stopPolling","stopTimer","resetChatState","handlePass","currentGameId","loadGame","showOfferDrawModal","handleOfferDraw","authHeaders","friendly","translateServerError","handleAcceptDraw","handleDeclineDraw","isForce","params","startTimer","startPolling","loadRequestedGame","gameId","statusMessage","isCurrentGame","queueGameLoad","loadAccordingToQuery","targetGameId","redirectToSignin","handleBlockedMove","handleMove","moveData","isNotYourTurnError","showMoveErrorModal","setInterval","reloadOptions","formatTime","seconds","mins","secs","isTimestampLater","candidate","reference","toggleChatModal","openChatModal","fetchChatMessages","scrollChatToBottom","sendChatMessage","trimmed","getCurrentGameId","toggleEmojiPicker","handleEmojiSelect","emojiValue","queuePersistLastSeen","timestamp","persistPendingLastSeen","resolveChatUserName","userId","formatChatTimestamp","formatDate","clearMoveErrorModalTimer","hideMoveErrorModal","scheduleNextGameLoad","currentId","serverLastSeen","updateUnreadCountFromMessages","markChatAsRead","lastMessage","targetTimestamp","lastSeen","msg","oldState","isGameChanged","open","newVal","oldVal","_hoisted_3","_imports_0","_unref","_createVNode","_component_NuxtLink","_hoisted_6","_createBlock","_Teleport","_hoisted_8","_hoisted_9","_hoisted_10","_hoisted_11","_hoisted_12","_hoisted_13","_hoisted_14","_hoisted_15","_hoisted_16","_hoisted_17","_hoisted_18","_hoisted_19","_hoisted_20","_createTextVNode","_hoisted_22","_hoisted_23","_hoisted_24","_hoisted_26","_hoisted_27","ChessBoard","_hoisted_28","_hoisted_29","_hoisted_30","_hoisted_31","_hoisted_32","_hoisted_33","_hoisted_34","_hoisted_35","_hoisted_36","_hoisted_37","_hoisted_38","_hoisted_39","_hoisted_41","_hoisted_40","_hoisted_42","_hoisted_43","_hoisted_44","_hoisted_45","_hoisted_46","_hoisted_47","_hoisted_48","_hoisted_25","_hoisted_49","_hoisted_50","_hoisted_51","_hoisted_52","_hoisted_53","_hoisted_54","_hoisted_55","_hoisted_56","_hoisted_58","_hoisted_60","_hoisted_61","_hoisted_62","_hoisted_63","_hoisted_64","_hoisted_66","_hoisted_67","_hoisted_68","_hoisted_69","_hoisted_70","_hoisted_71","_hoisted_72","_hoisted_73","_hoisted_65","_hoisted_75","_hoisted_76","_hoisted_77"],"ignoreList":[1,2,3],"sources":["../../../virtual:public?%2Fsettings.svg","../../../node_modules/chess.js/dist/esm/chess.js","../../../node_modules/emoji-picker-element/database.js","../../../node_modules/emoji-picker-element/picker.js","../../../components/ChessBoard.vue","../../../constants/game.ts","../../../pages/game.vue"],"sourcesContent":["import { publicAssetsURL } from '#internal/nuxt/paths';export default publicAssetsURL(\"/settings.svg\")","// @generated by Peggy 4.2.0.\n//\n// https://peggyjs.org/\n\n\n\n  function rootNode(comment) {\n  \treturn comment !== null ? { comment, variations: [] } : { variations: []}\n  }\n\n  function node(move, suffix, nag, comment, variations) {\n  \tconst node = { move, variations };\n\n    if (suffix) {\n    \tnode.suffix = suffix;\n    }\n\n    if (nag) {\n    \tnode.nag = nag;\n    }\n\n    if (comment !== null) {\n    \tnode.comment = comment;\n    }\n\n    return node\n  }\n\n  function lineToTree(...nodes) {\n  \tconst [root, ...rest] = nodes;\n\n    let parent = root;\n\n    for (const child of rest) {\n    \tif (child !== null) {\n        \tparent.variations = [child, ...child.variations];\n            child.variations = [];\n            parent = child;\n        }\n    }\n\n  \treturn root\n  }\n\n  function pgn(headers, game) {\n  \tif (game.marker && game.marker.comment) {\n    \tlet node = game.root;\n        while (true) {\n        \tconst next = node.variations[0];\n            if (!next) {\n            \tnode.comment = game.marker.comment;\n            \tbreak\n            }\n            node = next;\n        }\n    }\n\n  \treturn {\n    \theaders,\n        root: game.root,\n        result: (game.marker && game.marker.result) ?? undefined\n    }\n  }\n\nfunction peg$subclass(child, parent) {\n  function C() { this.constructor = child; }\n  C.prototype = parent.prototype;\n  child.prototype = new C();\n}\n\nfunction peg$SyntaxError(message, expected, found, location) {\n  var self = Error.call(this, message);\n  // istanbul ignore next Check is a necessary evil to support older environments\n  if (Object.setPrototypeOf) {\n    Object.setPrototypeOf(self, peg$SyntaxError.prototype);\n  }\n  self.expected = expected;\n  self.found = found;\n  self.location = location;\n  self.name = \"SyntaxError\";\n  return self;\n}\n\npeg$subclass(peg$SyntaxError, Error);\n\nfunction peg$padEnd(str, targetLength, padString) {\n  padString = padString || \" \";\n  if (str.length > targetLength) { return str; }\n  targetLength -= str.length;\n  padString += padString.repeat(targetLength);\n  return str + padString.slice(0, targetLength);\n}\n\npeg$SyntaxError.prototype.format = function(sources) {\n  var str = \"Error: \" + this.message;\n  if (this.location) {\n    var src = null;\n    var k;\n    for (k = 0; k < sources.length; k++) {\n      if (sources[k].source === this.location.source) {\n        src = sources[k].text.split(/\\r\\n|\\n|\\r/g);\n        break;\n      }\n    }\n    var s = this.location.start;\n    var offset_s = (this.location.source && (typeof this.location.source.offset === \"function\"))\n      ? this.location.source.offset(s)\n      : s;\n    var loc = this.location.source + \":\" + offset_s.line + \":\" + offset_s.column;\n    if (src) {\n      var e = this.location.end;\n      var filler = peg$padEnd(\"\", offset_s.line.toString().length, ' ');\n      var line = src[s.line - 1];\n      var last = s.line === e.line ? e.column : line.length + 1;\n      var hatLen = (last - s.column) || 1;\n      str += \"\\n --> \" + loc + \"\\n\"\n          + filler + \" |\\n\"\n          + offset_s.line + \" | \" + line + \"\\n\"\n          + filler + \" | \" + peg$padEnd(\"\", s.column - 1, ' ')\n          + peg$padEnd(\"\", hatLen, \"^\");\n    } else {\n      str += \"\\n at \" + loc;\n    }\n  }\n  return str;\n};\n\npeg$SyntaxError.buildMessage = function(expected, found) {\n  var DESCRIBE_EXPECTATION_FNS = {\n    literal: function(expectation) {\n      return \"\\\"\" + literalEscape(expectation.text) + \"\\\"\";\n    },\n\n    class: function(expectation) {\n      var escapedParts = expectation.parts.map(function(part) {\n        return Array.isArray(part)\n          ? classEscape(part[0]) + \"-\" + classEscape(part[1])\n          : classEscape(part);\n      });\n\n      return \"[\" + (expectation.inverted ? \"^\" : \"\") + escapedParts.join(\"\") + \"]\";\n    },\n\n    any: function() {\n      return \"any character\";\n    },\n\n    end: function() {\n      return \"end of input\";\n    },\n\n    other: function(expectation) {\n      return expectation.description;\n    }\n  };\n\n  function hex(ch) {\n    return ch.charCodeAt(0).toString(16).toUpperCase();\n  }\n\n  function literalEscape(s) {\n    return s\n      .replace(/\\\\/g, \"\\\\\\\\\")\n      .replace(/\"/g,  \"\\\\\\\"\")\n      .replace(/\\0/g, \"\\\\0\")\n      .replace(/\\t/g, \"\\\\t\")\n      .replace(/\\n/g, \"\\\\n\")\n      .replace(/\\r/g, \"\\\\r\")\n      .replace(/[\\x00-\\x0F]/g,          function(ch) { return \"\\\\x0\" + hex(ch); })\n      .replace(/[\\x10-\\x1F\\x7F-\\x9F]/g, function(ch) { return \"\\\\x\"  + hex(ch); });\n  }\n\n  function classEscape(s) {\n    return s\n      .replace(/\\\\/g, \"\\\\\\\\\")\n      .replace(/\\]/g, \"\\\\]\")\n      .replace(/\\^/g, \"\\\\^\")\n      .replace(/-/g,  \"\\\\-\")\n      .replace(/\\0/g, \"\\\\0\")\n      .replace(/\\t/g, \"\\\\t\")\n      .replace(/\\n/g, \"\\\\n\")\n      .replace(/\\r/g, \"\\\\r\")\n      .replace(/[\\x00-\\x0F]/g,          function(ch) { return \"\\\\x0\" + hex(ch); })\n      .replace(/[\\x10-\\x1F\\x7F-\\x9F]/g, function(ch) { return \"\\\\x\"  + hex(ch); });\n  }\n\n  function describeExpectation(expectation) {\n    return DESCRIBE_EXPECTATION_FNS[expectation.type](expectation);\n  }\n\n  function describeExpected(expected) {\n    var descriptions = expected.map(describeExpectation);\n    var i, j;\n\n    descriptions.sort();\n\n    if (descriptions.length > 0) {\n      for (i = 1, j = 1; i < descriptions.length; i++) {\n        if (descriptions[i - 1] !== descriptions[i]) {\n          descriptions[j] = descriptions[i];\n          j++;\n        }\n      }\n      descriptions.length = j;\n    }\n\n    switch (descriptions.length) {\n      case 1:\n        return descriptions[0];\n\n      case 2:\n        return descriptions[0] + \" or \" + descriptions[1];\n\n      default:\n        return descriptions.slice(0, -1).join(\", \")\n          + \", or \"\n          + descriptions[descriptions.length - 1];\n    }\n  }\n\n  function describeFound(found) {\n    return found ? \"\\\"\" + literalEscape(found) + \"\\\"\" : \"end of input\";\n  }\n\n  return \"Expected \" + describeExpected(expected) + \" but \" + describeFound(found) + \" found.\";\n};\n\nfunction peg$parse(input, options) {\n  options = options !== undefined ? options : {};\n\n  var peg$FAILED = {};\n  var peg$source = options.grammarSource;\n\n  var peg$startRuleFunctions = { pgn: peg$parsepgn };\n  var peg$startRuleFunction = peg$parsepgn;\n\n  var peg$c0 = \"[\";\n  var peg$c1 = \"\\\"\";\n  var peg$c2 = \"]\";\n  var peg$c3 = \".\";\n  var peg$c4 = \"O-O-O\";\n  var peg$c5 = \"O-O\";\n  var peg$c6 = \"0-0-0\";\n  var peg$c7 = \"0-0\";\n  var peg$c8 = \"$\";\n  var peg$c9 = \"{\";\n  var peg$c10 = \"}\";\n  var peg$c11 = \";\";\n  var peg$c12 = \"(\";\n  var peg$c13 = \")\";\n  var peg$c14 = \"1-0\";\n  var peg$c15 = \"0-1\";\n  var peg$c16 = \"1/2-1/2\";\n  var peg$c17 = \"*\";\n\n  var peg$r0 = /^[a-zA-Z]/;\n  var peg$r1 = /^[^\"]/;\n  var peg$r2 = /^[0-9]/;\n  var peg$r3 = /^[.]/;\n  var peg$r4 = /^[a-zA-Z1-8\\-=]/;\n  var peg$r5 = /^[+#]/;\n  var peg$r6 = /^[!?]/;\n  var peg$r7 = /^[^}]/;\n  var peg$r8 = /^[^\\r\\n]/;\n  var peg$r9 = /^[ \\t\\r\\n]/;\n\n  var peg$e0 = peg$otherExpectation(\"tag pair\");\n  var peg$e1 = peg$literalExpectation(\"[\", false);\n  var peg$e2 = peg$literalExpectation(\"\\\"\", false);\n  var peg$e3 = peg$literalExpectation(\"]\", false);\n  var peg$e4 = peg$otherExpectation(\"tag name\");\n  var peg$e5 = peg$classExpectation([[\"a\", \"z\"], [\"A\", \"Z\"]], false, false);\n  var peg$e6 = peg$otherExpectation(\"tag value\");\n  var peg$e7 = peg$classExpectation([\"\\\"\"], true, false);\n  var peg$e8 = peg$otherExpectation(\"move number\");\n  var peg$e9 = peg$classExpectation([[\"0\", \"9\"]], false, false);\n  var peg$e10 = peg$literalExpectation(\".\", false);\n  var peg$e11 = peg$classExpectation([\".\"], false, false);\n  var peg$e12 = peg$otherExpectation(\"standard algebraic notation\");\n  var peg$e13 = peg$literalExpectation(\"O-O-O\", false);\n  var peg$e14 = peg$literalExpectation(\"O-O\", false);\n  var peg$e15 = peg$literalExpectation(\"0-0-0\", false);\n  var peg$e16 = peg$literalExpectation(\"0-0\", false);\n  var peg$e17 = peg$classExpectation([[\"a\", \"z\"], [\"A\", \"Z\"], [\"1\", \"8\"], \"-\", \"=\"], false, false);\n  var peg$e18 = peg$classExpectation([\"+\", \"#\"], false, false);\n  var peg$e19 = peg$otherExpectation(\"suffix annotation\");\n  var peg$e20 = peg$classExpectation([\"!\", \"?\"], false, false);\n  var peg$e21 = peg$otherExpectation(\"NAG\");\n  var peg$e22 = peg$literalExpectation(\"$\", false);\n  var peg$e23 = peg$otherExpectation(\"brace comment\");\n  var peg$e24 = peg$literalExpectation(\"{\", false);\n  var peg$e25 = peg$classExpectation([\"}\"], true, false);\n  var peg$e26 = peg$literalExpectation(\"}\", false);\n  var peg$e27 = peg$otherExpectation(\"rest of line comment\");\n  var peg$e28 = peg$literalExpectation(\";\", false);\n  var peg$e29 = peg$classExpectation([\"\\r\", \"\\n\"], true, false);\n  var peg$e30 = peg$otherExpectation(\"variation\");\n  var peg$e31 = peg$literalExpectation(\"(\", false);\n  var peg$e32 = peg$literalExpectation(\")\", false);\n  var peg$e33 = peg$otherExpectation(\"game termination marker\");\n  var peg$e34 = peg$literalExpectation(\"1-0\", false);\n  var peg$e35 = peg$literalExpectation(\"0-1\", false);\n  var peg$e36 = peg$literalExpectation(\"1/2-1/2\", false);\n  var peg$e37 = peg$literalExpectation(\"*\", false);\n  var peg$e38 = peg$otherExpectation(\"whitespace\");\n  var peg$e39 = peg$classExpectation([\" \", \"\\t\", \"\\r\", \"\\n\"], false, false);\n\n  var peg$f0 = function(headers, game) { return pgn(headers, game) };\n  var peg$f1 = function(tagPairs) { return Object.fromEntries(tagPairs) };\n  var peg$f2 = function(tagName, tagValue) { return [tagName, tagValue] };\n  var peg$f3 = function(root, marker) { return { root, marker} };\n  var peg$f4 = function(comment, moves) { return lineToTree(rootNode(comment), ...moves.flat()) };\n  var peg$f5 = function(san, suffix, nag, comment, variations) { return node(san, suffix, nag, comment, variations) };\n  var peg$f6 = function(nag) { return nag };\n  var peg$f7 = function(comment) { return comment.replace(/[\\r\\n]+/g, \" \") };\n  var peg$f8 = function(comment) { return comment.trim() };\n  var peg$f9 = function(line) { return line };\n  var peg$f10 = function(result, comment) { return { result, comment } };\n  var peg$currPos = options.peg$currPos | 0;\n  var peg$posDetailsCache = [{ line: 1, column: 1 }];\n  var peg$maxFailPos = peg$currPos;\n  var peg$maxFailExpected = options.peg$maxFailExpected || [];\n  var peg$silentFails = options.peg$silentFails | 0;\n\n  var peg$result;\n\n  if (options.startRule) {\n    if (!(options.startRule in peg$startRuleFunctions)) {\n      throw new Error(\"Can't start parsing from rule \\\"\" + options.startRule + \"\\\".\");\n    }\n\n    peg$startRuleFunction = peg$startRuleFunctions[options.startRule];\n  }\n\n  function peg$literalExpectation(text, ignoreCase) {\n    return { type: \"literal\", text: text, ignoreCase: ignoreCase };\n  }\n\n  function peg$classExpectation(parts, inverted, ignoreCase) {\n    return { type: \"class\", parts: parts, inverted: inverted, ignoreCase: ignoreCase };\n  }\n\n  function peg$endExpectation() {\n    return { type: \"end\" };\n  }\n\n  function peg$otherExpectation(description) {\n    return { type: \"other\", description: description };\n  }\n\n  function peg$computePosDetails(pos) {\n    var details = peg$posDetailsCache[pos];\n    var p;\n\n    if (details) {\n      return details;\n    } else {\n      if (pos >= peg$posDetailsCache.length) {\n        p = peg$posDetailsCache.length - 1;\n      } else {\n        p = pos;\n        while (!peg$posDetailsCache[--p]) {}\n      }\n\n      details = peg$posDetailsCache[p];\n      details = {\n        line: details.line,\n        column: details.column\n      };\n\n      while (p < pos) {\n        if (input.charCodeAt(p) === 10) {\n          details.line++;\n          details.column = 1;\n        } else {\n          details.column++;\n        }\n\n        p++;\n      }\n\n      peg$posDetailsCache[pos] = details;\n\n      return details;\n    }\n  }\n\n  function peg$computeLocation(startPos, endPos, offset) {\n    var startPosDetails = peg$computePosDetails(startPos);\n    var endPosDetails = peg$computePosDetails(endPos);\n\n    var res = {\n      source: peg$source,\n      start: {\n        offset: startPos,\n        line: startPosDetails.line,\n        column: startPosDetails.column\n      },\n      end: {\n        offset: endPos,\n        line: endPosDetails.line,\n        column: endPosDetails.column\n      }\n    };\n    return res;\n  }\n\n  function peg$fail(expected) {\n    if (peg$currPos < peg$maxFailPos) { return; }\n\n    if (peg$currPos > peg$maxFailPos) {\n      peg$maxFailPos = peg$currPos;\n      peg$maxFailExpected = [];\n    }\n\n    peg$maxFailExpected.push(expected);\n  }\n\n  function peg$buildStructuredError(expected, found, location) {\n    return new peg$SyntaxError(\n      peg$SyntaxError.buildMessage(expected, found),\n      expected,\n      found,\n      location\n    );\n  }\n\n  function peg$parsepgn() {\n    var s0, s1, s2;\n\n    s0 = peg$currPos;\n    s1 = peg$parsetagPairSection();\n    s2 = peg$parsemoveTextSection();\n    s0 = peg$f0(s1, s2);\n\n    return s0;\n  }\n\n  function peg$parsetagPairSection() {\n    var s0, s1, s2;\n\n    s0 = peg$currPos;\n    s1 = [];\n    s2 = peg$parsetagPair();\n    while (s2 !== peg$FAILED) {\n      s1.push(s2);\n      s2 = peg$parsetagPair();\n    }\n    s2 = peg$parse_();\n    s0 = peg$f1(s1);\n\n    return s0;\n  }\n\n  function peg$parsetagPair() {\n    var s0, s2, s4, s6, s7, s8, s10;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    peg$parse_();\n    if (input.charCodeAt(peg$currPos) === 91) {\n      s2 = peg$c0;\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e1); }\n    }\n    if (s2 !== peg$FAILED) {\n      peg$parse_();\n      s4 = peg$parsetagName();\n      if (s4 !== peg$FAILED) {\n        peg$parse_();\n        if (input.charCodeAt(peg$currPos) === 34) {\n          s6 = peg$c1;\n          peg$currPos++;\n        } else {\n          s6 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e2); }\n        }\n        if (s6 !== peg$FAILED) {\n          s7 = peg$parsetagValue();\n          if (input.charCodeAt(peg$currPos) === 34) {\n            s8 = peg$c1;\n            peg$currPos++;\n          } else {\n            s8 = peg$FAILED;\n            if (peg$silentFails === 0) { peg$fail(peg$e2); }\n          }\n          if (s8 !== peg$FAILED) {\n            peg$parse_();\n            if (input.charCodeAt(peg$currPos) === 93) {\n              s10 = peg$c2;\n              peg$currPos++;\n            } else {\n              s10 = peg$FAILED;\n              if (peg$silentFails === 0) { peg$fail(peg$e3); }\n            }\n            if (s10 !== peg$FAILED) {\n              s0 = peg$f2(s4, s7);\n            } else {\n              peg$currPos = s0;\n              s0 = peg$FAILED;\n            }\n          } else {\n            peg$currPos = s0;\n            s0 = peg$FAILED;\n          }\n        } else {\n          peg$currPos = s0;\n          s0 = peg$FAILED;\n        }\n      } else {\n        peg$currPos = s0;\n        s0 = peg$FAILED;\n      }\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      if (peg$silentFails === 0) { peg$fail(peg$e0); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsetagName() {\n    var s0, s1, s2;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    s1 = [];\n    s2 = input.charAt(peg$currPos);\n    if (peg$r0.test(s2)) {\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e5); }\n    }\n    if (s2 !== peg$FAILED) {\n      while (s2 !== peg$FAILED) {\n        s1.push(s2);\n        s2 = input.charAt(peg$currPos);\n        if (peg$r0.test(s2)) {\n          peg$currPos++;\n        } else {\n          s2 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e5); }\n        }\n      }\n    } else {\n      s1 = peg$FAILED;\n    }\n    if (s1 !== peg$FAILED) {\n      s0 = input.substring(s0, peg$currPos);\n    } else {\n      s0 = s1;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e4); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsetagValue() {\n    var s0, s1, s2;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    s1 = [];\n    s2 = input.charAt(peg$currPos);\n    if (peg$r1.test(s2)) {\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e7); }\n    }\n    while (s2 !== peg$FAILED) {\n      s1.push(s2);\n      s2 = input.charAt(peg$currPos);\n      if (peg$r1.test(s2)) {\n        peg$currPos++;\n      } else {\n        s2 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e7); }\n      }\n    }\n    s0 = input.substring(s0, peg$currPos);\n    peg$silentFails--;\n    s1 = peg$FAILED;\n    if (peg$silentFails === 0) { peg$fail(peg$e6); }\n\n    return s0;\n  }\n\n  function peg$parsemoveTextSection() {\n    var s0, s1, s3;\n\n    s0 = peg$currPos;\n    s1 = peg$parseline();\n    peg$parse_();\n    s3 = peg$parsegameTerminationMarker();\n    if (s3 === peg$FAILED) {\n      s3 = null;\n    }\n    peg$parse_();\n    s0 = peg$f3(s1, s3);\n\n    return s0;\n  }\n\n  function peg$parseline() {\n    var s0, s1, s2, s3;\n\n    s0 = peg$currPos;\n    s1 = peg$parsecomment();\n    if (s1 === peg$FAILED) {\n      s1 = null;\n    }\n    s2 = [];\n    s3 = peg$parsemove();\n    while (s3 !== peg$FAILED) {\n      s2.push(s3);\n      s3 = peg$parsemove();\n    }\n    s0 = peg$f4(s1, s2);\n\n    return s0;\n  }\n\n  function peg$parsemove() {\n    var s0, s4, s5, s6, s7, s8, s9, s10;\n\n    s0 = peg$currPos;\n    peg$parse_();\n    peg$parsemoveNumber();\n    peg$parse_();\n    s4 = peg$parsesan();\n    if (s4 !== peg$FAILED) {\n      s5 = peg$parsesuffixAnnotation();\n      if (s5 === peg$FAILED) {\n        s5 = null;\n      }\n      s6 = [];\n      s7 = peg$parsenag();\n      while (s7 !== peg$FAILED) {\n        s6.push(s7);\n        s7 = peg$parsenag();\n      }\n      s7 = peg$parse_();\n      s8 = peg$parsecomment();\n      if (s8 === peg$FAILED) {\n        s8 = null;\n      }\n      s9 = [];\n      s10 = peg$parsevariation();\n      while (s10 !== peg$FAILED) {\n        s9.push(s10);\n        s10 = peg$parsevariation();\n      }\n      s0 = peg$f5(s4, s5, s6, s8, s9);\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n\n    return s0;\n  }\n\n  function peg$parsemoveNumber() {\n    var s0, s1, s2, s3, s4, s5;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    s1 = [];\n    s2 = input.charAt(peg$currPos);\n    if (peg$r2.test(s2)) {\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e9); }\n    }\n    while (s2 !== peg$FAILED) {\n      s1.push(s2);\n      s2 = input.charAt(peg$currPos);\n      if (peg$r2.test(s2)) {\n        peg$currPos++;\n      } else {\n        s2 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e9); }\n      }\n    }\n    if (input.charCodeAt(peg$currPos) === 46) {\n      s2 = peg$c3;\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e10); }\n    }\n    if (s2 !== peg$FAILED) {\n      s3 = peg$parse_();\n      s4 = [];\n      s5 = input.charAt(peg$currPos);\n      if (peg$r3.test(s5)) {\n        peg$currPos++;\n      } else {\n        s5 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e11); }\n      }\n      while (s5 !== peg$FAILED) {\n        s4.push(s5);\n        s5 = input.charAt(peg$currPos);\n        if (peg$r3.test(s5)) {\n          peg$currPos++;\n        } else {\n          s5 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e11); }\n        }\n      }\n      s1 = [s1, s2, s3, s4];\n      s0 = s1;\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e8); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsesan() {\n    var s0, s1, s2, s3, s4, s5;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    s1 = peg$currPos;\n    if (input.substr(peg$currPos, 5) === peg$c4) {\n      s2 = peg$c4;\n      peg$currPos += 5;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e13); }\n    }\n    if (s2 === peg$FAILED) {\n      if (input.substr(peg$currPos, 3) === peg$c5) {\n        s2 = peg$c5;\n        peg$currPos += 3;\n      } else {\n        s2 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e14); }\n      }\n      if (s2 === peg$FAILED) {\n        if (input.substr(peg$currPos, 5) === peg$c6) {\n          s2 = peg$c6;\n          peg$currPos += 5;\n        } else {\n          s2 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e15); }\n        }\n        if (s2 === peg$FAILED) {\n          if (input.substr(peg$currPos, 3) === peg$c7) {\n            s2 = peg$c7;\n            peg$currPos += 3;\n          } else {\n            s2 = peg$FAILED;\n            if (peg$silentFails === 0) { peg$fail(peg$e16); }\n          }\n          if (s2 === peg$FAILED) {\n            s2 = peg$currPos;\n            s3 = input.charAt(peg$currPos);\n            if (peg$r0.test(s3)) {\n              peg$currPos++;\n            } else {\n              s3 = peg$FAILED;\n              if (peg$silentFails === 0) { peg$fail(peg$e5); }\n            }\n            if (s3 !== peg$FAILED) {\n              s4 = [];\n              s5 = input.charAt(peg$currPos);\n              if (peg$r4.test(s5)) {\n                peg$currPos++;\n              } else {\n                s5 = peg$FAILED;\n                if (peg$silentFails === 0) { peg$fail(peg$e17); }\n              }\n              if (s5 !== peg$FAILED) {\n                while (s5 !== peg$FAILED) {\n                  s4.push(s5);\n                  s5 = input.charAt(peg$currPos);\n                  if (peg$r4.test(s5)) {\n                    peg$currPos++;\n                  } else {\n                    s5 = peg$FAILED;\n                    if (peg$silentFails === 0) { peg$fail(peg$e17); }\n                  }\n                }\n              } else {\n                s4 = peg$FAILED;\n              }\n              if (s4 !== peg$FAILED) {\n                s3 = [s3, s4];\n                s2 = s3;\n              } else {\n                peg$currPos = s2;\n                s2 = peg$FAILED;\n              }\n            } else {\n              peg$currPos = s2;\n              s2 = peg$FAILED;\n            }\n          }\n        }\n      }\n    }\n    if (s2 !== peg$FAILED) {\n      s3 = input.charAt(peg$currPos);\n      if (peg$r5.test(s3)) {\n        peg$currPos++;\n      } else {\n        s3 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e18); }\n      }\n      if (s3 === peg$FAILED) {\n        s3 = null;\n      }\n      s2 = [s2, s3];\n      s1 = s2;\n    } else {\n      peg$currPos = s1;\n      s1 = peg$FAILED;\n    }\n    if (s1 !== peg$FAILED) {\n      s0 = input.substring(s0, peg$currPos);\n    } else {\n      s0 = s1;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e12); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsesuffixAnnotation() {\n    var s0, s1, s2;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    s1 = [];\n    s2 = input.charAt(peg$currPos);\n    if (peg$r6.test(s2)) {\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e20); }\n    }\n    while (s2 !== peg$FAILED) {\n      s1.push(s2);\n      if (s1.length >= 2) {\n        s2 = peg$FAILED;\n      } else {\n        s2 = input.charAt(peg$currPos);\n        if (peg$r6.test(s2)) {\n          peg$currPos++;\n        } else {\n          s2 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e20); }\n        }\n      }\n    }\n    if (s1.length < 1) {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    } else {\n      s0 = s1;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e19); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsenag() {\n    var s0, s2, s3, s4, s5;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    peg$parse_();\n    if (input.charCodeAt(peg$currPos) === 36) {\n      s2 = peg$c8;\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e22); }\n    }\n    if (s2 !== peg$FAILED) {\n      s3 = peg$currPos;\n      s4 = [];\n      s5 = input.charAt(peg$currPos);\n      if (peg$r2.test(s5)) {\n        peg$currPos++;\n      } else {\n        s5 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e9); }\n      }\n      if (s5 !== peg$FAILED) {\n        while (s5 !== peg$FAILED) {\n          s4.push(s5);\n          s5 = input.charAt(peg$currPos);\n          if (peg$r2.test(s5)) {\n            peg$currPos++;\n          } else {\n            s5 = peg$FAILED;\n            if (peg$silentFails === 0) { peg$fail(peg$e9); }\n          }\n        }\n      } else {\n        s4 = peg$FAILED;\n      }\n      if (s4 !== peg$FAILED) {\n        s3 = input.substring(s3, peg$currPos);\n      } else {\n        s3 = s4;\n      }\n      if (s3 !== peg$FAILED) {\n        s0 = peg$f6(s3);\n      } else {\n        peg$currPos = s0;\n        s0 = peg$FAILED;\n      }\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      if (peg$silentFails === 0) { peg$fail(peg$e21); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsecomment() {\n    var s0;\n\n    s0 = peg$parsebraceComment();\n    if (s0 === peg$FAILED) {\n      s0 = peg$parserestOfLineComment();\n    }\n\n    return s0;\n  }\n\n  function peg$parsebraceComment() {\n    var s0, s1, s2, s3, s4;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    if (input.charCodeAt(peg$currPos) === 123) {\n      s1 = peg$c9;\n      peg$currPos++;\n    } else {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e24); }\n    }\n    if (s1 !== peg$FAILED) {\n      s2 = peg$currPos;\n      s3 = [];\n      s4 = input.charAt(peg$currPos);\n      if (peg$r7.test(s4)) {\n        peg$currPos++;\n      } else {\n        s4 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e25); }\n      }\n      while (s4 !== peg$FAILED) {\n        s3.push(s4);\n        s4 = input.charAt(peg$currPos);\n        if (peg$r7.test(s4)) {\n          peg$currPos++;\n        } else {\n          s4 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e25); }\n        }\n      }\n      s2 = input.substring(s2, peg$currPos);\n      if (input.charCodeAt(peg$currPos) === 125) {\n        s3 = peg$c10;\n        peg$currPos++;\n      } else {\n        s3 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e26); }\n      }\n      if (s3 !== peg$FAILED) {\n        s0 = peg$f7(s2);\n      } else {\n        peg$currPos = s0;\n        s0 = peg$FAILED;\n      }\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e23); }\n    }\n\n    return s0;\n  }\n\n  function peg$parserestOfLineComment() {\n    var s0, s1, s2, s3, s4;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    if (input.charCodeAt(peg$currPos) === 59) {\n      s1 = peg$c11;\n      peg$currPos++;\n    } else {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e28); }\n    }\n    if (s1 !== peg$FAILED) {\n      s2 = peg$currPos;\n      s3 = [];\n      s4 = input.charAt(peg$currPos);\n      if (peg$r8.test(s4)) {\n        peg$currPos++;\n      } else {\n        s4 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e29); }\n      }\n      while (s4 !== peg$FAILED) {\n        s3.push(s4);\n        s4 = input.charAt(peg$currPos);\n        if (peg$r8.test(s4)) {\n          peg$currPos++;\n        } else {\n          s4 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e29); }\n        }\n      }\n      s2 = input.substring(s2, peg$currPos);\n      s0 = peg$f8(s2);\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e27); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsevariation() {\n    var s0, s2, s3, s5;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    peg$parse_();\n    if (input.charCodeAt(peg$currPos) === 40) {\n      s2 = peg$c12;\n      peg$currPos++;\n    } else {\n      s2 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e31); }\n    }\n    if (s2 !== peg$FAILED) {\n      s3 = peg$parseline();\n      if (s3 !== peg$FAILED) {\n        peg$parse_();\n        if (input.charCodeAt(peg$currPos) === 41) {\n          s5 = peg$c13;\n          peg$currPos++;\n        } else {\n          s5 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e32); }\n        }\n        if (s5 !== peg$FAILED) {\n          s0 = peg$f9(s3);\n        } else {\n          peg$currPos = s0;\n          s0 = peg$FAILED;\n        }\n      } else {\n        peg$currPos = s0;\n        s0 = peg$FAILED;\n      }\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      if (peg$silentFails === 0) { peg$fail(peg$e30); }\n    }\n\n    return s0;\n  }\n\n  function peg$parsegameTerminationMarker() {\n    var s0, s1, s3;\n\n    peg$silentFails++;\n    s0 = peg$currPos;\n    if (input.substr(peg$currPos, 3) === peg$c14) {\n      s1 = peg$c14;\n      peg$currPos += 3;\n    } else {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e34); }\n    }\n    if (s1 === peg$FAILED) {\n      if (input.substr(peg$currPos, 3) === peg$c15) {\n        s1 = peg$c15;\n        peg$currPos += 3;\n      } else {\n        s1 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e35); }\n      }\n      if (s1 === peg$FAILED) {\n        if (input.substr(peg$currPos, 7) === peg$c16) {\n          s1 = peg$c16;\n          peg$currPos += 7;\n        } else {\n          s1 = peg$FAILED;\n          if (peg$silentFails === 0) { peg$fail(peg$e36); }\n        }\n        if (s1 === peg$FAILED) {\n          if (input.charCodeAt(peg$currPos) === 42) {\n            s1 = peg$c17;\n            peg$currPos++;\n          } else {\n            s1 = peg$FAILED;\n            if (peg$silentFails === 0) { peg$fail(peg$e37); }\n          }\n        }\n      }\n    }\n    if (s1 !== peg$FAILED) {\n      peg$parse_();\n      s3 = peg$parsecomment();\n      if (s3 === peg$FAILED) {\n        s3 = null;\n      }\n      s0 = peg$f10(s1, s3);\n    } else {\n      peg$currPos = s0;\n      s0 = peg$FAILED;\n    }\n    peg$silentFails--;\n    if (s0 === peg$FAILED) {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e33); }\n    }\n\n    return s0;\n  }\n\n  function peg$parse_() {\n    var s0, s1;\n\n    peg$silentFails++;\n    s0 = [];\n    s1 = input.charAt(peg$currPos);\n    if (peg$r9.test(s1)) {\n      peg$currPos++;\n    } else {\n      s1 = peg$FAILED;\n      if (peg$silentFails === 0) { peg$fail(peg$e39); }\n    }\n    while (s1 !== peg$FAILED) {\n      s0.push(s1);\n      s1 = input.charAt(peg$currPos);\n      if (peg$r9.test(s1)) {\n        peg$currPos++;\n      } else {\n        s1 = peg$FAILED;\n        if (peg$silentFails === 0) { peg$fail(peg$e39); }\n      }\n    }\n    peg$silentFails--;\n    s1 = peg$FAILED;\n    if (peg$silentFails === 0) { peg$fail(peg$e38); }\n\n    return s0;\n  }\n\n  peg$result = peg$startRuleFunction();\n\n  if (options.peg$library) {\n    return /** @type {any} */ ({\n      peg$result,\n      peg$currPos,\n      peg$FAILED,\n      peg$maxFailExpected,\n      peg$maxFailPos\n    });\n  }\n  if (peg$result !== peg$FAILED && peg$currPos === input.length) {\n    return peg$result;\n  } else {\n    if (peg$result !== peg$FAILED && peg$currPos < input.length) {\n      peg$fail(peg$endExpectation());\n    }\n\n    throw peg$buildStructuredError(\n      peg$maxFailExpected,\n      peg$maxFailPos < input.length ? input.charAt(peg$maxFailPos) : null,\n      peg$maxFailPos < input.length\n        ? peg$computeLocation(peg$maxFailPos, peg$maxFailPos + 1)\n        : peg$computeLocation(peg$maxFailPos, peg$maxFailPos)\n    );\n  }\n}\n\n/**\n * @license\n * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n * 2. Redistributions in binary form must reproduce the above copyright notice,\n *    this list of conditions and the following disclaimer in the documentation\n *    and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE\n * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\n * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\nconst MASK64 = 0xffffffffffffffffn;\nfunction rotl(x, k) {\n    return ((x << k) | (x >> (64n - k))) & 0xffffffffffffffffn;\n}\nfunction wrappingMul(x, y) {\n    return (x * y) & MASK64;\n}\n// xoroshiro128**\nfunction xoroshiro128(state) {\n    return function () {\n        let s0 = BigInt(state & MASK64);\n        let s1 = BigInt((state >> 64n) & MASK64);\n        const result = wrappingMul(rotl(wrappingMul(s0, 5n), 7n), 9n);\n        s1 ^= s0;\n        s0 = (rotl(s0, 24n) ^ s1 ^ (s1 << 16n)) & MASK64;\n        s1 = rotl(s1, 37n);\n        state = (s1 << 64n) | s0;\n        return result;\n    };\n}\nconst rand = xoroshiro128(0xa187eb39cdcaed8f31c4b365b102e01en);\nconst PIECE_KEYS = Array.from({ length: 2 }, () => Array.from({ length: 6 }, () => Array.from({ length: 128 }, () => rand())));\nconst EP_KEYS = Array.from({ length: 8 }, () => rand());\nconst CASTLING_KEYS = Array.from({ length: 16 }, () => rand());\nconst SIDE_KEY = rand();\nconst WHITE = 'w';\nconst BLACK = 'b';\nconst PAWN = 'p';\nconst KNIGHT = 'n';\nconst BISHOP = 'b';\nconst ROOK = 'r';\nconst QUEEN = 'q';\nconst KING = 'k';\nconst DEFAULT_POSITION = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\nclass Move {\n    color;\n    from;\n    to;\n    piece;\n    captured;\n    promotion;\n    /**\n     * @deprecated This field is deprecated and will be removed in version 2.0.0.\n     * Please use move descriptor functions instead: `isCapture`, `isPromotion`,\n     * `isEnPassant`, `isKingsideCastle`, `isQueensideCastle`, `isCastle`, and\n     * `isBigPawn`\n     */\n    flags;\n    san;\n    lan;\n    before;\n    after;\n    constructor(chess, internal) {\n        const { color, piece, from, to, flags, captured, promotion } = internal;\n        const fromAlgebraic = algebraic(from);\n        const toAlgebraic = algebraic(to);\n        this.color = color;\n        this.piece = piece;\n        this.from = fromAlgebraic;\n        this.to = toAlgebraic;\n        /*\n         * HACK: The chess['_method']() calls below invoke private methods in the\n         * Chess class to generate SAN and FEN. It's a bit of a hack, but makes the\n         * code cleaner elsewhere.\n         */\n        this.san = chess['_moveToSan'](internal, chess['_moves']({ legal: true }));\n        this.lan = fromAlgebraic + toAlgebraic;\n        this.before = chess.fen();\n        // Generate the FEN for the 'after' key\n        chess['_makeMove'](internal);\n        this.after = chess.fen();\n        chess['_undoMove']();\n        // Build the text representation of the move flags\n        this.flags = '';\n        for (const flag in BITS) {\n            if (BITS[flag] & flags) {\n                this.flags += FLAGS[flag];\n            }\n        }\n        if (captured) {\n            this.captured = captured;\n        }\n        if (promotion) {\n            this.promotion = promotion;\n            this.lan += promotion;\n        }\n    }\n    isCapture() {\n        return this.flags.indexOf(FLAGS['CAPTURE']) > -1;\n    }\n    isPromotion() {\n        return this.flags.indexOf(FLAGS['PROMOTION']) > -1;\n    }\n    isEnPassant() {\n        return this.flags.indexOf(FLAGS['EP_CAPTURE']) > -1;\n    }\n    isKingsideCastle() {\n        return this.flags.indexOf(FLAGS['KSIDE_CASTLE']) > -1;\n    }\n    isQueensideCastle() {\n        return this.flags.indexOf(FLAGS['QSIDE_CASTLE']) > -1;\n    }\n    isBigPawn() {\n        return this.flags.indexOf(FLAGS['BIG_PAWN']) > -1;\n    }\n}\nconst EMPTY = -1;\nconst FLAGS = {\n    NORMAL: 'n',\n    CAPTURE: 'c',\n    BIG_PAWN: 'b',\n    EP_CAPTURE: 'e',\n    PROMOTION: 'p',\n    KSIDE_CASTLE: 'k',\n    QSIDE_CASTLE: 'q',\n    NULL_MOVE: '-',\n};\n// prettier-ignore\nconst SQUARES = [\n    'a8', 'b8', 'c8', 'd8', 'e8', 'f8', 'g8', 'h8',\n    'a7', 'b7', 'c7', 'd7', 'e7', 'f7', 'g7', 'h7',\n    'a6', 'b6', 'c6', 'd6', 'e6', 'f6', 'g6', 'h6',\n    'a5', 'b5', 'c5', 'd5', 'e5', 'f5', 'g5', 'h5',\n    'a4', 'b4', 'c4', 'd4', 'e4', 'f4', 'g4', 'h4',\n    'a3', 'b3', 'c3', 'd3', 'e3', 'f3', 'g3', 'h3',\n    'a2', 'b2', 'c2', 'd2', 'e2', 'f2', 'g2', 'h2',\n    'a1', 'b1', 'c1', 'd1', 'e1', 'f1', 'g1', 'h1'\n];\nconst BITS = {\n    NORMAL: 1,\n    CAPTURE: 2,\n    BIG_PAWN: 4,\n    EP_CAPTURE: 8,\n    PROMOTION: 16,\n    KSIDE_CASTLE: 32,\n    QSIDE_CASTLE: 64,\n    NULL_MOVE: 128,\n};\n/* eslint-disable @typescript-eslint/naming-convention */\n// these are required, according to spec\nconst SEVEN_TAG_ROSTER = {\n    Event: '?',\n    Site: '?',\n    Date: '????.??.??',\n    Round: '?',\n    White: '?',\n    Black: '?',\n    Result: '*',\n};\n/**\n * These nulls are placeholders to fix the order of tags (as they appear in PGN spec); null values will be\n * eliminated in getHeaders()\n */\nconst SUPLEMENTAL_TAGS = {\n    WhiteTitle: null,\n    BlackTitle: null,\n    WhiteElo: null,\n    BlackElo: null,\n    WhiteUSCF: null,\n    BlackUSCF: null,\n    WhiteNA: null,\n    BlackNA: null,\n    WhiteType: null,\n    BlackType: null,\n    EventDate: null,\n    EventSponsor: null,\n    Section: null,\n    Stage: null,\n    Board: null,\n    Opening: null,\n    Variation: null,\n    SubVariation: null,\n    ECO: null,\n    NIC: null,\n    Time: null,\n    UTCTime: null,\n    UTCDate: null,\n    TimeControl: null,\n    SetUp: null,\n    FEN: null,\n    Termination: null,\n    Annotator: null,\n    Mode: null,\n    PlyCount: null,\n};\nconst HEADER_TEMPLATE = {\n    ...SEVEN_TAG_ROSTER,\n    ...SUPLEMENTAL_TAGS,\n};\n/* eslint-enable @typescript-eslint/naming-convention */\n/*\n * NOTES ABOUT 0x88 MOVE GENERATION ALGORITHM\n * ----------------------------------------------------------------------------\n * From https://github.com/jhlywa/chess.js/issues/230\n *\n * A lot of people are confused when they first see the internal representation\n * of chess.js. It uses the 0x88 Move Generation Algorithm which internally\n * stores the board as an 8x16 array. This is purely for efficiency but has a\n * couple of interesting benefits:\n *\n * 1. 0x88 offers a very inexpensive \"off the board\" check. Bitwise AND (&) any\n *    square with 0x88, if the result is non-zero then the square is off the\n *    board. For example, assuming a knight square A8 (0 in 0x88 notation),\n *    there are 8 possible directions in which the knight can move. These\n *    directions are relative to the 8x16 board and are stored in the\n *    PIECE_OFFSETS map. One possible move is A8 - 18 (up one square, and two\n *    squares to the left - which is off the board). 0 - 18 = -18 & 0x88 = 0x88\n *    (because of two-complement representation of -18). The non-zero result\n *    means the square is off the board and the move is illegal. Take the\n *    opposite move (from A8 to C7), 0 + 18 = 18 & 0x88 = 0. A result of zero\n *    means the square is on the board.\n *\n * 2. The relative distance (or difference) between two squares on a 8x16 board\n *    is unique and can be used to inexpensively determine if a piece on a\n *    square can attack any other arbitrary square. For example, let's see if a\n *    pawn on E7 can attack E2. The difference between E7 (20) - E2 (100) is\n *    -80. We add 119 to make the ATTACKS array index non-negative (because the\n *    worst case difference is A8 - H1 = -119). The ATTACKS array contains a\n *    bitmask of pieces that can attack from that distance and direction.\n *    ATTACKS[-80 + 119=39] gives us 24 or 0b11000 in binary. Look at the\n *    PIECE_MASKS map to determine the mask for a given piece type. In our pawn\n *    example, we would check to see if 24 & 0x1 is non-zero, which it is\n *    not. So, naturally, a pawn on E7 can't attack a piece on E2. However, a\n *    rook can since 24 & 0x8 is non-zero. The only thing left to check is that\n *    there are no blocking pieces between E7 and E2. That's where the RAYS\n *    array comes in. It provides an offset (in this case 16) to add to E7 (20)\n *    to check for blocking pieces. E7 (20) + 16 = E6 (36) + 16 = E5 (52) etc.\n */\n// prettier-ignore\n// eslint-disable-next-line\nconst Ox88 = {\n    a8: 0, b8: 1, c8: 2, d8: 3, e8: 4, f8: 5, g8: 6, h8: 7,\n    a7: 16, b7: 17, c7: 18, d7: 19, e7: 20, f7: 21, g7: 22, h7: 23,\n    a6: 32, b6: 33, c6: 34, d6: 35, e6: 36, f6: 37, g6: 38, h6: 39,\n    a5: 48, b5: 49, c5: 50, d5: 51, e5: 52, f5: 53, g5: 54, h5: 55,\n    a4: 64, b4: 65, c4: 66, d4: 67, e4: 68, f4: 69, g4: 70, h4: 71,\n    a3: 80, b3: 81, c3: 82, d3: 83, e3: 84, f3: 85, g3: 86, h3: 87,\n    a2: 96, b2: 97, c2: 98, d2: 99, e2: 100, f2: 101, g2: 102, h2: 103,\n    a1: 112, b1: 113, c1: 114, d1: 115, e1: 116, f1: 117, g1: 118, h1: 119\n};\nconst PAWN_OFFSETS = {\n    b: [16, 32, 17, 15],\n    w: [-16, -32, -17, -15],\n};\nconst PIECE_OFFSETS = {\n    n: [-18, -33, -31, -14, 18, 33, 31, 14],\n    b: [-17, -15, 17, 15],\n    r: [-16, 1, 16, -1],\n    q: [-17, -16, -15, 1, 17, 16, 15, -1],\n    k: [-17, -16, -15, 1, 17, 16, 15, -1],\n};\n// prettier-ignore\nconst ATTACKS = [\n    20, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 20, 0,\n    0, 20, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 20, 0, 0,\n    0, 0, 20, 0, 0, 0, 0, 24, 0, 0, 0, 0, 20, 0, 0, 0,\n    0, 0, 0, 20, 0, 0, 0, 24, 0, 0, 0, 20, 0, 0, 0, 0,\n    0, 0, 0, 0, 20, 0, 0, 24, 0, 0, 20, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 20, 2, 24, 2, 20, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 2, 53, 56, 53, 2, 0, 0, 0, 0, 0, 0,\n    24, 24, 24, 24, 24, 24, 56, 0, 56, 24, 24, 24, 24, 24, 24, 0,\n    0, 0, 0, 0, 0, 2, 53, 56, 53, 2, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 20, 2, 24, 2, 20, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 20, 0, 0, 24, 0, 0, 20, 0, 0, 0, 0, 0,\n    0, 0, 0, 20, 0, 0, 0, 24, 0, 0, 0, 20, 0, 0, 0, 0,\n    0, 0, 20, 0, 0, 0, 0, 24, 0, 0, 0, 0, 20, 0, 0, 0,\n    0, 20, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 20, 0, 0,\n    20, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 20\n];\n// prettier-ignore\nconst RAYS = [\n    17, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 15, 0,\n    0, 17, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 15, 0, 0,\n    0, 0, 17, 0, 0, 0, 0, 16, 0, 0, 0, 0, 15, 0, 0, 0,\n    0, 0, 0, 17, 0, 0, 0, 16, 0, 0, 0, 15, 0, 0, 0, 0,\n    0, 0, 0, 0, 17, 0, 0, 16, 0, 0, 15, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 17, 0, 16, 0, 15, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 0, 17, 16, 15, 0, 0, 0, 0, 0, 0, 0,\n    1, 1, 1, 1, 1, 1, 1, 0, -1, -1, -1, -1, -1, -1, -1, 0,\n    0, 0, 0, 0, 0, 0, -15, -16, -17, 0, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, -15, 0, -16, 0, -17, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, -15, 0, 0, -16, 0, 0, -17, 0, 0, 0, 0, 0,\n    0, 0, 0, -15, 0, 0, 0, -16, 0, 0, 0, -17, 0, 0, 0, 0,\n    0, 0, -15, 0, 0, 0, 0, -16, 0, 0, 0, 0, -17, 0, 0, 0,\n    0, -15, 0, 0, 0, 0, 0, -16, 0, 0, 0, 0, 0, -17, 0, 0,\n    -15, 0, 0, 0, 0, 0, 0, -16, 0, 0, 0, 0, 0, 0, -17\n];\nconst PIECE_MASKS = { p: 0x1, n: 0x2, b: 0x4, r: 0x8, q: 0x10, k: 0x20 };\nconst SYMBOLS = 'pnbrqkPNBRQK';\nconst PROMOTIONS = [KNIGHT, BISHOP, ROOK, QUEEN];\nconst RANK_1 = 7;\nconst RANK_2 = 6;\n/*\n * const RANK_3 = 5\n * const RANK_4 = 4\n * const RANK_5 = 3\n * const RANK_6 = 2\n */\nconst RANK_7 = 1;\nconst RANK_8 = 0;\nconst SIDES = {\n    [KING]: BITS.KSIDE_CASTLE,\n    [QUEEN]: BITS.QSIDE_CASTLE,\n};\nconst ROOKS = {\n    w: [\n        { square: Ox88.a1, flag: BITS.QSIDE_CASTLE },\n        { square: Ox88.h1, flag: BITS.KSIDE_CASTLE },\n    ],\n    b: [\n        { square: Ox88.a8, flag: BITS.QSIDE_CASTLE },\n        { square: Ox88.h8, flag: BITS.KSIDE_CASTLE },\n    ],\n};\nconst SECOND_RANK = { b: RANK_7, w: RANK_2 };\nconst SAN_NULLMOVE = '--';\n// Extracts the zero-based rank of an 0x88 square.\nfunction rank(square) {\n    return square >> 4;\n}\n// Extracts the zero-based file of an 0x88 square.\nfunction file(square) {\n    return square & 0xf;\n}\nfunction isDigit(c) {\n    return '0123456789'.indexOf(c) !== -1;\n}\n// Converts a 0x88 square to algebraic notation.\nfunction algebraic(square) {\n    const f = file(square);\n    const r = rank(square);\n    return ('abcdefgh'.substring(f, f + 1) +\n        '87654321'.substring(r, r + 1));\n}\nfunction swapColor(color) {\n    return color === WHITE ? BLACK : WHITE;\n}\nfunction validateFen(fen) {\n    // 1st criterion: 6 space-seperated fields?\n    const tokens = fen.split(/\\s+/);\n    if (tokens.length !== 6) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: must contain six space-delimited fields',\n        };\n    }\n    // 2nd criterion: move number field is a integer value > 0?\n    const moveNumber = parseInt(tokens[5], 10);\n    if (isNaN(moveNumber) || moveNumber <= 0) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: move number must be a positive integer',\n        };\n    }\n    // 3rd criterion: half move counter is an integer >= 0?\n    const halfMoves = parseInt(tokens[4], 10);\n    if (isNaN(halfMoves) || halfMoves < 0) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: half move counter number must be a non-negative integer',\n        };\n    }\n    // 4th criterion: 4th field is a valid e.p.-string?\n    if (!/^(-|[abcdefgh][36])$/.test(tokens[3])) {\n        return { ok: false, error: 'Invalid FEN: en-passant square is invalid' };\n    }\n    // 5th criterion: 3th field is a valid castle-string?\n    if (/[^kKqQ-]/.test(tokens[2])) {\n        return { ok: false, error: 'Invalid FEN: castling availability is invalid' };\n    }\n    // 6th criterion: 2nd field is \"w\" (white) or \"b\" (black)?\n    if (!/^(w|b)$/.test(tokens[1])) {\n        return { ok: false, error: 'Invalid FEN: side-to-move is invalid' };\n    }\n    // 7th criterion: 1st field contains 8 rows?\n    const rows = tokens[0].split('/');\n    if (rows.length !== 8) {\n        return {\n            ok: false,\n            error: \"Invalid FEN: piece data does not contain 8 '/'-delimited rows\",\n        };\n    }\n    // 8th criterion: every row is valid?\n    for (let i = 0; i < rows.length; i++) {\n        // check for right sum of fields AND not two numbers in succession\n        let sumFields = 0;\n        let previousWasNumber = false;\n        for (let k = 0; k < rows[i].length; k++) {\n            if (isDigit(rows[i][k])) {\n                if (previousWasNumber) {\n                    return {\n                        ok: false,\n                        error: 'Invalid FEN: piece data is invalid (consecutive number)',\n                    };\n                }\n                sumFields += parseInt(rows[i][k], 10);\n                previousWasNumber = true;\n            }\n            else {\n                if (!/^[prnbqkPRNBQK]$/.test(rows[i][k])) {\n                    return {\n                        ok: false,\n                        error: 'Invalid FEN: piece data is invalid (invalid piece)',\n                    };\n                }\n                sumFields += 1;\n                previousWasNumber = false;\n            }\n        }\n        if (sumFields !== 8) {\n            return {\n                ok: false,\n                error: 'Invalid FEN: piece data is invalid (too many squares in rank)',\n            };\n        }\n    }\n    // 9th criterion: is en-passant square legal?\n    if ((tokens[3][1] == '3' && tokens[1] == 'w') ||\n        (tokens[3][1] == '6' && tokens[1] == 'b')) {\n        return { ok: false, error: 'Invalid FEN: illegal en-passant square' };\n    }\n    // 10th criterion: does chess position contain exact two kings?\n    const kings = [\n        { color: 'white', regex: /K/g },\n        { color: 'black', regex: /k/g },\n    ];\n    for (const { color, regex } of kings) {\n        if (!regex.test(tokens[0])) {\n            return { ok: false, error: `Invalid FEN: missing ${color} king` };\n        }\n        if ((tokens[0].match(regex) || []).length > 1) {\n            return { ok: false, error: `Invalid FEN: too many ${color} kings` };\n        }\n    }\n    // 11th criterion: are any pawns on the first or eighth rows?\n    if (Array.from(rows[0] + rows[7]).some((char) => char.toUpperCase() === 'P')) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: some pawns are on the edge rows',\n        };\n    }\n    return { ok: true };\n}\n// this function is used to uniquely identify ambiguous moves\nfunction getDisambiguator(move, moves) {\n    const from = move.from;\n    const to = move.to;\n    const piece = move.piece;\n    let ambiguities = 0;\n    let sameRank = 0;\n    let sameFile = 0;\n    for (let i = 0, len = moves.length; i < len; i++) {\n        const ambigFrom = moves[i].from;\n        const ambigTo = moves[i].to;\n        const ambigPiece = moves[i].piece;\n        /*\n         * if a move of the same piece type ends on the same to square, we'll need\n         * to add a disambiguator to the algebraic notation\n         */\n        if (piece === ambigPiece && from !== ambigFrom && to === ambigTo) {\n            ambiguities++;\n            if (rank(from) === rank(ambigFrom)) {\n                sameRank++;\n            }\n            if (file(from) === file(ambigFrom)) {\n                sameFile++;\n            }\n        }\n    }\n    if (ambiguities > 0) {\n        if (sameRank > 0 && sameFile > 0) {\n            /*\n             * if there exists a similar moving piece on the same rank and file as\n             * the move in question, use the square as the disambiguator\n             */\n            return algebraic(from);\n        }\n        else if (sameFile > 0) {\n            /*\n             * if the moving piece rests on the same file, use the rank symbol as the\n             * disambiguator\n             */\n            return algebraic(from).charAt(1);\n        }\n        else {\n            // else use the file symbol\n            return algebraic(from).charAt(0);\n        }\n    }\n    return '';\n}\nfunction addMove(moves, color, from, to, piece, captured = undefined, flags = BITS.NORMAL) {\n    const r = rank(to);\n    if (piece === PAWN && (r === RANK_1 || r === RANK_8)) {\n        for (let i = 0; i < PROMOTIONS.length; i++) {\n            const promotion = PROMOTIONS[i];\n            moves.push({\n                color,\n                from,\n                to,\n                piece,\n                captured,\n                promotion,\n                flags: flags | BITS.PROMOTION,\n            });\n        }\n    }\n    else {\n        moves.push({\n            color,\n            from,\n            to,\n            piece,\n            captured,\n            flags,\n        });\n    }\n}\nfunction inferPieceType(san) {\n    let pieceType = san.charAt(0);\n    if (pieceType >= 'a' && pieceType <= 'h') {\n        const matches = san.match(/[a-h]\\d.*[a-h]\\d/);\n        if (matches) {\n            return undefined;\n        }\n        return PAWN;\n    }\n    pieceType = pieceType.toLowerCase();\n    if (pieceType === 'o') {\n        return KING;\n    }\n    return pieceType;\n}\n// parses all of the decorators out of a SAN string\nfunction strippedSan(move) {\n    return move.replace(/=/, '').replace(/[+#]?[?!]*$/, '');\n}\nclass Chess {\n    _board = new Array(128);\n    _turn = WHITE;\n    _header = {};\n    _kings = { w: EMPTY, b: EMPTY };\n    _epSquare = -1;\n    _halfMoves = 0;\n    _moveNumber = 0;\n    _history = [];\n    _comments = {};\n    _castling = { w: 0, b: 0 };\n    _hash = 0n;\n    // tracks number of times a position has been seen for repetition checking\n    _positionCount = new Map();\n    constructor(fen = DEFAULT_POSITION, { skipValidation = false } = {}) {\n        this.load(fen, { skipValidation });\n    }\n    clear({ preserveHeaders = false } = {}) {\n        this._board = new Array(128);\n        this._kings = { w: EMPTY, b: EMPTY };\n        this._turn = WHITE;\n        this._castling = { w: 0, b: 0 };\n        this._epSquare = EMPTY;\n        this._halfMoves = 0;\n        this._moveNumber = 1;\n        this._history = [];\n        this._comments = {};\n        this._header = preserveHeaders ? this._header : { ...HEADER_TEMPLATE };\n        this._hash = this._computeHash();\n        this._positionCount = new Map();\n        /*\n         * Delete the SetUp and FEN headers (if preserved), the board is empty and\n         * these headers don't make sense in this state. They'll get added later\n         * via .load() or .put()\n         */\n        this._header['SetUp'] = null;\n        this._header['FEN'] = null;\n    }\n    load(fen, { skipValidation = false, preserveHeaders = false } = {}) {\n        let tokens = fen.split(/\\s+/);\n        // append commonly omitted fen tokens\n        if (tokens.length >= 2 && tokens.length < 6) {\n            const adjustments = ['-', '-', '0', '1'];\n            fen = tokens.concat(adjustments.slice(-(6 - tokens.length))).join(' ');\n        }\n        tokens = fen.split(/\\s+/);\n        if (!skipValidation) {\n            const { ok, error } = validateFen(fen);\n            if (!ok) {\n                throw new Error(error);\n            }\n        }\n        const position = tokens[0];\n        let square = 0;\n        this.clear({ preserveHeaders });\n        for (let i = 0; i < position.length; i++) {\n            const piece = position.charAt(i);\n            if (piece === '/') {\n                square += 8;\n            }\n            else if (isDigit(piece)) {\n                square += parseInt(piece, 10);\n            }\n            else {\n                const color = piece < 'a' ? WHITE : BLACK;\n                this._put({ type: piece.toLowerCase(), color }, algebraic(square));\n                square++;\n            }\n        }\n        this._turn = tokens[1];\n        if (tokens[2].indexOf('K') > -1) {\n            this._castling.w |= BITS.KSIDE_CASTLE;\n        }\n        if (tokens[2].indexOf('Q') > -1) {\n            this._castling.w |= BITS.QSIDE_CASTLE;\n        }\n        if (tokens[2].indexOf('k') > -1) {\n            this._castling.b |= BITS.KSIDE_CASTLE;\n        }\n        if (tokens[2].indexOf('q') > -1) {\n            this._castling.b |= BITS.QSIDE_CASTLE;\n        }\n        this._epSquare = tokens[3] === '-' ? EMPTY : Ox88[tokens[3]];\n        this._halfMoves = parseInt(tokens[4], 10);\n        this._moveNumber = parseInt(tokens[5], 10);\n        this._hash = this._computeHash();\n        this._updateSetup(fen);\n        this._incPositionCount();\n    }\n    fen({ forceEnpassantSquare = false, } = {}) {\n        let empty = 0;\n        let fen = '';\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            if (this._board[i]) {\n                if (empty > 0) {\n                    fen += empty;\n                    empty = 0;\n                }\n                const { color, type: piece } = this._board[i];\n                fen += color === WHITE ? piece.toUpperCase() : piece.toLowerCase();\n            }\n            else {\n                empty++;\n            }\n            if ((i + 1) & 0x88) {\n                if (empty > 0) {\n                    fen += empty;\n                }\n                if (i !== Ox88.h1) {\n                    fen += '/';\n                }\n                empty = 0;\n                i += 8;\n            }\n        }\n        let castling = '';\n        if (this._castling[WHITE] & BITS.KSIDE_CASTLE) {\n            castling += 'K';\n        }\n        if (this._castling[WHITE] & BITS.QSIDE_CASTLE) {\n            castling += 'Q';\n        }\n        if (this._castling[BLACK] & BITS.KSIDE_CASTLE) {\n            castling += 'k';\n        }\n        if (this._castling[BLACK] & BITS.QSIDE_CASTLE) {\n            castling += 'q';\n        }\n        // do we have an empty castling flag?\n        castling = castling || '-';\n        let epSquare = '-';\n        /*\n         * only print the ep square if en passant is a valid move (pawn is present\n         * and ep capture is not pinned)\n         */\n        if (this._epSquare !== EMPTY) {\n            if (forceEnpassantSquare) {\n                epSquare = algebraic(this._epSquare);\n            }\n            else {\n                const bigPawnSquare = this._epSquare + (this._turn === WHITE ? 16 : -16);\n                const squares = [bigPawnSquare + 1, bigPawnSquare - 1];\n                for (const square of squares) {\n                    // is the square off the board?\n                    if (square & 0x88) {\n                        continue;\n                    }\n                    const color = this._turn;\n                    // is there a pawn that can capture the epSquare?\n                    if (this._board[square]?.color === color &&\n                        this._board[square]?.type === PAWN) {\n                        // if the pawn makes an ep capture, does it leave its king in check?\n                        this._makeMove({\n                            color,\n                            from: square,\n                            to: this._epSquare,\n                            piece: PAWN,\n                            captured: PAWN,\n                            flags: BITS.EP_CAPTURE,\n                        });\n                        const isLegal = !this._isKingAttacked(color);\n                        this._undoMove();\n                        // if ep is legal, break and set the ep square in the FEN output\n                        if (isLegal) {\n                            epSquare = algebraic(this._epSquare);\n                            break;\n                        }\n                    }\n                }\n            }\n        }\n        return [\n            fen,\n            this._turn,\n            castling,\n            epSquare,\n            this._halfMoves,\n            this._moveNumber,\n        ].join(' ');\n    }\n    _pieceKey(i) {\n        if (!this._board[i]) {\n            return 0n;\n        }\n        const { color, type } = this._board[i];\n        const colorIndex = {\n            w: 0,\n            b: 1,\n        }[color];\n        const typeIndex = {\n            p: 0,\n            n: 1,\n            b: 2,\n            r: 3,\n            q: 4,\n            k: 5,\n        }[type];\n        return PIECE_KEYS[colorIndex][typeIndex][i];\n    }\n    _epKey() {\n        return this._epSquare === EMPTY ? 0n : EP_KEYS[this._epSquare & 7];\n    }\n    _castlingKey() {\n        const index = (this._castling.w >> 5) | (this._castling.b >> 3);\n        return CASTLING_KEYS[index];\n    }\n    _computeHash() {\n        let hash = 0n;\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            // did we run off the end of the board\n            if (i & 0x88) {\n                i += 7;\n                continue;\n            }\n            if (this._board[i]) {\n                hash ^= this._pieceKey(i);\n            }\n        }\n        hash ^= this._epKey();\n        hash ^= this._castlingKey();\n        if (this._turn === 'b') {\n            hash ^= SIDE_KEY;\n        }\n        return hash;\n    }\n    /*\n     * Called when the initial board setup is changed with put() or remove().\n     * modifies the SetUp and FEN properties of the header object. If the FEN\n     * is equal to the default position, the SetUp and FEN are deleted the setup\n     * is only updated if history.length is zero, ie moves haven't been made.\n     */\n    _updateSetup(fen) {\n        if (this._history.length > 0)\n            return;\n        if (fen !== DEFAULT_POSITION) {\n            this._header['SetUp'] = '1';\n            this._header['FEN'] = fen;\n        }\n        else {\n            this._header['SetUp'] = null;\n            this._header['FEN'] = null;\n        }\n    }\n    reset() {\n        this.load(DEFAULT_POSITION);\n    }\n    get(square) {\n        return this._board[Ox88[square]];\n    }\n    findPiece(piece) {\n        const squares = [];\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            // did we run off the end of the board\n            if (i & 0x88) {\n                i += 7;\n                continue;\n            }\n            // if empty square or wrong color\n            if (!this._board[i] || this._board[i]?.color !== piece.color) {\n                continue;\n            }\n            // check if square contains the requested piece\n            if (this._board[i].color === piece.color &&\n                this._board[i].type === piece.type) {\n                squares.push(algebraic(i));\n            }\n        }\n        return squares;\n    }\n    put({ type, color }, square) {\n        if (this._put({ type, color }, square)) {\n            this._updateCastlingRights();\n            this._updateEnPassantSquare();\n            this._updateSetup(this.fen());\n            return true;\n        }\n        return false;\n    }\n    _set(sq, piece) {\n        this._hash ^= this._pieceKey(sq);\n        this._board[sq] = piece;\n        this._hash ^= this._pieceKey(sq);\n    }\n    _put({ type, color }, square) {\n        // check for piece\n        if (SYMBOLS.indexOf(type.toLowerCase()) === -1) {\n            return false;\n        }\n        // check for valid square\n        if (!(square in Ox88)) {\n            return false;\n        }\n        const sq = Ox88[square];\n        // don't let the user place more than one king\n        if (type == KING &&\n            !(this._kings[color] == EMPTY || this._kings[color] == sq)) {\n            return false;\n        }\n        const currentPieceOnSquare = this._board[sq];\n        // if one of the kings will be replaced by the piece from args, set the `_kings` respective entry to `EMPTY`\n        if (currentPieceOnSquare && currentPieceOnSquare.type === KING) {\n            this._kings[currentPieceOnSquare.color] = EMPTY;\n        }\n        this._set(sq, { type: type, color: color });\n        if (type === KING) {\n            this._kings[color] = sq;\n        }\n        return true;\n    }\n    _clear(sq) {\n        this._hash ^= this._pieceKey(sq);\n        delete this._board[sq];\n    }\n    remove(square) {\n        const piece = this.get(square);\n        this._clear(Ox88[square]);\n        if (piece && piece.type === KING) {\n            this._kings[piece.color] = EMPTY;\n        }\n        this._updateCastlingRights();\n        this._updateEnPassantSquare();\n        this._updateSetup(this.fen());\n        return piece;\n    }\n    _updateCastlingRights() {\n        this._hash ^= this._castlingKey();\n        const whiteKingInPlace = this._board[Ox88.e1]?.type === KING &&\n            this._board[Ox88.e1]?.color === WHITE;\n        const blackKingInPlace = this._board[Ox88.e8]?.type === KING &&\n            this._board[Ox88.e8]?.color === BLACK;\n        if (!whiteKingInPlace ||\n            this._board[Ox88.a1]?.type !== ROOK ||\n            this._board[Ox88.a1]?.color !== WHITE) {\n            this._castling.w &= -65;\n        }\n        if (!whiteKingInPlace ||\n            this._board[Ox88.h1]?.type !== ROOK ||\n            this._board[Ox88.h1]?.color !== WHITE) {\n            this._castling.w &= -33;\n        }\n        if (!blackKingInPlace ||\n            this._board[Ox88.a8]?.type !== ROOK ||\n            this._board[Ox88.a8]?.color !== BLACK) {\n            this._castling.b &= -65;\n        }\n        if (!blackKingInPlace ||\n            this._board[Ox88.h8]?.type !== ROOK ||\n            this._board[Ox88.h8]?.color !== BLACK) {\n            this._castling.b &= -33;\n        }\n        this._hash ^= this._castlingKey();\n    }\n    _updateEnPassantSquare() {\n        if (this._epSquare === EMPTY) {\n            return;\n        }\n        const startSquare = this._epSquare + (this._turn === WHITE ? -16 : 16);\n        const currentSquare = this._epSquare + (this._turn === WHITE ? 16 : -16);\n        const attackers = [currentSquare + 1, currentSquare - 1];\n        if (this._board[startSquare] !== null ||\n            this._board[this._epSquare] !== null ||\n            this._board[currentSquare]?.color !== swapColor(this._turn) ||\n            this._board[currentSquare]?.type !== PAWN) {\n            this._hash ^= this._epKey();\n            this._epSquare = EMPTY;\n            return;\n        }\n        const canCapture = (square) => !(square & 0x88) &&\n            this._board[square]?.color === this._turn &&\n            this._board[square]?.type === PAWN;\n        if (!attackers.some(canCapture)) {\n            this._hash ^= this._epKey();\n            this._epSquare = EMPTY;\n        }\n    }\n    _attacked(color, square, verbose) {\n        const attackers = [];\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            // did we run off the end of the board\n            if (i & 0x88) {\n                i += 7;\n                continue;\n            }\n            // if empty square or wrong color\n            if (this._board[i] === undefined || this._board[i].color !== color) {\n                continue;\n            }\n            const piece = this._board[i];\n            const difference = i - square;\n            // skip - to/from square are the same\n            if (difference === 0) {\n                continue;\n            }\n            const index = difference + 119;\n            if (ATTACKS[index] & PIECE_MASKS[piece.type]) {\n                if (piece.type === PAWN) {\n                    if ((difference > 0 && piece.color === WHITE) ||\n                        (difference <= 0 && piece.color === BLACK)) {\n                        if (!verbose) {\n                            return true;\n                        }\n                        else {\n                            attackers.push(algebraic(i));\n                        }\n                    }\n                    continue;\n                }\n                // if the piece is a knight or a king\n                if (piece.type === 'n' || piece.type === 'k') {\n                    if (!verbose) {\n                        return true;\n                    }\n                    else {\n                        attackers.push(algebraic(i));\n                        continue;\n                    }\n                }\n                const offset = RAYS[index];\n                let j = i + offset;\n                let blocked = false;\n                while (j !== square) {\n                    if (this._board[j] != null) {\n                        blocked = true;\n                        break;\n                    }\n                    j += offset;\n                }\n                if (!blocked) {\n                    if (!verbose) {\n                        return true;\n                    }\n                    else {\n                        attackers.push(algebraic(i));\n                        continue;\n                    }\n                }\n            }\n        }\n        if (verbose) {\n            return attackers;\n        }\n        else {\n            return false;\n        }\n    }\n    attackers(square, attackedBy) {\n        if (!attackedBy) {\n            return this._attacked(this._turn, Ox88[square], true);\n        }\n        else {\n            return this._attacked(attackedBy, Ox88[square], true);\n        }\n    }\n    _isKingAttacked(color) {\n        const square = this._kings[color];\n        return square === -1 ? false : this._attacked(swapColor(color), square);\n    }\n    hash() {\n        return this._hash.toString(16);\n    }\n    isAttacked(square, attackedBy) {\n        return this._attacked(attackedBy, Ox88[square]);\n    }\n    isCheck() {\n        return this._isKingAttacked(this._turn);\n    }\n    inCheck() {\n        return this.isCheck();\n    }\n    isCheckmate() {\n        return this.isCheck() && this._moves().length === 0;\n    }\n    isStalemate() {\n        return !this.isCheck() && this._moves().length === 0;\n    }\n    isInsufficientMaterial() {\n        /*\n         * k.b. vs k.b. (of opposite colors) with mate in 1:\n         * 8/8/8/8/1b6/8/B1k5/K7 b - - 0 1\n         *\n         * k.b. vs k.n. with mate in 1:\n         * 8/8/8/8/1n6/8/B7/K1k5 b - - 2 1\n         */\n        const pieces = {\n            b: 0,\n            n: 0,\n            r: 0,\n            q: 0,\n            k: 0,\n            p: 0,\n        };\n        const bishops = [];\n        let numPieces = 0;\n        let squareColor = 0;\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            squareColor = (squareColor + 1) % 2;\n            if (i & 0x88) {\n                i += 7;\n                continue;\n            }\n            const piece = this._board[i];\n            if (piece) {\n                pieces[piece.type] = piece.type in pieces ? pieces[piece.type] + 1 : 1;\n                if (piece.type === BISHOP) {\n                    bishops.push(squareColor);\n                }\n                numPieces++;\n            }\n        }\n        // k vs. k\n        if (numPieces === 2) {\n            return true;\n        }\n        else if (\n        // k vs. kn .... or .... k vs. kb\n        numPieces === 3 &&\n            (pieces[BISHOP] === 1 || pieces[KNIGHT] === 1)) {\n            return true;\n        }\n        else if (numPieces === pieces[BISHOP] + 2) {\n            // kb vs. kb where any number of bishops are all on the same color\n            let sum = 0;\n            const len = bishops.length;\n            for (let i = 0; i < len; i++) {\n                sum += bishops[i];\n            }\n            if (sum === 0 || sum === len) {\n                return true;\n            }\n        }\n        return false;\n    }\n    isThreefoldRepetition() {\n        return this._getPositionCount(this._hash) >= 3;\n    }\n    isDrawByFiftyMoves() {\n        return this._halfMoves >= 100; // 50 moves per side = 100 half moves\n    }\n    isDraw() {\n        return (this.isDrawByFiftyMoves() ||\n            this.isStalemate() ||\n            this.isInsufficientMaterial() ||\n            this.isThreefoldRepetition());\n    }\n    isGameOver() {\n        return this.isCheckmate() || this.isDraw();\n    }\n    moves({ verbose = false, square = undefined, piece = undefined, } = {}) {\n        const moves = this._moves({ square, piece });\n        if (verbose) {\n            return moves.map((move) => new Move(this, move));\n        }\n        else {\n            return moves.map((move) => this._moveToSan(move, moves));\n        }\n    }\n    _moves({ legal = true, piece = undefined, square = undefined, } = {}) {\n        const forSquare = square ? square.toLowerCase() : undefined;\n        const forPiece = piece?.toLowerCase();\n        const moves = [];\n        const us = this._turn;\n        const them = swapColor(us);\n        let firstSquare = Ox88.a8;\n        let lastSquare = Ox88.h1;\n        let singleSquare = false;\n        // are we generating moves for a single square?\n        if (forSquare) {\n            // illegal square, return empty moves\n            if (!(forSquare in Ox88)) {\n                return [];\n            }\n            else {\n                firstSquare = lastSquare = Ox88[forSquare];\n                singleSquare = true;\n            }\n        }\n        for (let from = firstSquare; from <= lastSquare; from++) {\n            // did we run off the end of the board\n            if (from & 0x88) {\n                from += 7;\n                continue;\n            }\n            // empty square or opponent, skip\n            if (!this._board[from] || this._board[from].color === them) {\n                continue;\n            }\n            const { type } = this._board[from];\n            let to;\n            if (type === PAWN) {\n                if (forPiece && forPiece !== type)\n                    continue;\n                // single square, non-capturing\n                to = from + PAWN_OFFSETS[us][0];\n                if (!this._board[to]) {\n                    addMove(moves, us, from, to, PAWN);\n                    // double square\n                    to = from + PAWN_OFFSETS[us][1];\n                    if (SECOND_RANK[us] === rank(from) && !this._board[to]) {\n                        addMove(moves, us, from, to, PAWN, undefined, BITS.BIG_PAWN);\n                    }\n                }\n                // pawn captures\n                for (let j = 2; j < 4; j++) {\n                    to = from + PAWN_OFFSETS[us][j];\n                    if (to & 0x88)\n                        continue;\n                    if (this._board[to]?.color === them) {\n                        addMove(moves, us, from, to, PAWN, this._board[to].type, BITS.CAPTURE);\n                    }\n                    else if (to === this._epSquare) {\n                        addMove(moves, us, from, to, PAWN, PAWN, BITS.EP_CAPTURE);\n                    }\n                }\n            }\n            else {\n                if (forPiece && forPiece !== type)\n                    continue;\n                for (let j = 0, len = PIECE_OFFSETS[type].length; j < len; j++) {\n                    const offset = PIECE_OFFSETS[type][j];\n                    to = from;\n                    while (true) {\n                        to += offset;\n                        if (to & 0x88)\n                            break;\n                        if (!this._board[to]) {\n                            addMove(moves, us, from, to, type);\n                        }\n                        else {\n                            // own color, stop loop\n                            if (this._board[to].color === us)\n                                break;\n                            addMove(moves, us, from, to, type, this._board[to].type, BITS.CAPTURE);\n                            break;\n                        }\n                        /* break, if knight or king */\n                        if (type === KNIGHT || type === KING)\n                            break;\n                    }\n                }\n            }\n        }\n        /*\n         * check for castling if we're:\n         *   a) generating all moves, or\n         *   b) doing single square move generation on the king's square\n         */\n        if (forPiece === undefined || forPiece === KING) {\n            if (!singleSquare || lastSquare === this._kings[us]) {\n                // king-side castling\n                if (this._castling[us] & BITS.KSIDE_CASTLE) {\n                    const castlingFrom = this._kings[us];\n                    const castlingTo = castlingFrom + 2;\n                    if (!this._board[castlingFrom + 1] &&\n                        !this._board[castlingTo] &&\n                        !this._attacked(them, this._kings[us]) &&\n                        !this._attacked(them, castlingFrom + 1) &&\n                        !this._attacked(them, castlingTo)) {\n                        addMove(moves, us, this._kings[us], castlingTo, KING, undefined, BITS.KSIDE_CASTLE);\n                    }\n                }\n                // queen-side castling\n                if (this._castling[us] & BITS.QSIDE_CASTLE) {\n                    const castlingFrom = this._kings[us];\n                    const castlingTo = castlingFrom - 2;\n                    if (!this._board[castlingFrom - 1] &&\n                        !this._board[castlingFrom - 2] &&\n                        !this._board[castlingFrom - 3] &&\n                        !this._attacked(them, this._kings[us]) &&\n                        !this._attacked(them, castlingFrom - 1) &&\n                        !this._attacked(them, castlingTo)) {\n                        addMove(moves, us, this._kings[us], castlingTo, KING, undefined, BITS.QSIDE_CASTLE);\n                    }\n                }\n            }\n        }\n        /*\n         * return all pseudo-legal moves (this includes moves that allow the king\n         * to be captured)\n         */\n        if (!legal || this._kings[us] === -1) {\n            return moves;\n        }\n        // filter out illegal moves\n        const legalMoves = [];\n        for (let i = 0, len = moves.length; i < len; i++) {\n            this._makeMove(moves[i]);\n            if (!this._isKingAttacked(us)) {\n                legalMoves.push(moves[i]);\n            }\n            this._undoMove();\n        }\n        return legalMoves;\n    }\n    move(move, { strict = false } = {}) {\n        /*\n         * The move function can be called with in the following parameters:\n         *\n         * .move('Nxb7')       <- argument is a case-sensitive SAN string\n         *\n         * .move({ from: 'h7', <- argument is a move object\n         *         to :'h8',\n         *         promotion: 'q' })\n         *\n         *\n         * An optional strict argument may be supplied to tell chess.js to\n         * strictly follow the SAN specification.\n         */\n        let moveObj = null;\n        if (typeof move === 'string') {\n            moveObj = this._moveFromSan(move, strict);\n        }\n        else if (move === null) {\n            moveObj = this._moveFromSan(SAN_NULLMOVE, strict);\n        }\n        else if (typeof move === 'object') {\n            const moves = this._moves();\n            // convert the pretty move object to an ugly move object\n            for (let i = 0, len = moves.length; i < len; i++) {\n                if (move.from === algebraic(moves[i].from) &&\n                    move.to === algebraic(moves[i].to) &&\n                    (!('promotion' in moves[i]) || move.promotion === moves[i].promotion)) {\n                    moveObj = moves[i];\n                    break;\n                }\n            }\n        }\n        // failed to find move\n        if (!moveObj) {\n            if (typeof move === 'string') {\n                throw new Error(`Invalid move: ${move}`);\n            }\n            else {\n                throw new Error(`Invalid move: ${JSON.stringify(move)}`);\n            }\n        }\n        //disallow null moves when in check\n        if (this.isCheck() && moveObj.flags & BITS.NULL_MOVE) {\n            throw new Error('Null move not allowed when in check');\n        }\n        /*\n         * need to make a copy of move because we can't generate SAN after the move\n         * is made\n         */\n        const prettyMove = new Move(this, moveObj);\n        this._makeMove(moveObj);\n        this._incPositionCount();\n        return prettyMove;\n    }\n    _push(move) {\n        this._history.push({\n            move,\n            kings: { b: this._kings.b, w: this._kings.w },\n            turn: this._turn,\n            castling: { b: this._castling.b, w: this._castling.w },\n            epSquare: this._epSquare,\n            halfMoves: this._halfMoves,\n            moveNumber: this._moveNumber,\n        });\n    }\n    _movePiece(from, to) {\n        this._hash ^= this._pieceKey(from);\n        this._board[to] = this._board[from];\n        delete this._board[from];\n        this._hash ^= this._pieceKey(to);\n    }\n    _makeMove(move) {\n        const us = this._turn;\n        const them = swapColor(us);\n        this._push(move);\n        if (move.flags & BITS.NULL_MOVE) {\n            if (us === BLACK) {\n                this._moveNumber++;\n            }\n            this._halfMoves++;\n            this._turn = them;\n            this._epSquare = EMPTY;\n            return;\n        }\n        this._hash ^= this._epKey();\n        this._hash ^= this._castlingKey();\n        if (move.captured) {\n            this._hash ^= this._pieceKey(move.to);\n        }\n        this._movePiece(move.from, move.to);\n        // if ep capture, remove the captured pawn\n        if (move.flags & BITS.EP_CAPTURE) {\n            if (this._turn === BLACK) {\n                this._clear(move.to - 16);\n            }\n            else {\n                this._clear(move.to + 16);\n            }\n        }\n        // if pawn promotion, replace with new piece\n        if (move.promotion) {\n            this._clear(move.to);\n            this._set(move.to, { type: move.promotion, color: us });\n        }\n        // if we moved the king\n        if (this._board[move.to].type === KING) {\n            this._kings[us] = move.to;\n            // if we castled, move the rook next to the king\n            if (move.flags & BITS.KSIDE_CASTLE) {\n                const castlingTo = move.to - 1;\n                const castlingFrom = move.to + 1;\n                this._movePiece(castlingFrom, castlingTo);\n            }\n            else if (move.flags & BITS.QSIDE_CASTLE) {\n                const castlingTo = move.to + 1;\n                const castlingFrom = move.to - 2;\n                this._movePiece(castlingFrom, castlingTo);\n            }\n            // turn off castling\n            this._castling[us] = 0;\n        }\n        // turn off castling if we move a rook\n        if (this._castling[us]) {\n            for (let i = 0, len = ROOKS[us].length; i < len; i++) {\n                if (move.from === ROOKS[us][i].square &&\n                    this._castling[us] & ROOKS[us][i].flag) {\n                    this._castling[us] ^= ROOKS[us][i].flag;\n                    break;\n                }\n            }\n        }\n        // turn off castling if we capture a rook\n        if (this._castling[them]) {\n            for (let i = 0, len = ROOKS[them].length; i < len; i++) {\n                if (move.to === ROOKS[them][i].square &&\n                    this._castling[them] & ROOKS[them][i].flag) {\n                    this._castling[them] ^= ROOKS[them][i].flag;\n                    break;\n                }\n            }\n        }\n        this._hash ^= this._castlingKey();\n        // if big pawn move, update the en passant square\n        if (move.flags & BITS.BIG_PAWN) {\n            let epSquare;\n            if (us === BLACK) {\n                epSquare = move.to - 16;\n            }\n            else {\n                epSquare = move.to + 16;\n            }\n            if ((!((move.to - 1) & 0x88) &&\n                this._board[move.to - 1]?.type === PAWN &&\n                this._board[move.to - 1]?.color === them) ||\n                (!((move.to + 1) & 0x88) &&\n                    this._board[move.to + 1]?.type === PAWN &&\n                    this._board[move.to + 1]?.color === them)) {\n                this._epSquare = epSquare;\n                this._hash ^= this._epKey();\n            }\n            else {\n                this._epSquare = EMPTY;\n            }\n        }\n        else {\n            this._epSquare = EMPTY;\n        }\n        // reset the 50 move counter if a pawn is moved or a piece is captured\n        if (move.piece === PAWN) {\n            this._halfMoves = 0;\n        }\n        else if (move.flags & (BITS.CAPTURE | BITS.EP_CAPTURE)) {\n            this._halfMoves = 0;\n        }\n        else {\n            this._halfMoves++;\n        }\n        if (us === BLACK) {\n            this._moveNumber++;\n        }\n        this._turn = them;\n        this._hash ^= SIDE_KEY;\n    }\n    undo() {\n        const hash = this._hash;\n        const move = this._undoMove();\n        if (move) {\n            const prettyMove = new Move(this, move);\n            this._decPositionCount(hash);\n            return prettyMove;\n        }\n        return null;\n    }\n    _undoMove() {\n        const old = this._history.pop();\n        if (old === undefined) {\n            return null;\n        }\n        this._hash ^= this._epKey();\n        this._hash ^= this._castlingKey();\n        const move = old.move;\n        this._kings = old.kings;\n        this._turn = old.turn;\n        this._castling = old.castling;\n        this._epSquare = old.epSquare;\n        this._halfMoves = old.halfMoves;\n        this._moveNumber = old.moveNumber;\n        this._hash ^= this._epKey();\n        this._hash ^= this._castlingKey();\n        this._hash ^= SIDE_KEY;\n        const us = this._turn;\n        const them = swapColor(us);\n        if (move.flags & BITS.NULL_MOVE) {\n            return move;\n        }\n        this._movePiece(move.to, move.from);\n        // to undo any promotions\n        if (move.piece) {\n            this._clear(move.from);\n            this._set(move.from, { type: move.piece, color: us });\n        }\n        if (move.captured) {\n            if (move.flags & BITS.EP_CAPTURE) {\n                // en passant capture\n                let index;\n                if (us === BLACK) {\n                    index = move.to - 16;\n                }\n                else {\n                    index = move.to + 16;\n                }\n                this._set(index, { type: PAWN, color: them });\n            }\n            else {\n                // regular capture\n                this._set(move.to, { type: move.captured, color: them });\n            }\n        }\n        if (move.flags & (BITS.KSIDE_CASTLE | BITS.QSIDE_CASTLE)) {\n            let castlingTo, castlingFrom;\n            if (move.flags & BITS.KSIDE_CASTLE) {\n                castlingTo = move.to + 1;\n                castlingFrom = move.to - 1;\n            }\n            else {\n                castlingTo = move.to - 2;\n                castlingFrom = move.to + 1;\n            }\n            this._movePiece(castlingFrom, castlingTo);\n        }\n        return move;\n    }\n    pgn({ newline = '\\n', maxWidth = 0, } = {}) {\n        /*\n         * using the specification from http://www.chessclub.com/help/PGN-spec\n         * example for html usage: .pgn({ max_width: 72, newline_char: \"<br />\" })\n         */\n        const result = [];\n        let headerExists = false;\n        /* add the PGN header information */\n        for (const i in this._header) {\n            /*\n             * TODO: order of enumerated properties in header object is not\n             * guaranteed, see ECMA-262 spec (section 12.6.4)\n             *\n             * By using HEADER_TEMPLATE, the order of tags should be preserved; we\n             * do have to check for null placeholders, though, and omit them\n             */\n            const headerTag = this._header[i];\n            if (headerTag)\n                result.push(`[${i} \"${this._header[i]}\"]` + newline);\n            headerExists = true;\n        }\n        if (headerExists && this._history.length) {\n            result.push(newline);\n        }\n        const appendComment = (moveString) => {\n            const comment = this._comments[this.fen()];\n            if (typeof comment !== 'undefined') {\n                const delimiter = moveString.length > 0 ? ' ' : '';\n                moveString = `${moveString}${delimiter}{${comment}}`;\n            }\n            return moveString;\n        };\n        // pop all of history onto reversed_history\n        const reversedHistory = [];\n        while (this._history.length > 0) {\n            reversedHistory.push(this._undoMove());\n        }\n        const moves = [];\n        let moveString = '';\n        // special case of a commented starting position with no moves\n        if (reversedHistory.length === 0) {\n            moves.push(appendComment(''));\n        }\n        // build the list of moves.  a move_string looks like: \"3. e3 e6\"\n        while (reversedHistory.length > 0) {\n            moveString = appendComment(moveString);\n            const move = reversedHistory.pop();\n            // make TypeScript stop complaining about move being undefined\n            if (!move) {\n                break;\n            }\n            // if the position started with black to move, start PGN with #. ...\n            if (!this._history.length && move.color === 'b') {\n                const prefix = `${this._moveNumber}. ...`;\n                // is there a comment preceding the first move?\n                moveString = moveString ? `${moveString} ${prefix}` : prefix;\n            }\n            else if (move.color === 'w') {\n                // store the previous generated move_string if we have one\n                if (moveString.length) {\n                    moves.push(moveString);\n                }\n                moveString = this._moveNumber + '.';\n            }\n            moveString =\n                moveString + ' ' + this._moveToSan(move, this._moves({ legal: true }));\n            this._makeMove(move);\n        }\n        // are there any other leftover moves?\n        if (moveString.length) {\n            moves.push(appendComment(moveString));\n        }\n        // is there a result? (there ALWAYS has to be a result according to spec; see Seven Tag Roster)\n        moves.push(this._header.Result || '*');\n        /*\n         * history should be back to what it was before we started generating PGN,\n         * so join together moves\n         */\n        if (maxWidth === 0) {\n            return result.join('') + moves.join(' ');\n        }\n        // TODO (jah): huh?\n        const strip = function () {\n            if (result.length > 0 && result[result.length - 1] === ' ') {\n                result.pop();\n                return true;\n            }\n            return false;\n        };\n        // NB: this does not preserve comment whitespace.\n        const wrapComment = function (width, move) {\n            for (const token of move.split(' ')) {\n                if (!token) {\n                    continue;\n                }\n                if (width + token.length > maxWidth) {\n                    while (strip()) {\n                        width--;\n                    }\n                    result.push(newline);\n                    width = 0;\n                }\n                result.push(token);\n                width += token.length;\n                result.push(' ');\n                width++;\n            }\n            if (strip()) {\n                width--;\n            }\n            return width;\n        };\n        // wrap the PGN output at max_width\n        let currentWidth = 0;\n        for (let i = 0; i < moves.length; i++) {\n            if (currentWidth + moves[i].length > maxWidth) {\n                if (moves[i].includes('{')) {\n                    currentWidth = wrapComment(currentWidth, moves[i]);\n                    continue;\n                }\n            }\n            // if the current move will push past max_width\n            if (currentWidth + moves[i].length > maxWidth && i !== 0) {\n                // don't end the line with whitespace\n                if (result[result.length - 1] === ' ') {\n                    result.pop();\n                }\n                result.push(newline);\n                currentWidth = 0;\n            }\n            else if (i !== 0) {\n                result.push(' ');\n                currentWidth++;\n            }\n            result.push(moves[i]);\n            currentWidth += moves[i].length;\n        }\n        return result.join('');\n    }\n    /**\n     * @deprecated Use `setHeader` and `getHeaders` instead. This method will return null header tags (which is not what you want)\n     */\n    header(...args) {\n        for (let i = 0; i < args.length; i += 2) {\n            if (typeof args[i] === 'string' && typeof args[i + 1] === 'string') {\n                this._header[args[i]] = args[i + 1];\n            }\n        }\n        return this._header;\n    }\n    // TODO: value validation per spec\n    setHeader(key, value) {\n        this._header[key] = value ?? SEVEN_TAG_ROSTER[key] ?? null;\n        return this.getHeaders();\n    }\n    removeHeader(key) {\n        if (key in this._header) {\n            this._header[key] = SEVEN_TAG_ROSTER[key] || null;\n            return true;\n        }\n        return false;\n    }\n    // return only non-null headers (omit placemarker nulls)\n    getHeaders() {\n        const nonNullHeaders = {};\n        for (const [key, value] of Object.entries(this._header)) {\n            if (value !== null) {\n                nonNullHeaders[key] = value;\n            }\n        }\n        return nonNullHeaders;\n    }\n    loadPgn(pgn, { strict = false, newlineChar = '\\r?\\n', } = {}) {\n        // If newlineChar is not the default, replace all instances with \\n\n        if (newlineChar !== '\\r?\\n') {\n            pgn = pgn.replace(new RegExp(newlineChar, 'g'), '\\n');\n        }\n        const parsedPgn = peg$parse(pgn);\n        // Put the board in the starting position\n        this.reset();\n        // parse PGN header\n        const headers = parsedPgn.headers;\n        let fen = '';\n        for (const key in headers) {\n            // check to see user is including fen (possibly with wrong tag case)\n            if (key.toLowerCase() === 'fen') {\n                fen = headers[key];\n            }\n            this.header(key, headers[key]);\n        }\n        /*\n         * the permissive parser should attempt to load a fen tag, even if it's the\n         * wrong case and doesn't include a corresponding [SetUp \"1\"] tag\n         */\n        if (!strict) {\n            if (fen) {\n                this.load(fen, { preserveHeaders: true });\n            }\n        }\n        else {\n            /*\n             * strict parser - load the starting position indicated by [Setup '1']\n             * and [FEN position]\n             */\n            if (headers['SetUp'] === '1') {\n                if (!('FEN' in headers)) {\n                    throw new Error('Invalid PGN: FEN tag must be supplied with SetUp tag');\n                }\n                // don't clear the headers when loading\n                this.load(headers['FEN'], { preserveHeaders: true });\n            }\n        }\n        let node = parsedPgn.root;\n        while (node) {\n            if (node.move) {\n                const move = this._moveFromSan(node.move, strict);\n                if (move == null) {\n                    throw new Error(`Invalid move in PGN: ${node.move}`);\n                }\n                else {\n                    this._makeMove(move);\n                    this._incPositionCount();\n                }\n            }\n            if (node.comment !== undefined) {\n                this._comments[this.fen()] = node.comment;\n            }\n            node = node.variations[0];\n        }\n        /*\n         * Per section 8.2.6 of the PGN spec, the Result tag pair must match match\n         * the termination marker. Only do this when headers are present, but the\n         * result tag is missing\n         */\n        const result = parsedPgn.result;\n        if (result &&\n            Object.keys(this._header).length &&\n            this._header['Result'] !== result) {\n            this.setHeader('Result', result);\n        }\n    }\n    /*\n     * Convert a move from 0x88 coordinates to Standard Algebraic Notation\n     * (SAN)\n     *\n     * @param {boolean} strict Use the strict SAN parser. It will throw errors\n     * on overly disambiguated moves (see below):\n     *\n     * r1bqkbnr/ppp2ppp/2n5/1B1pP3/4P3/8/PPPP2PP/RNBQK1NR b KQkq - 2 4\n     * 4. ... Nge7 is overly disambiguated because the knight on c6 is pinned\n     * 4. ... Ne7 is technically the valid SAN\n     */\n    _moveToSan(move, moves) {\n        let output = '';\n        if (move.flags & BITS.KSIDE_CASTLE) {\n            output = 'O-O';\n        }\n        else if (move.flags & BITS.QSIDE_CASTLE) {\n            output = 'O-O-O';\n        }\n        else if (move.flags & BITS.NULL_MOVE) {\n            return SAN_NULLMOVE;\n        }\n        else {\n            if (move.piece !== PAWN) {\n                const disambiguator = getDisambiguator(move, moves);\n                output += move.piece.toUpperCase() + disambiguator;\n            }\n            if (move.flags & (BITS.CAPTURE | BITS.EP_CAPTURE)) {\n                if (move.piece === PAWN) {\n                    output += algebraic(move.from)[0];\n                }\n                output += 'x';\n            }\n            output += algebraic(move.to);\n            if (move.promotion) {\n                output += '=' + move.promotion.toUpperCase();\n            }\n        }\n        this._makeMove(move);\n        if (this.isCheck()) {\n            if (this.isCheckmate()) {\n                output += '#';\n            }\n            else {\n                output += '+';\n            }\n        }\n        this._undoMove();\n        return output;\n    }\n    // convert a move from Standard Algebraic Notation (SAN) to 0x88 coordinates\n    _moveFromSan(move, strict = false) {\n        // strip off any move decorations: e.g Nf3+?! becomes Nf3\n        let cleanMove = strippedSan(move);\n        if (!strict) {\n            if (cleanMove === '0-0') {\n                cleanMove = 'O-O';\n            }\n            else if (cleanMove === '0-0-0') {\n                cleanMove = 'O-O-O';\n            }\n        }\n        //first implementation of null with a dummy move (black king moves from a8 to a8), maybe this can be implemented better\n        if (cleanMove == SAN_NULLMOVE) {\n            const res = {\n                color: this._turn,\n                from: 0,\n                to: 0,\n                piece: 'k',\n                flags: BITS.NULL_MOVE,\n            };\n            return res;\n        }\n        let pieceType = inferPieceType(cleanMove);\n        let moves = this._moves({ legal: true, piece: pieceType });\n        // strict parser\n        for (let i = 0, len = moves.length; i < len; i++) {\n            if (cleanMove === strippedSan(this._moveToSan(moves[i], moves))) {\n                return moves[i];\n            }\n        }\n        // the strict parser failed\n        if (strict) {\n            return null;\n        }\n        let piece = undefined;\n        let matches = undefined;\n        let from = undefined;\n        let to = undefined;\n        let promotion = undefined;\n        /*\n         * The default permissive (non-strict) parser allows the user to parse\n         * non-standard chess notations. This parser is only run after the strict\n         * Standard Algebraic Notation (SAN) parser has failed.\n         *\n         * When running the permissive parser, we'll run a regex to grab the piece, the\n         * to/from square, and an optional promotion piece. This regex will\n         * parse common non-standard notation like: Pe2-e4, Rc1c4, Qf3xf7,\n         * f7f8q, b1c3\n         *\n         * NOTE: Some positions and moves may be ambiguous when using the permissive\n         * parser. For example, in this position: 6k1/8/8/B7/8/8/8/BN4K1 w - - 0 1,\n         * the move b1c3 may be interpreted as Nc3 or B1c3 (a disambiguated bishop\n         * move). In these cases, the permissive parser will default to the most\n         * basic interpretation (which is b1c3 parsing to Nc3).\n         */\n        let overlyDisambiguated = false;\n        matches = cleanMove.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);\n        if (matches) {\n            piece = matches[1];\n            from = matches[2];\n            to = matches[3];\n            promotion = matches[4];\n            if (from.length == 1) {\n                overlyDisambiguated = true;\n            }\n        }\n        else {\n            /*\n             * The [a-h]?[1-8]? portion of the regex below handles moves that may be\n             * overly disambiguated (e.g. Nge7 is unnecessary and non-standard when\n             * there is one legal knight move to e7). In this case, the value of\n             * 'from' variable will be a rank or file, not a square.\n             */\n            matches = cleanMove.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/);\n            if (matches) {\n                piece = matches[1];\n                from = matches[2];\n                to = matches[3];\n                promotion = matches[4];\n                if (from.length == 1) {\n                    overlyDisambiguated = true;\n                }\n            }\n        }\n        pieceType = inferPieceType(cleanMove);\n        moves = this._moves({\n            legal: true,\n            piece: piece ? piece : pieceType,\n        });\n        if (!to) {\n            return null;\n        }\n        for (let i = 0, len = moves.length; i < len; i++) {\n            if (!from) {\n                // if there is no from square, it could be just 'x' missing from a capture\n                if (cleanMove ===\n                    strippedSan(this._moveToSan(moves[i], moves)).replace('x', '')) {\n                    return moves[i];\n                }\n                // hand-compare move properties with the results from our permissive regex\n            }\n            else if ((!piece || piece.toLowerCase() == moves[i].piece) &&\n                Ox88[from] == moves[i].from &&\n                Ox88[to] == moves[i].to &&\n                (!promotion || promotion.toLowerCase() == moves[i].promotion)) {\n                return moves[i];\n            }\n            else if (overlyDisambiguated) {\n                /*\n                 * SPECIAL CASE: we parsed a move string that may have an unneeded\n                 * rank/file disambiguator (e.g. Nge7).  The 'from' variable will\n                 */\n                const square = algebraic(moves[i].from);\n                if ((!piece || piece.toLowerCase() == moves[i].piece) &&\n                    Ox88[to] == moves[i].to &&\n                    (from == square[0] || from == square[1]) &&\n                    (!promotion || promotion.toLowerCase() == moves[i].promotion)) {\n                    return moves[i];\n                }\n            }\n        }\n        return null;\n    }\n    ascii() {\n        let s = '   +------------------------+\\n';\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            // display the rank\n            if (file(i) === 0) {\n                s += ' ' + '87654321'[rank(i)] + ' |';\n            }\n            if (this._board[i]) {\n                const piece = this._board[i].type;\n                const color = this._board[i].color;\n                const symbol = color === WHITE ? piece.toUpperCase() : piece.toLowerCase();\n                s += ' ' + symbol + ' ';\n            }\n            else {\n                s += ' . ';\n            }\n            if ((i + 1) & 0x88) {\n                s += '|\\n';\n                i += 8;\n            }\n        }\n        s += '   +------------------------+\\n';\n        s += '     a  b  c  d  e  f  g  h';\n        return s;\n    }\n    perft(depth) {\n        const moves = this._moves({ legal: false });\n        let nodes = 0;\n        const color = this._turn;\n        for (let i = 0, len = moves.length; i < len; i++) {\n            this._makeMove(moves[i]);\n            if (!this._isKingAttacked(color)) {\n                if (depth - 1 > 0) {\n                    nodes += this.perft(depth - 1);\n                }\n                else {\n                    nodes++;\n                }\n            }\n            this._undoMove();\n        }\n        return nodes;\n    }\n    setTurn(color) {\n        if (this._turn == color) {\n            return false;\n        }\n        this.move('--');\n        return true;\n    }\n    turn() {\n        return this._turn;\n    }\n    board() {\n        const output = [];\n        let row = [];\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            if (this._board[i] == null) {\n                row.push(null);\n            }\n            else {\n                row.push({\n                    square: algebraic(i),\n                    type: this._board[i].type,\n                    color: this._board[i].color,\n                });\n            }\n            if ((i + 1) & 0x88) {\n                output.push(row);\n                row = [];\n                i += 8;\n            }\n        }\n        return output;\n    }\n    squareColor(square) {\n        if (square in Ox88) {\n            const sq = Ox88[square];\n            return (rank(sq) + file(sq)) % 2 === 0 ? 'light' : 'dark';\n        }\n        return null;\n    }\n    history({ verbose = false } = {}) {\n        const reversedHistory = [];\n        const moveHistory = [];\n        while (this._history.length > 0) {\n            reversedHistory.push(this._undoMove());\n        }\n        while (true) {\n            const move = reversedHistory.pop();\n            if (!move) {\n                break;\n            }\n            if (verbose) {\n                moveHistory.push(new Move(this, move));\n            }\n            else {\n                moveHistory.push(this._moveToSan(move, this._moves()));\n            }\n            this._makeMove(move);\n        }\n        return moveHistory;\n    }\n    /*\n     * Keeps track of position occurrence counts for the purpose of repetition\n     * checking. Old positions are removed from the map if their counts are reduced to 0.\n     */\n    _getPositionCount(hash) {\n        return this._positionCount.get(hash) ?? 0;\n    }\n    _incPositionCount() {\n        this._positionCount.set(this._hash, (this._positionCount.get(this._hash) ?? 0) + 1);\n    }\n    _decPositionCount(hash) {\n        const currentCount = this._positionCount.get(hash) ?? 0;\n        if (currentCount === 1) {\n            this._positionCount.delete(hash);\n        }\n        else {\n            this._positionCount.set(hash, currentCount - 1);\n        }\n    }\n    _pruneComments() {\n        const reversedHistory = [];\n        const currentComments = {};\n        const copyComment = (fen) => {\n            if (fen in this._comments) {\n                currentComments[fen] = this._comments[fen];\n            }\n        };\n        while (this._history.length > 0) {\n            reversedHistory.push(this._undoMove());\n        }\n        copyComment(this.fen());\n        while (true) {\n            const move = reversedHistory.pop();\n            if (!move) {\n                break;\n            }\n            this._makeMove(move);\n            copyComment(this.fen());\n        }\n        this._comments = currentComments;\n    }\n    getComment() {\n        return this._comments[this.fen()];\n    }\n    setComment(comment) {\n        this._comments[this.fen()] = comment.replace('{', '[').replace('}', ']');\n    }\n    /**\n     * @deprecated Renamed to `removeComment` for consistency\n     */\n    deleteComment() {\n        return this.removeComment();\n    }\n    removeComment() {\n        const comment = this._comments[this.fen()];\n        delete this._comments[this.fen()];\n        return comment;\n    }\n    getComments() {\n        this._pruneComments();\n        return Object.keys(this._comments).map((fen) => {\n            return { fen: fen, comment: this._comments[fen] };\n        });\n    }\n    /**\n     * @deprecated Renamed to `removeComments` for consistency\n     */\n    deleteComments() {\n        return this.removeComments();\n    }\n    removeComments() {\n        this._pruneComments();\n        return Object.keys(this._comments).map((fen) => {\n            const comment = this._comments[fen];\n            delete this._comments[fen];\n            return { fen: fen, comment: comment };\n        });\n    }\n    setCastlingRights(color, rights) {\n        for (const side of [KING, QUEEN]) {\n            if (rights[side] !== undefined) {\n                if (rights[side]) {\n                    this._castling[color] |= SIDES[side];\n                }\n                else {\n                    this._castling[color] &= ~SIDES[side];\n                }\n            }\n        }\n        this._updateCastlingRights();\n        const result = this.getCastlingRights(color);\n        return ((rights[KING] === undefined || rights[KING] === result[KING]) &&\n            (rights[QUEEN] === undefined || rights[QUEEN] === result[QUEEN]));\n    }\n    getCastlingRights(color) {\n        return {\n            [KING]: (this._castling[color] & SIDES[KING]) !== 0,\n            [QUEEN]: (this._castling[color] & SIDES[QUEEN]) !== 0,\n        };\n    }\n    moveNumber() {\n        return this._moveNumber;\n    }\n}\n\nexport { BISHOP, BLACK, Chess, DEFAULT_POSITION, KING, KNIGHT, Move, PAWN, QUEEN, ROOK, SEVEN_TAG_ROSTER, SQUARES, WHITE, validateFen, xoroshiro128 };\n//# sourceMappingURL=chess.js.map\n","function assertNonEmptyString (str) {\n  if (typeof str !== 'string' || !str) {\n    throw new Error('expected a non-empty string, got: ' + str)\n  }\n}\n\nfunction assertNumber (number) {\n  if (typeof number !== 'number') {\n    throw new Error('expected a number, got: ' + number)\n  }\n}\n\nconst DB_VERSION_CURRENT = 1;\nconst DB_VERSION_INITIAL = 1;\nconst STORE_EMOJI = 'emoji';\nconst STORE_KEYVALUE = 'keyvalue';\nconst STORE_FAVORITES = 'favorites';\nconst FIELD_TOKENS = 'tokens';\nconst INDEX_TOKENS = 'tokens';\nconst FIELD_UNICODE = 'unicode';\nconst INDEX_COUNT = 'count';\nconst FIELD_GROUP = 'group';\nconst FIELD_ORDER = 'order';\nconst INDEX_GROUP_AND_ORDER = 'group-order';\nconst KEY_ETAG = 'eTag';\nconst KEY_URL = 'url';\nconst KEY_PREFERRED_SKINTONE = 'skinTone';\nconst MODE_READONLY = 'readonly';\nconst MODE_READWRITE = 'readwrite';\nconst INDEX_SKIN_UNICODE = 'skinUnicodes';\nconst FIELD_SKIN_UNICODE = 'skinUnicodes';\n\nconst DEFAULT_DATA_SOURCE = 'https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json';\nconst DEFAULT_LOCALE = 'en';\n\n// like lodash's uniqBy but much smaller\nfunction uniqBy (arr, func) {\n  const set = new Set();\n  const res = [];\n  for (const item of arr) {\n    const key = func(item);\n    if (!set.has(key)) {\n      set.add(key);\n      res.push(item);\n    }\n  }\n  return res\n}\n\nfunction uniqEmoji (emojis) {\n  return uniqBy(emojis, _ => _.unicode)\n}\n\nfunction initialMigration (db) {\n  function createObjectStore (name, keyPath, indexes) {\n    const store = keyPath\n      ? db.createObjectStore(name, { keyPath })\n      : db.createObjectStore(name);\n    if (indexes) {\n      for (const [indexName, [keyPath, multiEntry]] of Object.entries(indexes)) {\n        store.createIndex(indexName, keyPath, { multiEntry });\n      }\n    }\n    return store\n  }\n\n  createObjectStore(STORE_KEYVALUE);\n  createObjectStore(STORE_EMOJI, /* keyPath */ FIELD_UNICODE, {\n    [INDEX_TOKENS]: [FIELD_TOKENS, /* multiEntry */ true],\n    [INDEX_GROUP_AND_ORDER]: [[FIELD_GROUP, FIELD_ORDER]],\n    [INDEX_SKIN_UNICODE]: [FIELD_SKIN_UNICODE, /* multiEntry */ true]\n  });\n  createObjectStore(STORE_FAVORITES, undefined, {\n    [INDEX_COUNT]: ['']\n  });\n}\n\nconst openIndexedDBRequests = {};\nconst databaseCache = {};\nconst onCloseListeners = {};\n\nfunction handleOpenOrDeleteReq (resolve, reject, req) {\n  // These things are almost impossible to test with fakeIndexedDB sadly\n  /* istanbul ignore next */\n  req.onerror = () => reject(req.error);\n  /* istanbul ignore next */\n  req.onblocked = () => reject(new Error('IDB blocked'));\n  req.onsuccess = () => resolve(req.result);\n}\n\nasync function createDatabase (dbName) {\n  const db = await new Promise((resolve, reject) => {\n    const req = indexedDB.open(dbName, DB_VERSION_CURRENT);\n    openIndexedDBRequests[dbName] = req;\n    req.onupgradeneeded = e => {\n      // Technically there is only one version, so we don't need this `if` check\n      // But if an old version of the JS is in another browser tab\n      // and it gets upgraded in the future and we have a new DB version, well...\n      // better safe than sorry.\n      /* istanbul ignore else */\n      if (e.oldVersion < DB_VERSION_INITIAL) {\n        initialMigration(req.result);\n      }\n    };\n    handleOpenOrDeleteReq(resolve, reject, req);\n  });\n  // Handle abnormal closes, e.g. \"delete database\" in chrome dev tools.\n  // No need for removeEventListener, because once the DB can no longer\n  // fire \"close\" events, it will auto-GC.\n  db.onclose = () => closeDatabase(dbName);\n  return db\n}\n\nfunction openDatabase (dbName) {\n  if (!databaseCache[dbName]) {\n    databaseCache[dbName] = createDatabase(dbName);\n  }\n  return databaseCache[dbName]\n}\n\nfunction dbPromise (db, storeName, readOnlyOrReadWrite, cb) {\n  return new Promise((resolve, reject) => {\n    // Use relaxed durability because neither the emoji data nor the favorites/preferred skin tone\n    // are really irreplaceable data. IndexedDB is just a cache in this case.\n    const txn = db.transaction(storeName, readOnlyOrReadWrite, { durability: 'relaxed' });\n    const store = typeof storeName === 'string'\n      ? txn.objectStore(storeName)\n      : storeName.map(name => txn.objectStore(name));\n    let res;\n    cb(store, txn, (result) => {\n      res = result;\n    });\n\n    txn.oncomplete = () => resolve(res);\n    /* istanbul ignore next */\n    txn.onerror = () => reject(txn.error);\n  })\n}\n\nfunction closeDatabase (dbName) {\n  // close any open requests\n  const req = openIndexedDBRequests[dbName];\n  const db = req && req.result;\n  if (db) {\n    db.close();\n    const listeners = onCloseListeners[dbName];\n    /* istanbul ignore else */\n    if (listeners) {\n      for (const listener of listeners) {\n        listener();\n      }\n    }\n  }\n  delete openIndexedDBRequests[dbName];\n  delete databaseCache[dbName];\n  delete onCloseListeners[dbName];\n}\n\nfunction deleteDatabase (dbName) {\n  return new Promise((resolve, reject) => {\n    // close any open requests\n    closeDatabase(dbName);\n    const req = indexedDB.deleteDatabase(dbName);\n    handleOpenOrDeleteReq(resolve, reject, req);\n  })\n}\n\n// The \"close\" event occurs during an abnormal shutdown, e.g. a user clearing their browser data.\n// However, it doesn't occur with the normal \"close\" event, so we handle that separately.\n// https://www.w3.org/TR/IndexedDB/#close-a-database-connection\nfunction addOnCloseListener (dbName, listener) {\n  let listeners = onCloseListeners[dbName];\n  if (!listeners) {\n    listeners = onCloseListeners[dbName] = [];\n  }\n  listeners.push(listener);\n}\n\n// list of emoticons that don't match a simple \\W+ regex\n// extracted using:\n// require('emoji-picker-element-data/en/emojibase/data.json').map(_ => _.emoticon).filter(Boolean).filter(_ => !/^\\W+$/.test(_))\nconst irregularEmoticons = new Set([\n  ':D', 'XD', \":'D\", 'O:)',\n  ':X', ':P', ';P', 'XP',\n  ':L', ':Z', ':j', '8D',\n  'XO', '8)', ':B', ':O',\n  ':S', \":'o\", 'Dx', 'X(',\n  'D:', ':C', '>0)', ':3',\n  '</3', '<3', '\\\\M/', ':E',\n  '8#'\n]);\n\nfunction extractTokens (str) {\n  return str\n    .split(/[\\s_]+/)\n    .map(word => {\n      if (!word.match(/\\w/) || irregularEmoticons.has(word)) {\n        // for pure emoticons like :) or :-), just leave them as-is\n        return word.toLowerCase()\n      }\n\n      return word\n        .replace(/[)(:,]/g, '')\n        .replace(//g, \"'\")\n        .toLowerCase()\n    }).filter(Boolean)\n}\n\nconst MIN_SEARCH_TEXT_LENGTH = 2;\n\n// This is an extra step in addition to extractTokens(). The difference here is that we expect\n// the input to have already been run through extractTokens(). This is useful for cases like\n// emoticons, where we don't want to do any tokenization (because it makes no sense to split up\n// \">:)\" by the colon) but we do want to lowercase it to have consistent search results, so that\n// the user can type ':P' or ':p' and still get the same result.\nfunction normalizeTokens (str) {\n  return str\n    .filter(Boolean)\n    .map(_ => _.toLowerCase())\n    .filter(_ => _.length >= MIN_SEARCH_TEXT_LENGTH)\n}\n\n// Transform emoji data for storage in IDB\nfunction transformEmojiData (emojiData) {\n  const res = emojiData.map(({ annotation, emoticon, group, order, shortcodes, skins, tags, emoji, version }) => {\n    const tokens = [...new Set(\n      normalizeTokens([\n        ...(shortcodes || []).map(extractTokens).flat(),\n        ...(tags || []).map(extractTokens).flat(),\n        ...extractTokens(annotation),\n        emoticon\n      ])\n    )].sort();\n    const res = {\n      annotation,\n      group,\n      order,\n      tags,\n      tokens,\n      unicode: emoji,\n      version\n    };\n    if (emoticon) {\n      res.emoticon = emoticon;\n    }\n    if (shortcodes) {\n      res.shortcodes = shortcodes;\n    }\n    if (skins) {\n      res.skinTones = [];\n      res.skinUnicodes = [];\n      res.skinVersions = [];\n      for (const { tone, emoji, version } of skins) {\n        res.skinTones.push(tone);\n        res.skinUnicodes.push(emoji);\n        res.skinVersions.push(version);\n      }\n    }\n    return res\n  });\n  return res\n}\n\n// helper functions that help compress the code better\n\nfunction callStore (store, method, key, cb) {\n  store[method](key).onsuccess = e => (cb && cb(e.target.result));\n}\n\nfunction getIDB (store, key, cb) {\n  callStore(store, 'get', key, cb);\n}\n\nfunction getAllIDB (store, key, cb) {\n  callStore(store, 'getAll', key, cb);\n}\n\nfunction commit (txn) {\n  /* istanbul ignore else */\n  if (txn.commit) {\n    txn.commit();\n  }\n}\n\n// like lodash's minBy\nfunction minBy (array, func) {\n  let minItem = array[0];\n  for (let i = 1; i < array.length; i++) {\n    const item = array[i];\n    if (func(minItem) > func(item)) {\n      minItem = item;\n    }\n  }\n  return minItem\n}\n\n// return an array of results representing all items that are found in each one of the arrays\n//\n\nfunction findCommonMembers (arrays, uniqByFunc) {\n  const shortestArray = minBy(arrays, _ => _.length);\n  const results = [];\n  for (const item of shortestArray) {\n    // if this item is included in every array in the intermediate results, add it to the final results\n    if (!arrays.some(array => array.findIndex(_ => uniqByFunc(_) === uniqByFunc(item)) === -1)) {\n      results.push(item);\n    }\n  }\n  return results\n}\n\nasync function isEmpty (db) {\n  return !(await get(db, STORE_KEYVALUE, KEY_URL))\n}\n\nasync function hasData (db, url, eTag) {\n  const [oldETag, oldUrl] = await Promise.all([KEY_ETAG, KEY_URL]\n    .map(key => get(db, STORE_KEYVALUE, key)));\n  return (oldETag === eTag && oldUrl === url)\n}\n\nasync function doFullDatabaseScanForSingleResult (db, predicate) {\n  // This batching algorithm is just a perf improvement over a basic\n  // cursor. The BATCH_SIZE is an estimate of what would give the best\n  // perf for doing a full DB scan (worst case).\n  //\n  // Mini-benchmark for determining the best batch size:\n  //\n  // PERF=1 pnpm build:rollup && pnpm test:adhoc\n  //\n  // (async () => {\n  //   performance.mark('start')\n  //   await $('emoji-picker').database.getEmojiByShortcode('doesnotexist')\n  //   performance.measure('total', 'start')\n  //   console.log(performance.getEntriesByName('total').slice(-1)[0].duration)\n  // })()\n  const BATCH_SIZE = 50; // Typically around 150ms for 6x slowdown in Chrome for above benchmark\n  return dbPromise(db, STORE_EMOJI, MODE_READONLY, (emojiStore, txn, cb) => {\n    let lastKey;\n\n    const processNextBatch = () => {\n      emojiStore.getAll(lastKey && IDBKeyRange.lowerBound(lastKey, true), BATCH_SIZE).onsuccess = e => {\n        const results = e.target.result;\n        for (const result of results) {\n          lastKey = result.unicode;\n          if (predicate(result)) {\n            return cb(result)\n          }\n        }\n        if (results.length < BATCH_SIZE) {\n          return cb()\n        }\n        processNextBatch();\n      };\n    };\n    processNextBatch();\n  })\n}\n\nasync function loadData (db, emojiData, url, eTag) {\n  try {\n    const transformedData = transformEmojiData(emojiData);\n    await dbPromise(db, [STORE_EMOJI, STORE_KEYVALUE], MODE_READWRITE, ([emojiStore, metaStore], txn) => {\n      let oldETag;\n      let oldUrl;\n      let todo = 0;\n\n      function checkFetched () {\n        if (++todo === 2) { // 2 requests made\n          onFetched();\n        }\n      }\n\n      function onFetched () {\n        if (oldETag === eTag && oldUrl === url) {\n          // check again within the transaction to guard against concurrency, e.g. multiple browser tabs\n          return\n        }\n        // delete old data\n        emojiStore.clear();\n        // insert new data\n        for (const data of transformedData) {\n          emojiStore.put(data);\n        }\n        metaStore.put(eTag, KEY_ETAG);\n        metaStore.put(url, KEY_URL);\n        commit(txn);\n      }\n\n      getIDB(metaStore, KEY_ETAG, result => {\n        oldETag = result;\n        checkFetched();\n      });\n\n      getIDB(metaStore, KEY_URL, result => {\n        oldUrl = result;\n        checkFetched();\n      });\n    });\n  } finally {\n  }\n}\n\nasync function getEmojiByGroup (db, group) {\n  return dbPromise(db, STORE_EMOJI, MODE_READONLY, (emojiStore, txn, cb) => {\n    const range = IDBKeyRange.bound([group, 0], [group + 1, 0], false, true);\n    getAllIDB(emojiStore.index(INDEX_GROUP_AND_ORDER), range, cb);\n  })\n}\n\nasync function getEmojiBySearchQuery (db, query) {\n  const tokens = normalizeTokens(extractTokens(query));\n\n  if (!tokens.length) {\n    return []\n  }\n\n  return dbPromise(db, STORE_EMOJI, MODE_READONLY, (emojiStore, txn, cb) => {\n    // get all results that contain all tokens (i.e. an AND query)\n    const intermediateResults = [];\n\n    const checkDone = () => {\n      if (intermediateResults.length === tokens.length) {\n        onDone();\n      }\n    };\n\n    const onDone = () => {\n      const results = findCommonMembers(intermediateResults, _ => _.unicode);\n      cb(results.sort((a, b) => a.order < b.order ? -1 : 1));\n    };\n\n    for (let i = 0; i < tokens.length; i++) {\n      const token = tokens[i];\n      const range = i === tokens.length - 1\n        ? IDBKeyRange.bound(token, token + '\\uffff', false, true) // treat last token as a prefix search\n        : IDBKeyRange.only(token); // treat all other tokens as an exact match\n      getAllIDB(emojiStore.index(INDEX_TOKENS), range, result => {\n        intermediateResults.push(result);\n        checkDone();\n      });\n    }\n  })\n}\n\n// This could have been implemented as an IDB index on shortcodes, but it seemed wasteful to do that\n// when we can already query by tokens and this will give us what we're looking for 99.9% of the time\nasync function getEmojiByShortcode (db, shortcode) {\n  const emojis = await getEmojiBySearchQuery(db, shortcode);\n\n  // In very rare cases (e.g. the shortcode \"v\" as in \"v for victory\"), we cannot search because\n  // there are no usable tokens (too short in this case). In that case, we have to do an inefficient\n  // full-database scan, which I believe is an acceptable tradeoff for not having to have an extra\n  // index on shortcodes.\n\n  if (!emojis.length) {\n    const predicate = _ => ((_.shortcodes || []).includes(shortcode.toLowerCase()));\n    return (await doFullDatabaseScanForSingleResult(db, predicate)) || null\n  }\n\n  return emojis.filter(_ => {\n    const lowerShortcodes = (_.shortcodes || []).map(_ => _.toLowerCase());\n    return lowerShortcodes.includes(shortcode.toLowerCase())\n  })[0] || null\n}\n\nasync function getEmojiByUnicode (db, unicode) {\n  return dbPromise(db, STORE_EMOJI, MODE_READONLY, (emojiStore, txn, cb) => (\n    getIDB(emojiStore, unicode, result => {\n      if (result) {\n        return cb(result)\n      }\n      getIDB(emojiStore.index(INDEX_SKIN_UNICODE), unicode, result => cb(result || null));\n    })\n  ))\n}\n\nfunction get (db, storeName, key) {\n  return dbPromise(db, storeName, MODE_READONLY, (store, txn, cb) => (\n    getIDB(store, key, cb)\n  ))\n}\n\nfunction set (db, storeName, key, value) {\n  return dbPromise(db, storeName, MODE_READWRITE, (store, txn) => {\n    store.put(value, key);\n    commit(txn);\n  })\n}\n\nfunction incrementFavoriteEmojiCount (db, unicode) {\n  return dbPromise(db, STORE_FAVORITES, MODE_READWRITE, (store, txn) => (\n    getIDB(store, unicode, result => {\n      store.put((result || 0) + 1, unicode);\n      commit(txn);\n    })\n  ))\n}\n\nfunction getTopFavoriteEmoji (db, customEmojiIndex, limit) {\n  if (limit === 0) {\n    return []\n  }\n  return dbPromise(db, [STORE_FAVORITES, STORE_EMOJI], MODE_READONLY, ([favoritesStore, emojiStore], txn, cb) => {\n    const results = [];\n    favoritesStore.index(INDEX_COUNT).openCursor(undefined, 'prev').onsuccess = e => {\n      const cursor = e.target.result;\n      if (!cursor) { // no more results\n        return cb(results)\n      }\n\n      function addResult (result) {\n        results.push(result);\n        if (results.length === limit) {\n          return cb(results) // done, reached the limit\n        }\n        cursor.continue();\n      }\n\n      const unicodeOrName = cursor.primaryKey;\n      const custom = customEmojiIndex.byName(unicodeOrName);\n      if (custom) {\n        return addResult(custom)\n      }\n      // This could be done in parallel (i.e. make the cursor and the get()s parallelized),\n      // but my testing suggests it's not actually faster.\n      getIDB(emojiStore, unicodeOrName, emoji => {\n        if (emoji) {\n          return addResult(emoji)\n        }\n        // emoji not found somehow, ignore (may happen if custom emoji change)\n        cursor.continue();\n      });\n    };\n  })\n}\n\n// trie data structure for prefix searches\n// loosely based on https://github.com/nolanlawson/substring-trie\n\nconst CODA_MARKER = ''; // marks the end of the string\n\nfunction trie (arr, itemToTokens) {\n  const map = new Map();\n  for (const item of arr) {\n    const tokens = itemToTokens(item);\n    for (const token of tokens) {\n      let currentMap = map;\n      for (let i = 0; i < token.length; i++) {\n        const char = token.charAt(i);\n        let nextMap = currentMap.get(char);\n        if (!nextMap) {\n          nextMap = new Map();\n          currentMap.set(char, nextMap);\n        }\n        currentMap = nextMap;\n      }\n      let valuesAtCoda = currentMap.get(CODA_MARKER);\n      if (!valuesAtCoda) {\n        valuesAtCoda = [];\n        currentMap.set(CODA_MARKER, valuesAtCoda);\n      }\n      valuesAtCoda.push(item);\n    }\n  }\n\n  const search = (query, exact) => {\n    let currentMap = map;\n    for (let i = 0; i < query.length; i++) {\n      const char = query.charAt(i);\n      const nextMap = currentMap.get(char);\n      if (nextMap) {\n        currentMap = nextMap;\n      } else {\n        return []\n      }\n    }\n\n    if (exact) {\n      const results = currentMap.get(CODA_MARKER);\n      return results || []\n    }\n\n    const results = [];\n    // traverse\n    const queue = [currentMap];\n    while (queue.length) {\n      const currentMap = queue.shift();\n      const entriesSortedByKey = [...currentMap.entries()].sort((a, b) => a[0] < b[0] ? -1 : 1);\n      for (const [key, value] of entriesSortedByKey) {\n        if (key === CODA_MARKER) { // CODA_MARKER always comes first; it's the empty string\n          results.push(...value);\n        } else {\n          queue.push(value);\n        }\n      }\n    }\n    return results\n  };\n\n  return search\n}\n\nconst requiredKeys$1 = [\n  'name',\n  'url'\n];\n\nfunction assertCustomEmojis (customEmojis) {\n  const isArray = customEmojis && Array.isArray(customEmojis);\n  const firstItemIsFaulty = isArray &&\n    customEmojis.length &&\n    (!customEmojis[0] || requiredKeys$1.some(key => !(key in customEmojis[0])));\n  if (!isArray || firstItemIsFaulty) {\n    throw new Error('Custom emojis are in the wrong format')\n  }\n}\n\nfunction customEmojiIndex (customEmojis) {\n  assertCustomEmojis(customEmojis);\n\n  const sortByName = (a, b) => a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 1;\n\n  //\n  // all()\n  //\n  const all = customEmojis.sort(sortByName);\n\n  //\n  // search()\n  //\n  const emojiToTokens = emoji => {\n    const set = new Set();\n    if (emoji.shortcodes) {\n      for (const shortcode of emoji.shortcodes) {\n        for (const token of extractTokens(shortcode)) {\n          set.add(token);\n        }\n      }\n    }\n    return set\n  };\n  const searchTrie = trie(customEmojis, emojiToTokens);\n  const searchByExactMatch = _ => searchTrie(_, true);\n  const searchByPrefix = _ => searchTrie(_, false);\n\n  // Search by query for custom emoji. Similar to how we do this in IDB, the last token\n  // is treated as a prefix search, but every other one is treated as an exact match.\n  // Then we AND the results together\n  const search = query => {\n    const tokens = extractTokens(query);\n    const intermediateResults = tokens.map((token, i) => (\n      (i < tokens.length - 1 ? searchByExactMatch : searchByPrefix)(token)\n    ));\n    return findCommonMembers(intermediateResults, _ => _.name).sort(sortByName)\n  };\n\n  //\n  // byShortcode, byName\n  //\n  const shortcodeToEmoji = new Map();\n  const nameToEmoji = new Map();\n  for (const customEmoji of customEmojis) {\n    nameToEmoji.set(customEmoji.name.toLowerCase(), customEmoji);\n    for (const shortcode of (customEmoji.shortcodes || [])) {\n      shortcodeToEmoji.set(shortcode.toLowerCase(), customEmoji);\n    }\n  }\n\n  const byShortcode = shortcode => shortcodeToEmoji.get(shortcode.toLowerCase());\n  const byName = name => nameToEmoji.get(name.toLowerCase());\n\n  return {\n    all,\n    search,\n    byShortcode,\n    byName\n  }\n}\n\nconst isFirefoxContentScript = typeof wrappedJSObject !== 'undefined';\n\n// remove some internal implementation details, i.e. the \"tokens\" array on the emoji object\n// essentially, convert the emoji from the version stored in IDB to the version used in-memory\nfunction cleanEmoji (emoji) {\n  if (!emoji) {\n    return emoji\n  }\n  // if inside a Firefox content script, need to clone the emoji object to prevent Firefox from complaining about\n  // cross-origin object. See: https://github.com/nolanlawson/emoji-picker-element/issues/356\n  /* istanbul ignore if */\n  if (isFirefoxContentScript) {\n    emoji = structuredClone(emoji);\n  }\n  delete emoji.tokens;\n  if (emoji.skinTones) {\n    const len = emoji.skinTones.length;\n    emoji.skins = Array(len);\n    for (let i = 0; i < len; i++) {\n      emoji.skins[i] = {\n        tone: emoji.skinTones[i],\n        unicode: emoji.skinUnicodes[i],\n        version: emoji.skinVersions[i]\n      };\n    }\n    delete emoji.skinTones;\n    delete emoji.skinUnicodes;\n    delete emoji.skinVersions;\n  }\n  return emoji\n}\n\nfunction warnETag (eTag) {\n  if (!eTag) {\n    console.warn('emoji-picker-element is more efficient if the dataSource server exposes an ETag header.');\n  }\n}\n\nconst requiredKeys = [\n  'annotation',\n  'emoji',\n  'group',\n  'order',\n  'version'\n];\n\nfunction assertEmojiData (emojiData) {\n  if (!emojiData ||\n    !Array.isArray(emojiData) ||\n    !emojiData[0] ||\n    (typeof emojiData[0] !== 'object') ||\n    requiredKeys.some(key => (!(key in emojiData[0])))) {\n    throw new Error('Emoji data is in the wrong format')\n  }\n}\n\nfunction assertStatus (response, dataSource) {\n  if (Math.floor(response.status / 100) !== 2) {\n    throw new Error('Failed to fetch: ' + dataSource + ':  ' + response.status)\n  }\n}\n\nasync function getETag (dataSource) {\n  const response = await fetch(dataSource, { method: 'HEAD' });\n  assertStatus(response, dataSource);\n  const eTag = response.headers.get('etag');\n  warnETag(eTag);\n  return eTag\n}\n\nasync function getETagAndData (dataSource) {\n  const response = await fetch(dataSource);\n  assertStatus(response, dataSource);\n  const eTag = response.headers.get('etag');\n  warnETag(eTag);\n  const emojiData = await response.json();\n  assertEmojiData(emojiData);\n  return [eTag, emojiData]\n}\n\n// TODO: including these in blob-util.ts causes typedoc to generate docs for them,\n// even with --excludePrivate \\_()_/\n/** @private */\n/**\n * Convert an `ArrayBuffer` to a binary string.\n *\n * Example:\n *\n * ```js\n * var myString = blobUtil.arrayBufferToBinaryString(arrayBuff)\n * ```\n *\n * @param buffer - array buffer\n * @returns binary string\n */\nfunction arrayBufferToBinaryString(buffer) {\n    var binary = '';\n    var bytes = new Uint8Array(buffer);\n    var length = bytes.byteLength;\n    var i = -1;\n    while (++i < length) {\n        binary += String.fromCharCode(bytes[i]);\n    }\n    return binary;\n}\n/**\n * Convert a binary string to an `ArrayBuffer`.\n *\n * ```js\n * var myBuffer = blobUtil.binaryStringToArrayBuffer(binaryString)\n * ```\n *\n * @param binary - binary string\n * @returns array buffer\n */\nfunction binaryStringToArrayBuffer(binary) {\n    var length = binary.length;\n    var buf = new ArrayBuffer(length);\n    var arr = new Uint8Array(buf);\n    var i = -1;\n    while (++i < length) {\n        arr[i] = binary.charCodeAt(i);\n    }\n    return buf;\n}\n\n// generate a checksum based on the stringified JSON\nasync function jsonChecksum (object) {\n  const inString = JSON.stringify(object);\n  let inBuffer = binaryStringToArrayBuffer(inString);\n\n  // this does not need to be cryptographically secure, SHA-1 is fine\n  const outBuffer = await crypto.subtle.digest('SHA-1', inBuffer);\n  const outBinString = arrayBufferToBinaryString(outBuffer);\n  const res = btoa(outBinString);\n  return res\n}\n\nasync function doCheckForUpdates (db, dataSource) {\n  // just do a simple HEAD request first to see if the eTags match\n  let emojiData;\n  let eTag = await getETag(dataSource);\n  if (!eTag) { // work around lack of ETag/Access-Control-Expose-Headers\n    const eTagAndData = await getETagAndData(dataSource);\n    eTag = eTagAndData[0];\n    emojiData = eTagAndData[1];\n    if (!eTag) {\n      eTag = await jsonChecksum(emojiData);\n    }\n  }\n  if (await hasData(db, dataSource, eTag)) ; else {\n    if (!emojiData) {\n      const eTagAndData = await getETagAndData(dataSource);\n      emojiData = eTagAndData[1];\n    }\n    await loadData(db, emojiData, dataSource, eTag);\n  }\n}\n\nasync function loadDataForFirstTime (db, dataSource) {\n  let [eTag, emojiData] = await getETagAndData(dataSource);\n  if (!eTag) {\n    // Handle lack of support for ETag or Access-Control-Expose-Headers\n    // https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers#Browser_compatibility\n    eTag = await jsonChecksum(emojiData);\n  }\n\n  await loadData(db, emojiData, dataSource, eTag);\n}\n\nasync function checkForUpdates (db, dataSource) {\n  try {\n    await doCheckForUpdates(db, dataSource);\n  } catch (err) {\n    // Checking for updates is not a critical operation, and it can fail if e.g. the picker is quickly removed and\n    // re-added to the DOM. In those cases, we may get an IndexedDB InvalidStateError because we are attempting to close\n    // the database connection, possibly while another request is inflight. So there's effectively no way to prevent\n    // InvalidStateErrors unless we were to carefully sequence our IndexedDB operations. Much more simply, we can just\n    // ignore IndexedDB InvalidStateErrors here and give users one less useless error message in their console.\n    if (err.name !== 'InvalidStateError') {\n      throw err\n    }\n  }\n}\n\nclass Database {\n  constructor ({ dataSource = DEFAULT_DATA_SOURCE, locale = DEFAULT_LOCALE, customEmoji = [] } = {}) {\n    this.dataSource = dataSource;\n    this.locale = locale;\n    this._dbName = `emoji-picker-element-${this.locale}`;\n    this._db = undefined;\n    this._lazyUpdate = undefined;\n    this._custom = customEmojiIndex(customEmoji);\n\n    this._clear = this._clear.bind(this);\n    this._ready = this._init();\n  }\n\n  async _init () {\n    const db = this._db = await openDatabase(this._dbName);\n\n    addOnCloseListener(this._dbName, this._clear);\n    const dataSource = this.dataSource;\n    const empty = await isEmpty(db);\n\n    if (empty) {\n      await loadDataForFirstTime(db, dataSource);\n    } else { // offline-first - do an update asynchronously\n      this._lazyUpdate = checkForUpdates(db, dataSource);\n    }\n  }\n\n  async ready () {\n    const checkReady = async () => {\n      if (!this._ready) {\n        this._ready = this._init();\n      }\n      return this._ready\n    };\n    await checkReady();\n    // There's a possibility of a race condition where the element gets added, removed, and then added again\n    // with a particular timing, which would set the _db to undefined.\n    // We *could* do a while loop here, but that seems excessive and could lead to an infinite loop.\n    if (!this._db) {\n      await checkReady();\n    }\n  }\n\n  async getEmojiByGroup (group) {\n    assertNumber(group);\n    await this.ready();\n    return uniqEmoji(await getEmojiByGroup(this._db, group)).map(cleanEmoji)\n  }\n\n  async getEmojiBySearchQuery (query) {\n    assertNonEmptyString(query);\n    await this.ready();\n    const customs = this._custom.search(query);\n    const natives = uniqEmoji(await getEmojiBySearchQuery(this._db, query)).map(cleanEmoji);\n    return [\n      ...customs,\n      ...natives\n    ]\n  }\n\n  async getEmojiByShortcode (shortcode) {\n    assertNonEmptyString(shortcode);\n    await this.ready();\n    const custom = this._custom.byShortcode(shortcode);\n    if (custom) {\n      return custom\n    }\n    return cleanEmoji(await getEmojiByShortcode(this._db, shortcode))\n  }\n\n  async getEmojiByUnicodeOrName (unicodeOrName) {\n    assertNonEmptyString(unicodeOrName);\n    await this.ready();\n    const custom = this._custom.byName(unicodeOrName);\n    if (custom) {\n      return custom\n    }\n    return cleanEmoji(await getEmojiByUnicode(this._db, unicodeOrName))\n  }\n\n  async getPreferredSkinTone () {\n    await this.ready();\n    return (await get(this._db, STORE_KEYVALUE, KEY_PREFERRED_SKINTONE)) || 0\n  }\n\n  async setPreferredSkinTone (skinTone) {\n    assertNumber(skinTone);\n    await this.ready();\n    return set(this._db, STORE_KEYVALUE, KEY_PREFERRED_SKINTONE, skinTone)\n  }\n\n  async incrementFavoriteEmojiCount (unicodeOrName) {\n    assertNonEmptyString(unicodeOrName);\n    await this.ready();\n    return incrementFavoriteEmojiCount(this._db, unicodeOrName)\n  }\n\n  async getTopFavoriteEmoji (limit) {\n    assertNumber(limit);\n    await this.ready();\n    return (await getTopFavoriteEmoji(this._db, this._custom, limit)).map(cleanEmoji)\n  }\n\n  set customEmoji (customEmojis) {\n    this._custom = customEmojiIndex(customEmojis);\n  }\n\n  get customEmoji () {\n    return this._custom.all\n  }\n\n  async _shutdown () {\n    await this.ready(); // reopen if we've already been closed/deleted\n    try {\n      await this._lazyUpdate; // allow any lazy updates to process before closing/deleting\n    } catch (err) { /* ignore network errors (offline-first) */ }\n  }\n\n  // clear references to IDB, e.g. during a close event\n  _clear () {\n    // We don't need to call removeEventListener or remove the manual \"close\" listeners.\n    // The memory leak tests prove this is unnecessary. It's because:\n    // 1) IDBDatabases that can no longer fire \"close\" automatically have listeners GCed\n    // 2) we clear the manual close listeners in databaseLifecycle.js.\n    this._db = this._ready = this._lazyUpdate = undefined;\n  }\n\n  async close () {\n    await this._shutdown();\n    await closeDatabase(this._dbName);\n  }\n\n  async delete () {\n    await this._shutdown();\n    await deleteDatabase(this._dbName);\n  }\n}\n\nexport { Database as default };\n","import Database from './database.js';\n\n// via https://unpkg.com/browse/emojibase-data@6.0.0/meta/groups.json\nconst allGroups = [\n  [-1, '', 'custom'],\n  [0, '', 'smileys-emotion'],\n  [1, '', 'people-body'],\n  [3, '', 'animals-nature'],\n  [4, '', 'food-drink'],\n  [5, '', 'travel-places'],\n  [6, '', 'activities'],\n  [7, '', 'objects'],\n  [8, '', 'symbols'],\n  [9, '', 'flags']\n].map(([id, emoji, name]) => ({ id, emoji, name }));\n\nconst groups = allGroups.slice(1);\n\nconst MIN_SEARCH_TEXT_LENGTH = 2;\nconst NUM_SKIN_TONES = 6;\n\n/* istanbul ignore next */\nconst rIC = typeof requestIdleCallback === 'function' ? requestIdleCallback : setTimeout;\n\n// check for ZWJ (zero width joiner) character\nfunction hasZwj (emoji) {\n  return emoji.unicode.includes('\\u200d')\n}\n\n// Find one good representative emoji from each version to test by checking its color.\n// Ideally it should have color in the center. For some inspiration, see:\n// https://about.gitlab.com/blog/2018/05/30/journey-in-native-unicode-emoji/\n//\n// Note that for certain versions (12.1, 13.1), there is no point in testing them explicitly, because\n// all the emoji from this version are compound-emoji from previous versions. So they would pass a color\n// test, even in browsers that display them as double emoji. (E.g. \"face in clouds\" might render as\n// \"face without mouth\" plus \"fog\".) These emoji can only be filtered using the width test,\n// which happens in checkZwjSupport.js.\nconst versionsAndTestEmoji = {\n  '': 17, // distorted face\n  '': 16, // face with bags under eyes\n  '': 15.1, // shaking head, technically from v15 but see note above\n  '': 14,\n  '': 13.1, // smiling face with tear, technically from v13 but see note above\n  '': 12.1, // sari, technically from v12 but see note above\n  '': 11,\n  '': 5,\n  '': 4,\n  '': 3,\n  '': 2,\n  '': 1,\n  '': 0.7,\n  '': 0.6\n};\n\nconst TIMEOUT_BEFORE_LOADING_MESSAGE = 1000; // 1 second\nconst DEFAULT_SKIN_TONE_EMOJI = '';\nconst DEFAULT_NUM_COLUMNS = 8;\n\n// Based on https://fivethirtyeight.com/features/the-100-most-used-emojis/ and\n// https://blog.emojipedia.org/facebook-reveals-most-and-least-used-emojis/ with\n// a bit of my own curation. (E.g. avoid the \"OK\" gesture because of connotations:\n// https://emojipedia.org/ok-hand/)\nconst MOST_COMMONLY_USED_EMOJI = [\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  '',\n  ''\n];\n\n// It's important to list Twemoji Mozilla before everything else, because Mozilla bundles their\n// own font on some platforms (notably Windows and Linux as of this writing). Typically, Mozilla\n// updates faster than the underlying OS, and we don't want to render older emoji in one font and\n// newer emoji in another font:\n// https://github.com/nolanlawson/emoji-picker-element/pull/268#issuecomment-1073347283\nconst FONT_FAMILY = '\"Twemoji Mozilla\",\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",' +\n  '\"Noto Color Emoji\",\"EmojiOne Color\",\"Android Emoji\",sans-serif';\n\n/* istanbul ignore next */\nconst DEFAULT_CATEGORY_SORTING = (a, b) => a < b ? -1 : a > b ? 1 : 0;\n\n// Test if an emoji is supported by rendering it to canvas and checking that the color is not black\n// See https://about.gitlab.com/blog/2018/05/30/journey-in-native-unicode-emoji/\n// and https://www.npmjs.com/package/if-emoji for inspiration\n// This implementation is largely borrowed from if-emoji, adding the font-family\n\n\nconst getTextFeature = (text, color) => {\n  const canvas = document.createElement('canvas');\n  canvas.width = canvas.height = 1;\n\n  const ctx = canvas.getContext('2d', {\n    // Improves the performance of `getImageData()`\n    // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/getContextAttributes#willreadfrequently\n    willReadFrequently: true\n  });\n  ctx.textBaseline = 'top';\n  ctx.font = `100px ${FONT_FAMILY}`;\n  ctx.fillStyle = color;\n  ctx.scale(0.01, 0.01);\n  ctx.fillText(text, 0, 0);\n\n  return ctx.getImageData(0, 0, 1, 1).data\n};\n\nconst compareFeatures = (feature1, feature2) => {\n  const feature1Str = [...feature1].join(',');\n  const feature2Str = [...feature2].join(',');\n  // This is RGBA, so for 0,0,0, we are checking that the first RGB is not all zeroes.\n  // Most of the time when unsupported this is 0,0,0,0, but on Chrome on Mac it is\n  // 0,0,0,61 - there is a transparency here.\n  return feature1Str === feature2Str && !feature1Str.startsWith('0,0,0,')\n};\n\nfunction testColorEmojiSupported (text) {\n  // Render white and black and then compare them to each other and ensure they're the same\n  // color, and neither one is black. This shows that the emoji was rendered in color.\n  const feature1 = getTextFeature(text, '#000');\n  const feature2 = getTextFeature(text, '#fff');\n  return feature1 && feature2 && compareFeatures(feature1, feature2)\n}\n\n// rather than check every emoji ever, which would be expensive, just check some representatives from the\n// different emoji releases to determine what the font supports\n\nfunction determineEmojiSupportLevel () {\n  const entries = Object.entries(versionsAndTestEmoji);\n  try {\n    // start with latest emoji and work backwards\n    for (const [emoji, version] of entries) {\n      if (testColorEmojiSupported(emoji)) {\n        return version\n      }\n    }\n  } catch (e) { // canvas error\n  } finally {\n  }\n  // In case of an error, be generous and just assume all emoji are supported (e.g. for canvas errors\n  // due to anti-fingerprinting add-ons). Better to show some gray boxes than nothing at all.\n  return entries[0][1] // first one in the list is the most recent version\n}\n\n// Check which emojis we know for sure aren't supported, based on Unicode version level\nlet promise;\nconst detectEmojiSupportLevel = () => {\n  if (!promise) {\n    // Delay so it can run while the IDB database is being created by the browser (on another thread).\n    // This helps especially with first load  we want to start pre-populating the database on the main thread,\n    // and then wait for IDB to commit everything, and while waiting we run this check.\n    promise = new Promise(resolve => (\n      rIC(() => (\n        resolve(determineEmojiSupportLevel()) // delay so ideally this can run while IDB is first populating\n      ))\n    ));\n  }\n  return promise\n};\n// determine which emojis containing ZWJ (zero width joiner) characters\n// are supported (rendered as one glyph) rather than unsupported (rendered as two or more glyphs)\nconst supportedZwjEmojis = new Map();\n\nconst VARIATION_SELECTOR = '\\ufe0f';\nconst SKINTONE_MODIFIER = '\\ud83c';\nconst ZWJ = '\\u200d';\nconst LIGHT_SKIN_TONE = 0x1F3FB;\nconst LIGHT_SKIN_TONE_MODIFIER = 0xdffb;\n\n// TODO: this is a naive implementation, we can improve it later\n// It's only used for the skintone picker, so as long as people don't customize with\n// really exotic emoji then it should work fine\nfunction applySkinTone (str, skinTone) {\n  if (skinTone === 0) {\n    return str\n  }\n  const zwjIndex = str.indexOf(ZWJ);\n  if (zwjIndex !== -1) {\n    return str.substring(0, zwjIndex) +\n      String.fromCodePoint(LIGHT_SKIN_TONE + skinTone - 1) +\n      str.substring(zwjIndex)\n  }\n  if (str.endsWith(VARIATION_SELECTOR)) {\n    str = str.substring(0, str.length - 1);\n  }\n  return str + SKINTONE_MODIFIER + String.fromCodePoint(LIGHT_SKIN_TONE_MODIFIER + skinTone - 1)\n}\n\nfunction halt (event) {\n  event.preventDefault();\n  event.stopPropagation();\n}\n\n// Implementation left/right or up/down navigation, circling back when you\n// reach the start/end of the list\nfunction incrementOrDecrement (decrement, val, arr) {\n  val += (decrement ? -1 : 1);\n  if (val < 0) {\n    val = arr.length - 1;\n  } else if (val >= arr.length) {\n    val = 0;\n  }\n  return val\n}\n\n// like lodash's uniqBy but much smaller\nfunction uniqBy (arr, func) {\n  const set = new Set();\n  const res = [];\n  for (const item of arr) {\n    const key = func(item);\n    if (!set.has(key)) {\n      set.add(key);\n      res.push(item);\n    }\n  }\n  return res\n}\n\n// We don't need all the data on every emoji, and there are specific things we need\n// for the UI, so build a \"view model\" from the emoji object we got from the database\n\nfunction summarizeEmojisForUI (emojis, emojiSupportLevel) {\n  const toSimpleSkinsMap = skins => {\n    const res = {};\n    for (const skin of skins) {\n      // ignore arrays like [1, 2] with multiple skin tones\n      // also ignore variants that are in an unsupported emoji version\n      // (these do exist - variants from a different version than their base emoji)\n      if (typeof skin.tone === 'number' && skin.version <= emojiSupportLevel) {\n        res[skin.tone] = skin.unicode;\n      }\n    }\n    return res\n  };\n\n  return emojis.map(({ unicode, skins, shortcodes, url, name, category, annotation }) => ({\n    unicode,\n    name,\n    shortcodes,\n    url,\n    category,\n    annotation,\n    id: unicode || name,\n    skins: skins && toSimpleSkinsMap(skins)\n  }))\n}\n\n// import rAF from one place so that the bundle size is a bit smaller\nconst rAF = requestAnimationFrame;\n\n// \"Svelte action\"-like utility to detect layout changes via ResizeObserver.\n// If ResizeObserver is unsupported, we just use rAF once and don't bother to update.\n\n\nlet resizeObserverSupported = typeof ResizeObserver === 'function';\n\nfunction resizeObserverAction (node, abortSignal, onUpdate) {\n  let resizeObserver;\n  if (resizeObserverSupported) {\n    resizeObserver = new ResizeObserver(onUpdate);\n    resizeObserver.observe(node);\n  } else { // just run once, don't bother trying to track it\n    rAF(onUpdate);\n  }\n\n  // cleanup function (called on destroy)\n  abortSignal.addEventListener('abort', () => {\n    if (resizeObserver) {\n      resizeObserver.disconnect();\n    }\n  });\n}\n\n// get the width of the text inside of a DOM node, via https://stackoverflow.com/a/59525891/680742\nfunction calculateTextWidth (node) {\n  // skip running this in jest/vitest because we don't need to check for emoji support in that environment\n  /* istanbul ignore else */\n  {\n    const range = document.createRange();\n    range.selectNode(node.firstChild);\n    return range.getBoundingClientRect().width\n  }\n}\n\nlet baselineEmojiWidth;\n\n/**\n * Check if the given emojis containing ZWJ characters are supported by the current browser (don't render\n * as double characters) and return true if all are supported.\n * @param zwjEmojisToCheck\n * @param baselineEmoji\n * @param emojiToDomNode\n */\nfunction checkZwjSupport (zwjEmojisToCheck, baselineEmoji, emojiToDomNode) {\n  let allSupported = true;\n  for (const emoji of zwjEmojisToCheck) {\n    const domNode = emojiToDomNode(emoji);\n    // sanity check to make sure the node is defined properly\n    /* istanbul ignore if */\n    if (!domNode) {\n      // This is a race condition that can occur when the component is unmounted/remounted\n      // It doesn't really matter what we do here since the old context is not going to render anymore.\n      // Just bail out of emoji support detection and return `allSupported=true` since the rendering context is gone\n      continue\n    }\n    const emojiWidth = calculateTextWidth(domNode);\n    if (typeof baselineEmojiWidth === 'undefined') { // calculate the baseline emoji width only once\n      baselineEmojiWidth = calculateTextWidth(baselineEmoji);\n    }\n    // On Windows, some supported emoji are ~50% bigger than the baseline emoji, but what we really want to guard\n    // against are the ones that are 2x the size, because those are truly broken (person with red hair = person with\n    // floating red wig, black cat = cat with black square, polar bear = bear with snowflake, etc.)\n    // So here we set the threshold at 1.8 times the size of the baseline emoji.\n    const supported = emojiWidth / 1.8 < baselineEmojiWidth;\n    supportedZwjEmojis.set(emoji.unicode, supported);\n\n    if (!supported) {\n      allSupported = false;\n    }\n  }\n  return allSupported\n}\n\n// like lodash's uniq\n\nfunction uniq (arr) {\n  return uniqBy(arr, _ => _)\n}\n\n// Note we put this in its own function outside Picker.js to avoid Svelte doing an invalidation on the \"setter\" here.\n// At best the invalidation is useless, at worst it can cause infinite loops:\n// https://github.com/nolanlawson/emoji-picker-element/pull/180\n// https://github.com/sveltejs/svelte/issues/6521\n// Also note tabpanelElement can be null if the element is disconnected immediately after connected\nfunction resetScrollTopIfPossible (element) {\n  /* istanbul ignore else */\n  if (element) { // Makes me nervous not to have this `if` guard\n    element.scrollTop = 0;\n  }\n}\n\nfunction getFromMap (cache, key, func) {\n  let cached = cache.get(key);\n  if (!cached) {\n    cached = func();\n    cache.set(key, cached);\n  }\n  return cached\n}\n\nfunction toString (value) {\n  return '' + value\n}\n\nfunction parseTemplate (htmlString) {\n  const template = document.createElement('template');\n  template.innerHTML = htmlString;\n  return template\n}\n\nconst parseCache = new WeakMap();\nconst domInstancesCache = new WeakMap();\n// This needs to be a symbol because it needs to be different from any possible output of a key function\nconst unkeyedSymbol = Symbol('un-keyed');\n\n// Not supported in Safari <=13\nconst hasReplaceChildren = 'replaceChildren' in Element.prototype;\nfunction replaceChildren (parentNode, newChildren) {\n  /* istanbul ignore else */\n  if (hasReplaceChildren) {\n    parentNode.replaceChildren(...newChildren);\n  } else { // minimal polyfill for Element.prototype.replaceChildren\n    parentNode.innerHTML = '';\n    parentNode.append(...newChildren);\n  }\n}\n\nfunction doChildrenNeedRerender (parentNode, newChildren) {\n  let oldChild = parentNode.firstChild;\n  let oldChildrenCount = 0;\n  // iterate using firstChild/nextSibling because browsers use a linked list under the hood\n  while (oldChild) {\n    const newChild = newChildren[oldChildrenCount];\n    // check if the old child and new child are the same\n    if (newChild !== oldChild) {\n      return true\n    }\n    oldChild = oldChild.nextSibling;\n    oldChildrenCount++;\n  }\n  // if new children length is different from old, we must re-render\n  return oldChildrenCount !== newChildren.length\n}\n\nfunction patchChildren (newChildren, instanceBinding) {\n  const { targetNode } = instanceBinding;\n  let { targetParentNode } = instanceBinding;\n\n  let needsRerender = false;\n\n  if (targetParentNode) { // already rendered once\n    needsRerender = doChildrenNeedRerender(targetParentNode, newChildren);\n  } else { // first render of list\n    needsRerender = true;\n    instanceBinding.targetNode = undefined; // placeholder node not needed anymore, free memory\n    instanceBinding.targetParentNode = targetParentNode = targetNode.parentNode;\n  }\n  // avoid re-rendering list if the dom nodes are exactly the same before and after\n  if (needsRerender) {\n    replaceChildren(targetParentNode, newChildren);\n  }\n}\n\nfunction patch (expressions, instanceBindings) {\n  for (const instanceBinding of instanceBindings) {\n    const {\n      targetNode,\n      currentExpression,\n      binding: {\n        expressionIndex,\n        attributeName,\n        attributeValuePre,\n        attributeValuePost\n      }\n    } = instanceBinding;\n\n    const expression = expressions[expressionIndex];\n\n    if (currentExpression === expression) {\n      // no need to update, same as before\n      continue\n    }\n\n    instanceBinding.currentExpression = expression;\n\n    if (attributeName) { // attribute replacement\n      if (expression === null) {\n        // null is treated as a special case by the framework - we don't render an attribute at all in this case\n        targetNode.removeAttribute(attributeName);\n      } else {\n        // attribute value is not null; set a new attribute\n        const newValue = attributeValuePre + toString(expression) + attributeValuePost;\n        targetNode.setAttribute(attributeName, newValue);\n      }\n    } else { // text node / child element / children replacement\n      let newNode;\n      if (Array.isArray(expression)) { // array of DOM elements produced by tag template literals\n        patchChildren(expression, instanceBinding);\n      } else if (expression instanceof Element) { // html tag template returning a DOM element\n        newNode = expression;\n        targetNode.replaceWith(newNode);\n      } else { // primitive - string, number, etc\n        // nodeValue is faster than textContent supposedly https://www.youtube.com/watch?v=LY6y3HbDVmg\n        // note we may be replacing the value in a placeholder text node\n        targetNode.nodeValue = toString(expression);\n      }\n      if (newNode) {\n        instanceBinding.targetNode = newNode;\n      }\n    }\n  }\n}\n\nfunction parse (tokens) {\n  let htmlString = '';\n\n  let withinTag = false;\n  let withinAttribute = false;\n  let elementIndexCounter = -1; // depth-first traversal order\n\n  const elementsToBindings = new Map();\n  const elementIndexes = [];\n\n  let skipTokenChars = 0;\n  for (let i = 0, len = tokens.length; i < len; i++) {\n    const token = tokens[i];\n    htmlString += token.slice(skipTokenChars);\n\n    if (i === len - 1) {\n      break // no need to process characters - no more expressions to be found\n    }\n\n    for (let j = 0; j < token.length; j++) {\n      const char = token.charAt(j);\n      switch (char) {\n        case '<': {\n          const nextChar = token.charAt(j + 1);\n          if (nextChar === '/') { // closing tag\n            // leaving an element\n            elementIndexes.pop();\n          } else { // not a closing tag\n            withinTag = true;\n            elementIndexes.push(++elementIndexCounter);\n          }\n          break\n        }\n        case '>': {\n          withinTag = false;\n          withinAttribute = false;\n          break\n        }\n        case '=': {\n          withinAttribute = true;\n          break\n        }\n      }\n    }\n\n    const elementIndex = elementIndexes[elementIndexes.length - 1];\n    const bindings = getFromMap(elementsToBindings, elementIndex, () => []);\n\n    let attributeName;\n    let attributeValuePre;\n    let attributeValuePost;\n    if (withinAttribute) {\n      // I never use single-quotes for attribute values in HTML, so just support double-quotes or no-quotes\n      const attributePreMatch = /(\\S+)=\"?([^\"=]*)$/.exec(token);\n      attributeName = attributePreMatch[1];\n      attributeValuePre = attributePreMatch[2];\n      const attributePostMatch = /^([^\">]*)(\"?)/.exec(tokens[i + 1]);\n      attributeValuePost = attributePostMatch[1];\n      // Optimization: remove the attribute itself, so we don't create a default attribute which is either empty or just\n      // the \"pre\" text, e.g. `<div foo>` or `<div foo=\"prefix\">`. It will be replaced by the expression anyway.\n      htmlString = htmlString.slice(0, -1 * attributePreMatch[0].length);\n      skipTokenChars = attributePostMatch[0].length;\n    } else {\n      skipTokenChars = 0;\n    }\n\n    const binding = {\n      attributeName,\n      attributeValuePre,\n      attributeValuePost,\n      expressionIndex: i\n    };\n\n    bindings.push(binding);\n\n    if (!withinTag && !withinAttribute) {\n      // Add a placeholder text node, so we can find it later. Note we only support one dynamic child text node\n      htmlString += ' ';\n    }\n  }\n\n  const template = parseTemplate(htmlString);\n\n  return {\n    template,\n    elementsToBindings\n  }\n}\n\nfunction applyBindings (bindings, element, instanceBindings) {\n  for (let i = 0; i < bindings.length; i++) {\n    const binding = bindings[i];\n\n    const targetNode = binding.attributeName\n      ? element // attribute binding, just use the element itself\n      : element.firstChild; // not an attribute binding, so has a placeholder text node\n\n    const instanceBinding = {\n      binding,\n      targetNode,\n      targetParentNode: undefined,\n      currentExpression: undefined\n    };\n\n    instanceBindings.push(instanceBinding);\n  }\n}\n\nfunction traverseAndSetupBindings (rootElement, elementsToBindings) {\n  const instanceBindings = [];\n\n  let topLevelBindings;\n  if (elementsToBindings.size === 1 && (topLevelBindings = elementsToBindings.get(0))) {\n    // Optimization for the common case where there's only one element and one binding\n    // Skip creating a TreeWalker entirely and just handle the root DOM element\n    applyBindings(topLevelBindings, rootElement, instanceBindings);\n  } else {\n    // traverse dom\n    const treeWalker = document.createTreeWalker(rootElement, NodeFilter.SHOW_ELEMENT);\n\n    let element = rootElement;\n    let elementIndex = -1;\n    do {\n      const bindings = elementsToBindings.get(++elementIndex);\n      if (bindings) {\n        applyBindings(bindings, element, instanceBindings);\n      }\n    } while ((element = treeWalker.nextNode()))\n  }\n\n  return instanceBindings\n}\n\nfunction parseHtml (tokens) {\n  // All templates and bound expressions are unique per tokens array\n  const { template, elementsToBindings } = getFromMap(parseCache, tokens, () => parse(tokens));\n\n  // When we parseHtml, we always return a fresh DOM instance ready to be updated\n  const dom = template.cloneNode(true).content.firstElementChild;\n  const instanceBindings = traverseAndSetupBindings(dom, elementsToBindings);\n\n  return function updateDomInstance (expressions) {\n    patch(expressions, instanceBindings);\n    return dom\n  }\n}\n\nfunction createFramework (state) {\n  const domInstances = getFromMap(domInstancesCache, state, () => new Map());\n  let domInstanceCacheKey = unkeyedSymbol;\n\n  function html (tokens, ...expressions) {\n    // Each unique lexical usage of map() is considered unique due to the html`` tagged template call it makes,\n    // which has lexically unique tokens. The unkeyed symbol is just used for html`` usage outside of a map().\n    const domInstancesForTokens = getFromMap(domInstances, tokens, () => new Map());\n    const updateDomInstance = getFromMap(domInstancesForTokens, domInstanceCacheKey, () => parseHtml(tokens));\n\n    return updateDomInstance(expressions) // update with expressions\n  }\n\n  function map (array, callback, keyFunction) {\n    return array.map((item, index) => {\n      const originalCacheKey = domInstanceCacheKey;\n      domInstanceCacheKey = keyFunction(item);\n      try {\n        return callback(item, index)\n      } finally {\n        domInstanceCacheKey = originalCacheKey;\n      }\n    })\n  }\n\n  return { map, html }\n}\n\nfunction render (container, state, helpers, events, actions, refs, abortSignal, actionContext, firstRender) {\n  const { labelWithSkin, titleForEmoji, unicodeWithSkin } = helpers;\n  const { html, map } = createFramework(state);\n\n  function emojiList (emojis, searchMode, prefix) {\n    return map(emojis, (emoji, i) => {\n      return html`<button role=\"${searchMode ? 'option' : 'menuitem'}\" aria-selected=\"${searchMode ? i === state.activeSearchItem : null}\" aria-label=\"${labelWithSkin(emoji, state.currentSkinTone)}\" title=\"${titleForEmoji(emoji)}\" class=\"${\n                'emoji' +\n                (searchMode && i === state.activeSearchItem ? ' active' : '') +\n                (emoji.unicode ? '' : ' custom-emoji')\n              }\" id=\"${`${prefix}-${emoji.id}`}\" style=\"${emoji.unicode ? null : `--custom-emoji-background: url(${JSON.stringify(emoji.url)})`}\">${\n        emoji.unicode\n          ? unicodeWithSkin(emoji, state.currentSkinTone)\n          : ''\n      }</button>`\n      // It's important for the cache key to be unique based on the prefix, because the framework caches based on the\n      // unique tokens + cache key, and the same emoji may be used in the tab as well as in the fav bar\n    }, emoji => `${prefix}-${emoji.id}`)\n  }\n\n  const section = () => {\n    return html`<section data-ref=\"rootElement\" class=\"picker\" aria-label=\"${state.i18n.regionLabel}\" style=\"${state.pickerStyle || ''}\"><div class=\"pad-top\"></div><div class=\"search-row\"><div class=\"search-wrapper\"><input id=\"search\" class=\"search\" type=\"search\" role=\"combobox\" enterkeyhint=\"search\" placeholder=\"${state.i18n.searchLabel}\" autocapitalize=\"none\" autocomplete=\"off\" spellcheck=\"true\" aria-expanded=\"${!!(state.searchMode && state.currentEmojis.length)}\" aria-controls=\"search-results\" aria-describedby=\"search-description\" aria-autocomplete=\"list\" aria-activedescendant=\"${state.activeSearchItemId ? `emo-${state.activeSearchItemId}` : null}\" data-ref=\"searchElement\" data-on-input=\"onSearchInput\" data-on-keydown=\"onSearchKeydown\"><label class=\"sr-only\" for=\"search\">${state.i18n.searchLabel}</label> <span id=\"search-description\" class=\"sr-only\">${state.i18n.searchDescription}</span></div><div class=\"skintone-button-wrapper ${state.skinTonePickerExpandedAfterAnimation ? 'expanded' : ''}\"><button id=\"skintone-button\" class=\"emoji ${state.skinTonePickerExpanded ? 'hide-focus' : ''}\" aria-label=\"${state.skinToneButtonLabel}\" title=\"${state.skinToneButtonLabel}\" aria-describedby=\"skintone-description\" aria-haspopup=\"listbox\" aria-expanded=\"${state.skinTonePickerExpanded}\" aria-controls=\"skintone-list\" data-on-click=\"onClickSkinToneButton\">${state.skinToneButtonText || ''}</button></div><span id=\"skintone-description\" class=\"sr-only\">${state.i18n.skinToneDescription}</span><div data-ref=\"skinToneDropdown\" id=\"skintone-list\" class=\"skintone-list hide-focus ${state.skinTonePickerExpanded ? '' : 'hidden no-animate'}\" style=\"transform:translateY(${state.skinTonePickerExpanded ? 0 : 'calc(-1 * var(--num-skintones) * var(--total-emoji-size))'})\" role=\"listbox\" aria-label=\"${state.i18n.skinTonesLabel}\" aria-activedescendant=\"skintone-${state.activeSkinTone}\" aria-hidden=\"${!state.skinTonePickerExpanded}\" tabIndex=\"-1\" data-on-focusout=\"onSkinToneOptionsFocusOut\" data-on-click=\"onSkinToneOptionsClick\" data-on-keydown=\"onSkinToneOptionsKeydown\" data-on-keyup=\"onSkinToneOptionsKeyup\">${\n    map(state.skinTones, (skinTone, i) => {\n    return html`<div id=\"skintone-${i}\" class=\"emoji ${i === state.activeSkinTone ? 'active' : ''}\" aria-selected=\"${i === state.activeSkinTone}\" role=\"option\" title=\"${state.i18n.skinTones[i]}\" aria-label=\"${state.i18n.skinTones[i]}\">${skinTone}</div>`\n    }, skinTone => skinTone)\n        }</div></div><div class=\"nav\" role=\"tablist\" style=\"grid-template-columns:repeat(${state.groups.length},1fr)\" aria-label=\"${state.i18n.categoriesLabel}\" data-on-keydown=\"onNavKeydown\" data-on-click=\"onNavClick\">${\n            map(state.groups, (group) => {\n              return html`<button role=\"tab\" class=\"nav-button\" aria-controls=\"tab-${group.id}\" aria-label=\"${state.i18n.categories[group.name]}\" aria-selected=\"${!state.searchMode && state.currentGroup.id === group.id}\" title=\"${state.i18n.categories[group.name]}\" data-group-id=\"${group.id}\"><div class=\"nav-emoji emoji\">${group.emoji}</div></button>`\n            }, group => group.id)\n          }</div><div class=\"indicator-wrapper\"><div class=\"indicator\" style=\"transform:translateX(${(/* istanbul ignore next */ (state.isRtl ? -1 : 1)) * state.currentGroupIndex * 100}%)\"></div></div><div class=\"message ${state.message ? '' : 'gone'}\" role=\"alert\" aria-live=\"polite\">${state.message || ''}</div><div data-ref=\"tabpanelElement\" class=\"tabpanel ${(!state.databaseLoaded || state.message) ? 'gone' : ''}\" role=\"${state.searchMode ? 'region' : 'tabpanel'}\" aria-label=\"${state.searchMode ? state.i18n.searchResultsLabel : state.i18n.categories[state.currentGroup.name]}\" id=\"${state.searchMode ? null : `tab-${state.currentGroup.id}`}\" tabIndex=\"0\" data-on-click=\"onEmojiClick\"><div data-action=\"calculateEmojiGridStyle\">${\n              map(state.currentEmojisWithCategories, (emojiWithCategory, i) => {\n                return html`<div><div id=\"menu-label-${i}\" class=\"category ${state.currentEmojisWithCategories.length === 1 && state.currentEmojisWithCategories[0].category === '' ? 'gone' : ''}\" aria-hidden=\"true\">${\n                  state.searchMode\n                    ? state.i18n.searchResultsLabel\n                    : (\n                      emojiWithCategory.category\n                        ? emojiWithCategory.category\n                        : (\n                          state.currentEmojisWithCategories.length > 1\n                            ? state.i18n.categories.custom\n                            : state.i18n.categories[state.currentGroup.name]\n                        )\n                    )\n                }</div><div class=\"emoji-menu ${i !== 0 && !state.searchMode && state.currentGroup.id === -1 ? 'visibility-auto' : ''}\" style=\"${`--num-rows: ${Math.ceil(emojiWithCategory.emojis.length / state.numColumns)}`}\" data-action=\"updateOnIntersection\" role=\"${state.searchMode ? 'listbox' : 'menu'}\" aria-labelledby=\"menu-label-${i}\" id=\"${state.searchMode ? 'search-results' : null}\">${\n              emojiList(emojiWithCategory.emojis, state.searchMode, /* prefix */ 'emo')\n            }</div></div>`\n              }, emojiWithCategory => emojiWithCategory.category)\n            }</div></div><div class=\"favorites onscreen emoji-menu ${state.message ? 'gone' : ''}\" role=\"menu\" aria-label=\"${state.i18n.favoritesLabel}\" data-on-click=\"onEmojiClick\">${\n            emojiList(state.currentFavorites, /* searchMode */ false, /* prefix */ 'fav')\n          }</div><button data-ref=\"baselineEmoji\" aria-hidden=\"true\" tabindex=\"-1\" class=\"abs-pos hidden emoji baseline-emoji\"></button></section>`\n  };\n\n  const rootDom = section();\n\n  // helper for traversing the dom, finding elements by an attribute, and getting the attribute value\n  const forElementWithAttribute = (attributeName, callback) => {\n    for (const element of container.querySelectorAll(`[${attributeName}]`)) {\n      callback(element, element.getAttribute(attributeName));\n    }\n  };\n\n  if (firstRender) { // not a re-render\n    container.appendChild(rootDom);\n\n    // we only bind events/refs once - there is no need to find them again given this component structure\n\n    // bind events\n    for (const eventName of ['click', 'focusout', 'input', 'keydown', 'keyup']) {\n      forElementWithAttribute(`data-on-${eventName}`, (element, listenerName) => {\n        element.addEventListener(eventName, events[listenerName]);\n      });\n    }\n\n    // find refs\n    forElementWithAttribute('data-ref', (element, ref) => {\n      refs[ref] = element;\n    });\n\n    // destroy/abort logic\n    abortSignal.addEventListener('abort', () => {\n      container.removeChild(rootDom);\n    });\n  }\n\n  // set up actions - these are re-bound on every render\n  forElementWithAttribute('data-action', (element, action) => {\n    let boundActions = actionContext.get(action);\n    if (!boundActions) {\n      actionContext.set(action, (boundActions = new WeakSet()));\n    }\n\n    // avoid applying the same action to the same element multiple times\n    if (!boundActions.has(element)) {\n      boundActions.add(element);\n      actions[action](element);\n    }\n  });\n}\n\n/* istanbul ignore next */\nconst qM = typeof queueMicrotask === 'function' ? queueMicrotask : callback => Promise.resolve().then(callback);\n\nfunction createState (abortSignal) {\n  let destroyed = false;\n  let currentObserver;\n\n  const propsToObservers = new Map();\n  const dirtyObservers = new Set();\n\n  let queued;\n\n  const flush = () => {\n    if (destroyed) {\n      return\n    }\n    const observersToRun = [...dirtyObservers];\n    dirtyObservers.clear(); // clear before running to force any new updates to run in another tick of the loop\n    try {\n      for (const observer of observersToRun) {\n        observer();\n      }\n    } finally {\n      queued = false;\n      if (dirtyObservers.size) { // new updates, queue another one\n        queued = true;\n        qM(flush);\n      }\n    }\n  };\n\n  const state = new Proxy({}, {\n    get (target, prop) {\n      if (currentObserver) {\n        let observers = propsToObservers.get(prop);\n        if (!observers) {\n          observers = new Set();\n          propsToObservers.set(prop, observers);\n        }\n        observers.add(currentObserver);\n      }\n      return target[prop]\n    },\n    set (target, prop, newValue) {\n      if (target[prop] !== newValue) {\n        target[prop] = newValue;\n        const observers = propsToObservers.get(prop);\n        if (observers) {\n          for (const observer of observers) {\n            dirtyObservers.add(observer);\n          }\n          if (!queued) {\n            queued = true;\n            qM(flush);\n          }\n        }\n      }\n      return true\n    }\n  });\n\n  const createEffect = (callback) => {\n    const runnable = () => {\n      const oldObserver = currentObserver;\n      currentObserver = runnable;\n      try {\n        return callback()\n      } finally {\n        currentObserver = oldObserver;\n      }\n    };\n    return runnable()\n  };\n\n  // destroy logic\n  abortSignal.addEventListener('abort', () => {\n    destroyed = true;\n  });\n\n  return {\n    state,\n    createEffect\n  }\n}\n\n// Compare two arrays, with a function called on each item in the two arrays that returns true if the items are equal\nfunction arraysAreEqualByFunction (left, right, areEqualFunc) {\n  if (left.length !== right.length) {\n    return false\n  }\n  for (let i = 0; i < left.length; i++) {\n    if (!areEqualFunc(left[i], right[i])) {\n      return false\n    }\n  }\n  return true\n}\n\nconst intersectionObserverCache = new WeakMap();\n\nfunction intersectionObserverAction (node, abortSignal, listener) {\n  /* istanbul ignore else */\n  {\n    // The scroll root is always `.tabpanel`\n    const root = node.closest('.tabpanel');\n\n    let observer = intersectionObserverCache.get(root);\n    if (!observer) {\n      // TODO: replace this with the contentvisibilityautostatechange event when all supported browsers support it.\n      // For now we use IntersectionObserver because it has better cross-browser support, and it would be bad for\n      // old Safari versions if they eagerly downloaded all custom emoji all at once.\n      observer = new IntersectionObserver(listener, {\n        root,\n        // trigger if we are 1/2 scroll container height away so that the images load a bit quicker while scrolling\n        rootMargin: '50% 0px 50% 0px',\n        // trigger if any part of the emoji grid is intersecting\n        threshold: 0\n      });\n\n      // avoid creating a new IntersectionObserver for every category; just use one for the whole root\n      intersectionObserverCache.set(root, observer);\n\n      // assume that the abortSignal is always the same for this root node; just add one event listener\n      abortSignal.addEventListener('abort', () => {\n        observer.disconnect();\n      });\n    }\n\n    observer.observe(node);\n  }\n}\n\n/* eslint-disable prefer-const,no-labels,no-inner-declarations */\n\n// constants\nconst EMPTY_ARRAY = [];\n\nconst { assign } = Object;\n\nfunction createRoot (shadowRoot, props) {\n  const refs = {};\n  const abortController = new AbortController();\n  const abortSignal = abortController.signal;\n  const { state, createEffect } = createState(abortSignal);\n  const actionContext = new Map();\n\n  // initial state\n  assign(state, {\n    skinToneEmoji: undefined,\n    i18n: undefined,\n    database: undefined,\n    customEmoji: undefined,\n    customCategorySorting: undefined,\n    emojiVersion: undefined\n  });\n\n  // public props\n  assign(state, props);\n\n  // private props\n  assign(state, {\n    initialLoad: true,\n    currentEmojis: [],\n    currentEmojisWithCategories: [],\n    rawSearchText: '',\n    searchText: '',\n    searchMode: false,\n    activeSearchItem: -1,\n    message: undefined,\n    skinTonePickerExpanded: false,\n    skinTonePickerExpandedAfterAnimation: false,\n    currentSkinTone: 0,\n    activeSkinTone: 0,\n    skinToneButtonText: undefined,\n    pickerStyle: undefined,\n    skinToneButtonLabel: '',\n    skinTones: [],\n    currentFavorites: [],\n    defaultFavoriteEmojis: undefined,\n    numColumns: DEFAULT_NUM_COLUMNS,\n    isRtl: false,\n    currentGroupIndex: 0,\n    groups: groups,\n    databaseLoaded: false,\n    activeSearchItemId: undefined\n  });\n\n  //\n  // Update the current group based on the currentGroupIndex\n  //\n  createEffect(() => {\n    if (state.currentGroup !== state.groups[state.currentGroupIndex]) {\n      state.currentGroup = state.groups[state.currentGroupIndex];\n    }\n  });\n\n  //\n  // Utils/helpers\n  //\n\n  const focus = id => {\n    shadowRoot.getElementById(id).focus();\n  };\n\n  const emojiToDomNode = emoji => shadowRoot.getElementById(`emo-${emoji.id}`);\n\n  // fire a custom event that crosses the shadow boundary\n  const fireEvent = (name, detail) => {\n    refs.rootElement.dispatchEvent(new CustomEvent(name, {\n      detail,\n      bubbles: true,\n      composed: true\n    }));\n  };\n\n  //\n  // Comparison utils\n  //\n\n  const compareEmojiArrays = (a, b) => a.id === b.id;\n\n  const compareCurrentEmojisWithCategories = (a, b) => {\n    const { category: aCategory, emojis: aEmojis } = a;\n    const { category: bCategory, emojis: bEmojis } = b;\n\n    if (aCategory !== bCategory) {\n      return false\n    }\n\n    return arraysAreEqualByFunction(aEmojis, bEmojis, compareEmojiArrays)\n  };\n\n  //\n  // Update utils to avoid excessive re-renders\n  //\n\n  // avoid excessive re-renders by checking the value before setting\n  const updateCurrentEmojis = (newEmojis) => {\n    if (!arraysAreEqualByFunction(state.currentEmojis, newEmojis, compareEmojiArrays)) {\n      state.currentEmojis = newEmojis;\n    }\n  };\n\n  // avoid excessive re-renders\n  const updateSearchMode = (newSearchMode) => {\n    if (state.searchMode !== newSearchMode) {\n      state.searchMode = newSearchMode;\n    }\n  };\n\n  // avoid excessive re-renders\n  const updateCurrentEmojisWithCategories = (newEmojisWithCategories) => {\n    if (!arraysAreEqualByFunction(state.currentEmojisWithCategories, newEmojisWithCategories, compareCurrentEmojisWithCategories)) {\n      state.currentEmojisWithCategories = newEmojisWithCategories;\n    }\n  };\n\n  // Helpers used by PickerTemplate\n\n  const unicodeWithSkin = (emoji, currentSkinTone) => (\n    (currentSkinTone && emoji.skins && emoji.skins[currentSkinTone]) || emoji.unicode\n  );\n\n  const labelWithSkin = (emoji, currentSkinTone) => (\n    uniq([\n      (emoji.name || unicodeWithSkin(emoji, currentSkinTone)),\n      emoji.annotation,\n      ...(emoji.shortcodes || EMPTY_ARRAY)\n    ].filter(Boolean)).join(', ')\n  );\n\n  const titleForEmoji = (emoji) => (\n    emoji.annotation || (emoji.shortcodes || EMPTY_ARRAY).join(', ')\n  );\n\n  const helpers = {\n    labelWithSkin, titleForEmoji, unicodeWithSkin\n  };\n  const events = {\n    onClickSkinToneButton,\n    onEmojiClick,\n    onNavClick,\n    onNavKeydown,\n    onSearchKeydown,\n    onSkinToneOptionsClick,\n    onSkinToneOptionsFocusOut,\n    onSkinToneOptionsKeydown,\n    onSkinToneOptionsKeyup,\n    onSearchInput\n  };\n  const actions = {\n    calculateEmojiGridStyle,\n    updateOnIntersection\n  };\n\n  let firstRender = true;\n  createEffect(() => {\n    render(shadowRoot, state, helpers, events, actions, refs, abortSignal, actionContext, firstRender);\n    firstRender = false;\n  });\n\n  //\n  // Determine the emoji support level (in requestIdleCallback)\n  //\n\n  // mount logic\n  if (!state.emojiVersion) {\n    detectEmojiSupportLevel().then(level => {\n      // Can't actually test emoji support in Jest/Vitest/JSDom, emoji never render in color in Cairo\n      /* istanbul ignore next */\n      if (!level) {\n        state.message = state.i18n.emojiUnsupportedMessage;\n      }\n    });\n  }\n\n  //\n  // Set or update the database object\n  //\n\n  createEffect(() => {\n    // show a Loading message if it takes a long time, or show an error if there's a network/IDB error\n    async function handleDatabaseLoading () {\n      let showingLoadingMessage = false;\n      const timeoutHandle = setTimeout(() => {\n        showingLoadingMessage = true;\n        state.message = state.i18n.loadingMessage;\n      }, TIMEOUT_BEFORE_LOADING_MESSAGE);\n      try {\n        await state.database.ready();\n        state.databaseLoaded = true; // eslint-disable-line no-unused-vars\n      } catch (err) {\n        console.error(err);\n        state.message = state.i18n.networkErrorMessage;\n      } finally {\n        clearTimeout(timeoutHandle);\n        if (showingLoadingMessage) { // Seems safer than checking the i18n string, which may change\n          showingLoadingMessage = false;\n          state.message = ''; // eslint-disable-line no-unused-vars\n        }\n      }\n    }\n\n    if (state.database) {\n      /* no await */\n      handleDatabaseLoading();\n    }\n  });\n\n  //\n  // Global styles for the entire picker\n  //\n\n  createEffect(() => {\n    state.pickerStyle = `\n      --num-groups: ${state.groups.length}; \n      --indicator-opacity: ${state.searchMode ? 0 : 1}; \n      --num-skintones: ${NUM_SKIN_TONES};`;\n  });\n\n  //\n  // Set or update the customEmoji\n  //\n\n  createEffect(() => {\n    if (state.customEmoji && state.database) {\n      updateCustomEmoji(); // re-run whenever customEmoji change\n    }\n  });\n\n  createEffect(() => {\n    if (state.customEmoji && state.customEmoji.length) {\n      if (state.groups !== allGroups) { // don't update unnecessarily\n        state.groups = allGroups;\n      }\n    } else if (state.groups !== groups) {\n      if (state.currentGroupIndex) {\n        // If the current group is anything other than \"custom\" (which is first), decrement.\n        // This fixes the odd case where you set customEmoji, then pick a category, then unset customEmoji\n        state.currentGroupIndex--;\n      }\n      state.groups = groups;\n    }\n  });\n\n  //\n  // Set or update the preferred skin tone\n  //\n\n  createEffect(() => {\n    async function updatePreferredSkinTone () {\n      if (state.databaseLoaded) {\n        state.currentSkinTone = await state.database.getPreferredSkinTone();\n      }\n    }\n\n    /* no await */ updatePreferredSkinTone();\n  });\n\n  createEffect(() => {\n    state.skinTones = Array(NUM_SKIN_TONES).fill().map((_, i) => applySkinTone(state.skinToneEmoji, i));\n  });\n\n  createEffect(() => {\n    state.skinToneButtonText = state.skinTones[state.currentSkinTone];\n  });\n\n  createEffect(() => {\n    state.skinToneButtonLabel = state.i18n.skinToneLabel.replace('{skinTone}', state.i18n.skinTones[state.currentSkinTone]);\n  });\n\n  //\n  // Set or update the favorites emojis\n  //\n\n  createEffect(() => {\n    async function updateDefaultFavoriteEmojis () {\n      const { database } = state;\n      const favs = (await Promise.all(MOST_COMMONLY_USED_EMOJI.map(unicode => (\n        database.getEmojiByUnicodeOrName(unicode)\n      )))).filter(Boolean); // filter because in Jest/Vitest tests we don't have all the emoji in the DB\n      state.defaultFavoriteEmojis = favs;\n    }\n\n    if (state.databaseLoaded) {\n      /* no await */ updateDefaultFavoriteEmojis();\n    }\n  });\n\n  function updateCustomEmoji () {\n    // Certain effects have an implicit dependency on customEmoji since it affects the database\n    // Getting it here on the state ensures this effect re-runs when customEmoji change.\n    const { customEmoji, database } = state;\n    const databaseCustomEmoji = customEmoji || EMPTY_ARRAY;\n    if (database.customEmoji !== databaseCustomEmoji) {\n      // Avoid setting this if the customEmoji have _not_ changed, because the setter triggers a re-computation of the\n      // `customEmojiIndex`. Note we don't bother with deep object changes.\n      database.customEmoji = databaseCustomEmoji;\n    }\n  }\n\n  createEffect(() => {\n    async function updateFavorites () {\n      updateCustomEmoji(); // re-run whenever customEmoji change\n      const { database, defaultFavoriteEmojis, numColumns } = state;\n      const dbFavorites = await database.getTopFavoriteEmoji(numColumns);\n      const favorites = await summarizeEmojis(uniqBy([\n        ...dbFavorites,\n        ...defaultFavoriteEmojis\n      ], _ => (_.unicode || _.name)).slice(0, numColumns));\n      state.currentFavorites = favorites;\n    }\n\n    if (state.databaseLoaded && state.defaultFavoriteEmojis) {\n      /* no await */ updateFavorites();\n    }\n  });\n\n  //\n  // Re-run whenever the emoji grid changes size, and re-calc style/layout-related state variables:\n  // 1) Re-calculate the --num-columns var because it may have changed\n  // 2) Re-calculate whether we're in RTL mode or not.\n  //\n  // The benefit of doing this in one place is to align with rAF/ResizeObserver\n  // and do all the calculations in one go. RTL vs LTR is not strictly layout-related,\n  // but since we're already reading the style here, and since it's already aligned with\n  // the rAF loop, this is the most appropriate place to do it perf-wise.\n  //\n\n  function calculateEmojiGridStyle (node) {\n    resizeObserverAction(node, abortSignal, () => {\n      /* istanbul ignore next */\n      { // jsdom throws errors for this kind of fancy stuff\n        // read all the style/layout calculations we need to make\n        const style = getComputedStyle(refs.rootElement);\n        const newNumColumns = parseInt(style.getPropertyValue('--num-columns'), 10);\n        const newIsRtl = style.getPropertyValue('direction') === 'rtl';\n\n        // write to state variables\n        state.numColumns = newNumColumns;\n        state.isRtl = newIsRtl;\n      }\n    });\n  }\n\n  // Re-run whenever the custom emoji in a category are shown/hidden. This is an optimization that simulates\n  // what we'd get from `<img loading=lazy>` but without rendering an `<img>`.\n  function updateOnIntersection (node) {\n    intersectionObserverAction(node, abortSignal, (entries) => {\n      for (const { target, isIntersecting } of entries) {\n        target.classList.toggle('onscreen', isIntersecting);\n      }\n    });\n  }\n\n  //\n  // Set or update the currentEmojis. Check for invalid ZWJ renderings\n  // (i.e. double emoji).\n  //\n\n  createEffect(() => {\n    async function updateEmojis () {\n      const { searchText, currentGroup, databaseLoaded, customEmoji } = state;\n      if (!databaseLoaded) {\n        state.currentEmojis = [];\n        state.searchMode = false;\n      } else if (searchText.length >= MIN_SEARCH_TEXT_LENGTH) {\n        const newEmojis = await getEmojisBySearchQuery(searchText);\n        if (state.searchText === searchText) { // if the situation changes asynchronously, do not update\n          updateCurrentEmojis(newEmojis);\n          updateSearchMode(true);\n        }\n      } else { // database is loaded and we're not in search mode, so we're in normal category mode\n        const { id: currentGroupId } = currentGroup;\n        // avoid race condition where currentGroupId is -1 and customEmoji is undefined/empty\n        if (currentGroupId !== -1 || (customEmoji && customEmoji.length)) {\n          const newEmojis = await getEmojisByGroup(currentGroupId);\n          if (state.currentGroup.id === currentGroupId) { // if the situation changes asynchronously, do not update\n            updateCurrentEmojis(newEmojis);\n            updateSearchMode(false);\n          }\n        }\n      }\n    }\n\n    /* no await */ updateEmojis();\n  });\n\n  const resetScrollTopInRaf = () => {\n    rAF(() => resetScrollTopIfPossible(refs.tabpanelElement));\n  };\n\n  // Some emojis have their ligatures rendered as two or more consecutive emojis\n  // We want to treat these the same as unsupported emojis, so we compare their\n  // widths against the baseline widths and remove them as necessary\n  createEffect(() => {\n    const { currentEmojis, emojiVersion } = state;\n    const zwjEmojisToCheck = currentEmojis\n      .filter(emoji => emoji.unicode) // filter custom emoji\n      .filter(emoji => hasZwj(emoji) && !supportedZwjEmojis.has(emoji.unicode));\n    if (!emojiVersion && zwjEmojisToCheck.length) {\n      // render now, check their length later\n      updateCurrentEmojis(currentEmojis);\n      rAF(() => checkZwjSupportAndUpdate(zwjEmojisToCheck));\n    } else {\n      const newEmojis = emojiVersion ? currentEmojis : currentEmojis.filter(isZwjSupported);\n      updateCurrentEmojis(newEmojis);\n      // Reset scroll top to 0 when emojis change\n      resetScrollTopInRaf();\n    }\n  });\n\n  function checkZwjSupportAndUpdate (zwjEmojisToCheck) {\n    const allSupported = checkZwjSupport(zwjEmojisToCheck, refs.baselineEmoji, emojiToDomNode);\n    if (allSupported) {\n      // Even if all emoji are supported, we still need to reset the scroll top to 0 when emojis change\n      resetScrollTopInRaf();\n    } else {\n      // Force update. We only do this if there are any unsupported ZWJ characters since otherwise,\n      // for browsers that support all emoji, it would be an unnecessary extra re-render.\n      state.currentEmojis = [...state.currentEmojis];\n    }\n  }\n\n  function isZwjSupported (emoji) {\n    return !emoji.unicode || !hasZwj(emoji) || supportedZwjEmojis.get(emoji.unicode)\n  }\n\n  async function filterEmojisByVersion (emojis) {\n    const emojiSupportLevel = state.emojiVersion || await detectEmojiSupportLevel();\n    // !version corresponds to custom emoji\n    return emojis.filter(({ version }) => !version || version <= emojiSupportLevel)\n  }\n\n  async function summarizeEmojis (emojis) {\n    return summarizeEmojisForUI(emojis, state.emojiVersion || await detectEmojiSupportLevel())\n  }\n\n  async function getEmojisByGroup (group) {\n    // -1 is custom emoji\n    const emoji = group === -1 ? state.customEmoji : await state.database.getEmojiByGroup(group);\n    return summarizeEmojis(await filterEmojisByVersion(emoji))\n  }\n\n  async function getEmojisBySearchQuery (query) {\n    return summarizeEmojis(await filterEmojisByVersion(await state.database.getEmojiBySearchQuery(query)))\n  }\n\n  createEffect(() => {\n  });\n\n  //\n  // Derive currentEmojisWithCategories from currentEmojis. This is always done even if there\n  // are no categories, because it's just easier to code the HTML this way.\n  //\n\n  createEffect(() => {\n    function calculateCurrentEmojisWithCategories () {\n      const { searchMode, currentEmojis } = state;\n      if (searchMode) {\n        return [\n          {\n            category: '',\n            emojis: currentEmojis\n          }\n        ]\n      }\n      const categoriesToEmoji = new Map();\n      for (const emoji of currentEmojis) {\n        const category = emoji.category || '';\n        let emojis = categoriesToEmoji.get(category);\n        if (!emojis) {\n          emojis = [];\n          categoriesToEmoji.set(category, emojis);\n        }\n        emojis.push(emoji);\n      }\n      return [...categoriesToEmoji.entries()]\n        .map(([category, emojis]) => ({ category, emojis }))\n        .sort((a, b) => state.customCategorySorting(a.category, b.category))\n    }\n\n    const newEmojisWithCategories = calculateCurrentEmojisWithCategories();\n    updateCurrentEmojisWithCategories(newEmojisWithCategories);\n  });\n\n  //\n  // Handle active search item (i.e. pressing up or down while searching)\n  //\n\n  createEffect(() => {\n    state.activeSearchItemId = state.activeSearchItem !== -1 && state.currentEmojis[state.activeSearchItem].id;\n  });\n\n  //\n  // Handle user input on the search input\n  //\n\n  createEffect(() => {\n    const { rawSearchText } = state;\n    rIC(() => {\n      state.searchText = (rawSearchText || '').trim(); // defer to avoid input delays, plus we can trim here\n      state.activeSearchItem = -1;\n    });\n  });\n\n  function onSearchKeydown (event) {\n    if (!state.searchMode || !state.currentEmojis.length) {\n      return\n    }\n\n    const goToNextOrPrevious = (previous) => {\n      halt(event);\n      state.activeSearchItem = incrementOrDecrement(previous, state.activeSearchItem, state.currentEmojis);\n    };\n\n    switch (event.key) {\n      case 'ArrowDown':\n        return goToNextOrPrevious(false)\n      case 'ArrowUp':\n        return goToNextOrPrevious(true)\n      case 'Enter':\n        if (state.activeSearchItem === -1) {\n          // focus the first option in the list since the list must be non-empty at this point (it's verified above)\n          state.activeSearchItem = 0;\n        } else { // there is already an active search item\n          halt(event);\n          return clickEmoji(state.currentEmojis[state.activeSearchItem].id)\n        }\n    }\n  }\n\n  //\n  // Handle user input on nav\n  //\n\n  function onNavClick (event) {\n    const { target } = event;\n    const closestTarget = target.closest('.nav-button');\n    /* istanbul ignore if */\n    if (!closestTarget) {\n      return // This should never happen, but makes me nervous not to have it\n    }\n    const groupId = parseInt(closestTarget.dataset.groupId, 10);\n    refs.searchElement.value = ''; // clear search box input\n    state.rawSearchText = '';\n    state.searchText = '';\n    state.activeSearchItem = -1;\n    state.currentGroupIndex = state.groups.findIndex(_ => _.id === groupId);\n  }\n\n  function onNavKeydown (event) {\n    const { target, key } = event;\n\n    const doFocus = el => {\n      if (el) {\n        halt(event);\n        el.focus();\n      }\n    };\n\n    switch (key) {\n      case 'ArrowLeft':\n        return doFocus(target.previousElementSibling)\n      case 'ArrowRight':\n        return doFocus(target.nextElementSibling)\n      case 'Home':\n        return doFocus(target.parentElement.firstElementChild)\n      case 'End':\n        return doFocus(target.parentElement.lastElementChild)\n    }\n  }\n\n  async function getDetailForClickEvent (unicodeOrName) {\n    const emoji = await state.database.getEmojiByUnicodeOrName(unicodeOrName);\n    const emojiSummary = [...state.currentEmojis, ...state.currentFavorites]\n      .find(_ => (_.id === unicodeOrName));\n    const skinTonedUnicode = emojiSummary.unicode && unicodeWithSkin(emojiSummary, state.currentSkinTone);\n    await state.database.incrementFavoriteEmojiCount(unicodeOrName);\n    return {\n      emoji,\n      skinTone: state.currentSkinTone,\n      ...(skinTonedUnicode && { unicode: skinTonedUnicode }),\n      ...(emojiSummary.name && { name: emojiSummary.name })\n    }\n  }\n\n  //\n  // Handle user input on an emoji\n  //\n  async function clickEmoji (unicodeOrName) {\n    const promiseForDetail = getDetailForClickEvent(unicodeOrName);\n    // sync event to work around a safari bug: https://bugs.webkit.org/show_bug.cgi?id=222262\n    fireEvent('emoji-click-sync', promiseForDetail);\n    // async event for most normal use cases that don't need to work around the safari bug\n    fireEvent('emoji-click', await promiseForDetail);\n  }\n\n  function onEmojiClick (event) {\n    const { target } = event;\n    /* istanbul ignore if */\n    if (!target.classList.contains('emoji')) {\n      // This should never happen, but makes me nervous not to have it\n      return\n    }\n    halt(event);\n    const id = target.id.substring(4); // replace 'emo-' or 'fav-' prefix\n\n    /* no await */ clickEmoji(id);\n  }\n\n  //\n  // Handle user input on the skintone picker\n  //\n\n  function changeSkinTone (skinTone) {\n    state.currentSkinTone = skinTone;\n    state.skinTonePickerExpanded = false;\n    focus('skintone-button');\n    fireEvent('skin-tone-change', { skinTone });\n    /* no await */ state.database.setPreferredSkinTone(skinTone);\n  }\n\n  function onSkinToneOptionsClick (event) {\n    const { target: { id } } = event;\n    const match = id && id.match(/^skintone-(\\d)/); // skintone option format\n    /* istanbul ignore if */\n    if (!match) { // not a skintone option\n      return // This should never happen, but makes me nervous not to have it\n    }\n    halt(event);\n    const skinTone = parseInt(match[1], 10); // remove 'skintone-' prefix\n    changeSkinTone(skinTone);\n  }\n\n  function onClickSkinToneButton (event) {\n    state.skinTonePickerExpanded = !state.skinTonePickerExpanded;\n    state.activeSkinTone = state.currentSkinTone;\n    // this should always be true, since the button is obscured by the listbox, so this `if` is just to be sure\n    if (state.skinTonePickerExpanded) {\n      halt(event);\n      rAF(() => focus('skintone-list'));\n    }\n  }\n\n  // To make the animation nicer, change the z-index of the skintone picker button\n  // *after* the animation has played. This makes it appear that the picker box\n  // is expanding \"below\" the button\n  createEffect(() => {\n    if (state.skinTonePickerExpanded) {\n      refs.skinToneDropdown.addEventListener('transitionend', () => {\n        state.skinTonePickerExpandedAfterAnimation = true; // eslint-disable-line no-unused-vars\n      }, { once: true });\n    } else {\n      state.skinTonePickerExpandedAfterAnimation = false; // eslint-disable-line no-unused-vars\n    }\n  });\n\n  function onSkinToneOptionsKeydown (event) {\n    // this should never happen, but makes me nervous not to have it\n    /* istanbul ignore if */\n    if (!state.skinTonePickerExpanded) {\n      return\n    }\n    const changeActiveSkinTone = async nextSkinTone => {\n      halt(event);\n      state.activeSkinTone = nextSkinTone;\n    };\n\n    switch (event.key) {\n      case 'ArrowUp':\n        return changeActiveSkinTone(incrementOrDecrement(true, state.activeSkinTone, state.skinTones))\n      case 'ArrowDown':\n        return changeActiveSkinTone(incrementOrDecrement(false, state.activeSkinTone, state.skinTones))\n      case 'Home':\n        return changeActiveSkinTone(0)\n      case 'End':\n        return changeActiveSkinTone(state.skinTones.length - 1)\n      case 'Enter':\n        // enter on keydown, space on keyup. this is just how browsers work for buttons\n        // https://lists.w3.org/Archives/Public/w3c-wai-ig/2019JanMar/0086.html\n        halt(event);\n        return changeSkinTone(state.activeSkinTone)\n      case 'Escape':\n        halt(event);\n        state.skinTonePickerExpanded = false;\n        return focus('skintone-button')\n    }\n  }\n\n  function onSkinToneOptionsKeyup (event) {\n    // this should never happen, but makes me nervous not to have it\n    /* istanbul ignore if */\n    if (!state.skinTonePickerExpanded) {\n      return\n    }\n    switch (event.key) {\n      case ' ':\n        // enter on keydown, space on keyup. this is just how browsers work for buttons\n        // https://lists.w3.org/Archives/Public/w3c-wai-ig/2019JanMar/0086.html\n        halt(event);\n        return changeSkinTone(state.activeSkinTone)\n    }\n  }\n\n  async function onSkinToneOptionsFocusOut (event) {\n    // On blur outside of the skintone listbox, collapse the skintone picker.\n    const { relatedTarget } = event;\n    // The `else` should never happen, but makes me nervous not to have it\n    /* istanbul ignore else */\n    if (!relatedTarget || relatedTarget.id !== 'skintone-list') {\n      state.skinTonePickerExpanded = false;\n    }\n  }\n\n  function onSearchInput (event) {\n    state.rawSearchText = event.target.value;\n  }\n\n  return {\n    $set (newState) {\n      assign(state, newState);\n    },\n    $destroy () {\n      abortController.abort();\n    }\n  }\n}\n\nconst DEFAULT_DATA_SOURCE = 'https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json';\nconst DEFAULT_LOCALE = 'en';\n\nvar enI18n = {\n  categoriesLabel: 'Categories',\n  emojiUnsupportedMessage: 'Your browser does not support color emoji.',\n  favoritesLabel: 'Favorites',\n  loadingMessage: 'Loading',\n  networkErrorMessage: 'Could not load emoji.',\n  regionLabel: 'Emoji picker',\n  searchDescription: 'When search results are available, press up or down to select and enter to choose.',\n  searchLabel: 'Search',\n  searchResultsLabel: 'Search results',\n  skinToneDescription: 'When expanded, press up or down to select and enter to choose.',\n  skinToneLabel: 'Choose a skin tone (currently {skinTone})',\n  skinTonesLabel: 'Skin tones',\n  skinTones: [\n    'Default',\n    'Light',\n    'Medium-Light',\n    'Medium',\n    'Medium-Dark',\n    'Dark'\n  ],\n  categories: {\n    custom: 'Custom',\n    'smileys-emotion': 'Smileys and emoticons',\n    'people-body': 'People and body',\n    'animals-nature': 'Animals and nature',\n    'food-drink': 'Food and drink',\n    'travel-places': 'Travel and places',\n    activities: 'Activities',\n    objects: 'Objects',\n    symbols: 'Symbols',\n    flags: 'Flags'\n  }\n};\n\nvar baseStyles = \":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--border-radius:0;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);border-radius:var(--border-radius);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;scrollbar-gutter:stable;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.emoji-menu.visibility-auto{content-visibility:auto;contain-intrinsic-size:calc(var(--num-columns)*var(--total-emoji-size)) calc(var(--num-rows)*var(--total-emoji-size))}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;height:var(--total-emoji-size);width:var(--total-emoji-size);line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.onscreen .custom-emoji::after{content:\\\"\\\";width:var(--emoji-size);height:var(--emoji-size);background-repeat:no-repeat;background-position:center center;background-size:contain;background-image:var(--custom-emoji-background)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{overflow-y:auto;scrollbar-gutter:stable;display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}\";\n\nconst PROPS = [\n  'customEmoji',\n  'customCategorySorting',\n  'database',\n  'dataSource',\n  'i18n',\n  'locale',\n  'skinToneEmoji',\n  'emojiVersion'\n];\n\n// Styles injected ourselves, so we can declare the FONT_FAMILY variable in one place\nconst EXTRA_STYLES = `:host{--emoji-font-family:${FONT_FAMILY}}`;\n\nclass PickerElement extends HTMLElement {\n  constructor (props) {\n    super();\n    this.attachShadow({ mode: 'open' });\n    const style = document.createElement('style');\n    style.textContent = baseStyles + EXTRA_STYLES;\n    this.shadowRoot.appendChild(style);\n    this._ctx = {\n      // Set defaults\n      locale: DEFAULT_LOCALE,\n      dataSource: DEFAULT_DATA_SOURCE,\n      skinToneEmoji: DEFAULT_SKIN_TONE_EMOJI,\n      customCategorySorting: DEFAULT_CATEGORY_SORTING,\n      customEmoji: null,\n      i18n: enI18n,\n      emojiVersion: null,\n      ...props\n    };\n    // Handle properties set before the element was upgraded\n    for (const prop of PROPS) {\n      if (prop !== 'database' && Object.prototype.hasOwnProperty.call(this, prop)) {\n        this._ctx[prop] = this[prop];\n        delete this[prop];\n      }\n    }\n    this._dbFlush(); // wait for a flush before creating the db, in case the user calls e.g. a setter or setAttribute\n  }\n\n  connectedCallback () {\n    // The _cmp may be defined if the component was immediately disconnected and then reconnected. In that case,\n    // do nothing (preserve the state)\n    if (!this._cmp) {\n      this._cmp = createRoot(this.shadowRoot, this._ctx);\n    }\n  }\n\n  disconnectedCallback () {\n    // Check in a microtask if the element is still connected. If so, treat this as a \"move\" rather than a disconnect\n    // Inspired by Vue: https://vuejs.org/guide/extras/web-components.html#building-custom-elements-with-vue\n    qM(() => {\n      // this._cmp may be defined if connect-disconnect-connect-disconnect occurs synchronously\n      if (!this.isConnected && this._cmp) {\n        this._cmp.$destroy();\n        this._cmp = undefined;\n\n        const { database } = this._ctx;\n        database.close()\n          // only happens if the database failed to load in the first place, so we don't care\n          .catch(err => console.error(err));\n      }\n    });\n  }\n\n  static get observedAttributes () {\n    return ['locale', 'data-source', 'skin-tone-emoji', 'emoji-version'] // complex objects aren't supported, also use kebab-case\n  }\n\n  attributeChangedCallback (attrName, oldValue, newValue) {\n    this._set(\n      // convert from kebab-case to camelcase\n      // see https://github.com/sveltejs/svelte/issues/3852#issuecomment-665037015\n      attrName.replace(/-([a-z])/g, (_, up) => up.toUpperCase()),\n      // convert string attribute to float if necessary\n      attrName === 'emoji-version' ? parseFloat(newValue) : newValue\n    );\n  }\n\n  _set (prop, newValue) {\n    this._ctx[prop] = newValue;\n    if (this._cmp) {\n      this._cmp.$set({ [prop]: newValue });\n    }\n    if (['locale', 'dataSource'].includes(prop)) {\n      this._dbFlush();\n    }\n  }\n\n  _dbCreate () {\n    const { locale, dataSource, database } = this._ctx;\n    // only create a new database if we really need to\n    if (!database || database.locale !== locale || database.dataSource !== dataSource) {\n      this._set('database', new Database({ locale, dataSource }));\n    }\n  }\n\n  // Update the Database in one microtask if the locale/dataSource change. We do one microtask\n  // so we don't create two Databases if e.g. both the locale and the dataSource change\n  _dbFlush () {\n    qM(() => (\n      this._dbCreate()\n    ));\n  }\n}\n\nconst definitions = {};\n\nfor (const prop of PROPS) {\n  definitions[prop] = {\n    get () {\n      if (prop === 'database') {\n        // in rare cases, the microtask may not be flushed yet, so we need to instantiate the DB\n        // now if the user is asking for it\n        this._dbCreate();\n      }\n      return this._ctx[prop]\n    },\n    set (val) {\n      if (prop === 'database') {\n        throw new Error('database is read-only')\n      }\n      this._set(prop, val);\n    }\n  };\n}\n\nObject.defineProperties(PickerElement.prototype, definitions);\n\n/* istanbul ignore else */\nif (!customElements.get('emoji-picker')) { // if already defined, do nothing (e.g. same script imported twice)\n  customElements.define('emoji-picker', PickerElement);\n}\n\nexport { PickerElement as default };\n","<template>\r\n\t<div class=\"chess-board-wrapper\">\r\n\t\t<!-- \r\n\t\t<div class=\"debug\">\r\n\t\t\tfen {{ fen }}<br />\r\n\t\t\tplayerColor {{ playerColor }}\r\n\t\t</div> -->\r\n\r\n\t\t<div class=\"chess-board\">\r\n\t\t\t<div\r\n\t\t\t\tv-for=\"square in squares\"\r\n\t\t\t\t:key=\"square\"\r\n\t\t\t\t:class=\"[\r\n\t\t\t\t\t'square',\r\n\t\t\t\t\tisLightSquare(square) ? 'light' : 'dark',\r\n\t\t\t\t\t{ selected: selectedSquare === square },\r\n\t\t\t\t\t{ 'valid-move': validMoves.includes(square) },\r\n\t\t\t\t\t{ dragging: draggedPiece === square },\r\n\t\t\t\t]\"\r\n\t\t\t\t@click=\"handleSquareClick(square)\"\r\n\t\t\t\t@dragover=\"handleDragOver\"\r\n\t\t\t\t@drop=\"handleDrop($event, square)\"\r\n\t\t\t\t@touchend=\"handleTouchEnd($event, square)\"\r\n\t\t\t>\r\n\t\t\t\t<div\r\n\t\t\t\t\tv-if=\"getPieceAt(square)\"\r\n\t\t\t\t\t:class=\"['piece', getPieceColor(square)]\"\r\n\t\t\t\t\tdraggable=\"true\"\r\n\t\t\t\t\t@dragstart=\"handleDragStart($event, square)\"\r\n\t\t\t\t\t@dragend=\"handleDragEnd\"\r\n\t\t\t\t\t@touchstart=\"handleTouchStart($event, square)\"\r\n\t\t\t\t\t@touchmove=\"handleTouchMove\"\r\n\t\t\t\t>\r\n\t\t\t\t\t{{ getPieceAt(square) }}\r\n\t\t\t\t</div>\r\n\t\t\t\t<div v-if=\"validMoves.includes(square)\" class=\"move-indicator\"></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\r\n\t\t<!-- History controls -->\r\n\t\t<!-- history controls moved to parent -->\r\n\t</div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { Chess } from 'chess.js';\r\nimport { computed, ref, watch } from 'vue';\r\n\r\ninterface Props {\r\n\tfen: string;\r\n\tplayerColor: 'white' | 'black';\r\n\tisViewingHistory?: boolean;\r\n\tisDrawOffered?: boolean;\r\n}\r\n\r\nconst props = defineProps<Props>();\r\nconst emit = defineEmits<{\r\n\tmove: [move: { from: string; to: string; promotion?: string }];\r\n\tblockedMove: [];\r\n}>();\r\n\r\nconst game = ref(new Chess(props.fen));\r\nconst selectedSquare = ref<string | null>(null);\r\nconst validMoves = ref<string[]>([]);\r\nconst draggedPiece = ref<string | null>(null);\r\n\r\n// Parent can indicate when the board is in history-viewing mode\r\n// (when the parent is showing a past position and moving should be disabled)\r\n// `props.viewingHistory` is optional and treated as boolean\r\n\r\n// Support parent prop `isViewingHistory` (use `props.isViewingHistory` at runtime)\r\nconst isViewingHistory = computed(() => !!(props as any).isViewingHistory);\r\n\r\n// Support parent prop `isDrawOffered` to block moves when a draw is offered\r\nconst isDrawOffered = computed(() => !!(props as any).isDrawOffered);\r\n\r\n// Unicode chess pieces\r\nconst pieceSymbols: Record<string, string> = {\r\n\tp: '',\r\n\tr: '',\r\n\tn: '',\r\n\tb: '',\r\n\tq: '',\r\n\tk: '',\r\n\tP: '',\r\n\tR: '',\r\n\tN: '',\r\n\tB: '',\r\n\tQ: '',\r\n\tK: '',\r\n};\r\n\r\n// Watch for FEN changes and update the game\r\nwatch(\r\n\t() => props.fen,\r\n\t(newFen) => {\r\n\t\t// Update local game to the incoming FEN\r\n\t\tif (newFen) game.value = new Chess(newFen);\r\n\r\n\t\tselectedSquare.value = null;\r\n\t\tvalidMoves.value = [];\r\n\t}\r\n);\r\n\r\n// Generate board squares (a1-h8)\r\nconst squares = computed(() => {\r\n\tconst files =\r\n\t\tprops.playerColor === 'white'\r\n\t\t\t? ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h']\r\n\t\t\t: ['h', 'g', 'f', 'e', 'd', 'c', 'b', 'a'];\r\n\tconst ranks =\r\n\t\tprops.playerColor === 'white'\r\n\t\t\t? [8, 7, 6, 5, 4, 3, 2, 1]\r\n\t\t\t: [1, 2, 3, 4, 5, 6, 7, 8];\r\n\tconst result: string[] = [];\r\n\r\n\tfor (const rank of ranks) {\r\n\t\tfor (const file of files) {\r\n\t\t\tresult.push(`${file}${rank}`);\r\n\t\t}\r\n\t}\r\n\r\n\treturn result;\r\n});\r\n\r\nfunction getPieceAt(square: string): string | null {\r\n\tconst piece = game.value.get(square as any);\r\n\treturn piece\r\n\t\t? pieceSymbols[\r\n\t\t\t\tpiece.type.toUpperCase() === piece.type\r\n\t\t\t\t\t? piece.type.toUpperCase()\r\n\t\t\t\t\t: piece.type.toLowerCase()\r\n\t\t  ]\r\n\t\t: null;\r\n}\r\n\r\nfunction getPieceColor(square: string): 'white' | 'black' | null {\r\n\tconst piece = game.value.get(square as any);\r\n\treturn piece ? (piece.color === 'w' ? 'white' : 'black') : null;\r\n}\r\n\r\nfunction isLightSquare(square: string): boolean {\r\n\tconst file = square.charCodeAt(0) - 97; // a=0, b=1, etc.\r\n\tconst rank = parseInt(square[1]) - 1;\r\n\treturn (file + rank) % 2 === 1;\r\n}\r\n\r\nfunction handleSquareClick(square: string) {\r\n\t// When viewing history (not on the latest move), disable moving\r\n\tif (isViewingHistory.value) return;\r\n\t// When a draw is offered, disable moving but notify parent\r\n\tif (isDrawOffered.value) {\r\n\t\temit('blockedMove');\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst piece = game.value.get(square as any);\r\n\tconst currentTurn = game.value.turn() === 'w' ? 'white' : 'black';\r\n\r\n\t// If clicking on own piece, select it\r\n\tif (\r\n\t\tpiece &&\r\n\t\tgetPieceColor(square) === props.playerColor &&\r\n\t\tcurrentTurn === props.playerColor\r\n\t) {\r\n\t\tselectedSquare.value = square;\r\n\t\tconst moves = game.value.moves({ square: square as any, verbose: true });\r\n\t\tvalidMoves.value = moves.map((m: any) => m.to);\r\n\t}\r\n\t// If a square is selected and clicking on a valid move\r\n\telse if (selectedSquare.value && validMoves.value.includes(square)) {\r\n\t\tmakeMove(selectedSquare.value, square);\r\n\t}\r\n\t// Otherwise, deselect\r\n\telse {\r\n\t\tselectedSquare.value = null;\r\n\t\tvalidMoves.value = [];\r\n\t}\r\n}\r\n\r\nfunction makeMove(from: string, to: string) {\r\n\tconst piece = game.value.get(from as any);\r\n\r\n\t// Build move object for chess.js\r\n\tconst moveObj: any = { from, to };\r\n\r\n\t// Check for pawn promotion\r\n\tif (\r\n\t\tpiece &&\r\n\t\tpiece.type === 'p' &&\r\n\t\t((piece.color === 'w' && to[1] === '8') ||\r\n\t\t\t(piece.color === 'b' && to[1] === '1'))\r\n\t) {\r\n\t\t// Auto-promote to queen for simplicity\r\n\t\tmoveObj.promotion = 'q';\r\n\t}\r\n\r\n\t// Apply the move locally so UI updates immediately\r\n\tconst result = game.value.move(moveObj);\r\n\r\n\tif (result) {\r\n\t\t// Emit move to parent\r\n\t\tif (moveObj.promotion)\r\n\t\t\temit('move', { from, to, promotion: moveObj.promotion });\r\n\t\telse emit('move', { from, to });\r\n\t} else {\r\n\t\t// If move invalid, do not emit\r\n\t}\r\n\r\n\tselectedSquare.value = null;\r\n\tvalidMoves.value = [];\r\n}\r\n\r\n// Drag and drop handlers\r\nfunction handleDragStart(event: DragEvent, square: string) {\r\n\t// disable dragging when parent indicates history view\r\n\tif (isViewingHistory.value) {\r\n\t\tevent.preventDefault();\r\n\t\treturn;\r\n\t}\r\n\t// disable dragging when a draw is offered\r\n\tif (isDrawOffered.value) {\r\n\t\tevent.preventDefault();\r\n\t\temit('blockedMove');\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst piece = game.value.get(square as any);\r\n\tconst currentTurn = game.value.turn() === 'w' ? 'white' : 'black';\r\n\r\n\tif (\r\n\t\t!piece ||\r\n\t\tgetPieceColor(square) !== props.playerColor ||\r\n\t\tcurrentTurn !== props.playerColor\r\n\t) {\r\n\t\tevent.preventDefault();\r\n\t\treturn;\r\n\t}\r\n\r\n\tdraggedPiece.value = square;\r\n\tselectedSquare.value = square;\r\n\tconst moves = game.value.moves({ square: square as any, verbose: true });\r\n\tvalidMoves.value = moves.map((m: any) => m.to);\r\n\r\n\tif (event.dataTransfer) {\r\n\t\tevent.dataTransfer.effectAllowed = 'move';\r\n\t\tevent.dataTransfer.setData('text/plain', square);\r\n\t}\r\n}\r\n\r\nfunction handleDragOver(event: DragEvent) {\r\n\tevent.preventDefault();\r\n\tif (event.dataTransfer) {\r\n\t\tevent.dataTransfer.dropEffect = 'move';\r\n\t}\r\n}\r\n\r\nfunction handleDrop(event: DragEvent, square: string) {\r\n\tevent.preventDefault();\r\n\r\n\tif (isViewingHistory.value) return;\r\n\tif (isDrawOffered.value) return;\r\n\r\n\tif (draggedPiece.value && validMoves.value.includes(square)) {\r\n\t\tmakeMove(draggedPiece.value, square);\r\n\t}\r\n\r\n\tdraggedPiece.value = null;\r\n\tselectedSquare.value = null;\r\n\tvalidMoves.value = [];\r\n}\r\n\r\nfunction handleDragEnd() {\r\n\tif (!draggedPiece.value) return;\r\n\r\n\t// If drag ended without a valid drop, just clear the selection\r\n\tdraggedPiece.value = null;\r\n\tselectedSquare.value = null;\r\n\tvalidMoves.value = [];\r\n}\r\n\r\nfunction handleTouchStart(event: TouchEvent, square: string) {\r\n\t// disable touch moving when viewing history\r\n\tif (isViewingHistory.value) return;\r\n\t// disable touch moving when a draw is offered\r\n\tif (isDrawOffered.value) {\r\n\t\temit('blockedMove');\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst piece = game.value.get(square as any);\r\n\tconst currentTurn = game.value.turn() === 'w' ? 'white' : 'black';\r\n\r\n\tif (\r\n\t\t!piece ||\r\n\t\tgetPieceColor(square) !== props.playerColor ||\r\n\t\tcurrentTurn !== props.playerColor\r\n\t) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tevent.preventDefault();\r\n\tdraggedPiece.value = square;\r\n\tselectedSquare.value = square;\r\n\tconst moves = game.value.moves({ square: square as any, verbose: true });\r\n\tvalidMoves.value = moves.map((m: any) => m.to);\r\n}\r\n\r\n// History navigation is handled by parent component\r\nfunction handleTouchMove(event: TouchEvent) {\r\n\tif (!draggedPiece.value) return;\r\n\tevent.preventDefault();\r\n}\r\n\r\nfunction handleTouchEnd(event: TouchEvent, square: string) {\r\n\tif (!draggedPiece.value) return;\r\n\r\n\t// disable touch drops when viewing history\r\n\tif (isViewingHistory.value) return;\r\n\t// disable touch drops when a draw is offered\r\n\tif (isDrawOffered.value) return;\r\n\r\n\tevent.preventDefault();\r\n\r\n\tif (validMoves.value.includes(square)) {\r\n\t\tmakeMove(draggedPiece.value, square);\r\n\t} else {\r\n\t\t// Just clicked the same square - keep it selected\r\n\t\tif (draggedPiece.value !== square) {\r\n\t\t\tdraggedPiece.value = null;\r\n\t\t\tselectedSquare.value = null;\r\n\t\t\tvalidMoves.value = [];\r\n\t\t}\r\n\t}\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.chess-board-wrapper {\r\n\tposition: relative;\r\n\twidth: 100%;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\talign-items: center;\r\n\tgap: 12px;\r\n\t/* legacy padding removed since history is handled by parent */\r\n\tpadding-bottom: 12px;\r\n}\r\n\r\n.debug {\r\n\tposition: absolute;\r\n\ttop: 8px;\r\n\tleft: 8px;\r\n\tbackground: rgba(255, 255, 255, 0.9);\r\n\tcolor: #111;\r\n\tpadding: 6px 10px;\r\n\tborder-radius: 6px;\r\n\tfont-size: 0.85rem;\r\n\tz-index: 20;\r\n\tbox-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);\r\n}\r\n\r\n.chess-board {\r\n\tdisplay: grid !important;\r\n\t/* explicit 8x8 grid with resilient sizing */\r\n\tgrid-auto-flow: row;\r\n\tgrid-template-columns: repeat(8, minmax(0, 1fr));\r\n\tgrid-template-rows: repeat(8, minmax(0, 1fr));\r\n\twidth: 100%;\r\n\t/* let the board size by its intrinsic aspect ratio so the wrapper can grow\r\n\t   and show the controls below it instead of clipping them */\r\n\theight: auto;\r\n\taspect-ratio: 1 / 1;\r\n\tborder: 2px solid #333;\r\n\tbox-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\r\n\tmargin: 0 auto;\r\n\tuser-select: none;\r\n\ttouch-action: manipulation;\r\n}\r\n\r\n.square {\r\n\tposition: relative;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\t/* make sure each grid cell occupies the expected cell area */\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tbox-sizing: border-box;\r\n\tcursor: pointer;\r\n\ttransition: background-color 0.2s;\r\n}\r\n\r\n.square.light {\r\n\tbackground-color: #f0d9b5;\r\n}\r\n\r\n.square.dark {\r\n\tbackground-color: #b58863;\r\n}\r\n\r\n.square.selected {\r\n\tbackground-color: #7fc97f !important;\r\n\tbox-shadow: inset 0 0 0 3px #4a9d4a;\r\n}\r\n\r\n.square.valid-move {\r\n\tcursor: pointer;\r\n}\r\n\r\n.square.dragging {\r\n\topacity: 0.5;\r\n}\r\n\r\n.piece {\r\n\tfont-size: clamp(2rem, 8vw, 3.5rem);\r\n\tline-height: 1;\r\n\tcursor: grab;\r\n\ttouch-action: manipulation;\r\n\tpointer-events: auto;\r\n\ttransition: transform 0.1s;\r\n}\r\n\r\n.piece:active {\r\n\tcursor: grabbing;\r\n\ttransform: scale(1.1);\r\n}\r\n\r\n.piece.white {\r\n\tcolor: #fff;\r\n\ttext-shadow: 0 0 2px #000, 0 0 4px #000;\r\n}\r\n\r\n.piece.black {\r\n\tcolor: #000;\r\n\ttext-shadow: 0 0 2px #fff, 0 0 4px #fff;\r\n}\r\n\r\n.move-indicator {\r\n\tposition: absolute;\r\n\twidth: 25%;\r\n\theight: 25%;\r\n\tbackground-color: rgba(0, 128, 0, 0.5);\r\n\tborder-radius: 50%;\r\n\tpointer-events: none;\r\n}\r\n\r\n.square.valid-move:hover {\r\n\tbackground-color: rgba(127, 201, 127, 0.3);\r\n}\r\n\r\n/* Mobile optimizations */\r\n@media (max-width: 600px) {\r\n\t.chess-board {\r\n\t\twidth: 100%;\r\n\t\tmax-width: 95vw;\r\n\t\tborder-width: 1px;\r\n\t\taspect-ratio: 1;\r\n\t}\r\n\t.piece {\r\n\t\tfont-size: clamp(1.5rem, 8vw, 2.5rem);\r\n\t}\r\n\t.chess-board-wrapper {\r\n\t\twidth: 100%;\r\n\t\tmax-width: 95vw;\r\n\t}\r\n}\r\n\r\n.history-bar {\r\n\t/* fixed to viewport bottom-center so controls are always visible */\r\n\tposition: fixed;\r\n\tbottom: 18px;\r\n\tleft: 50%;\r\n\ttransform: translateX(-50%);\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tgap: 8px;\r\n\tbackground: rgba(255, 255, 255, 0.96);\r\n\tpadding: 6px 12px;\r\n\tborder-radius: 20px;\r\n\tbox-shadow: 0 6px 18px rgba(0, 0, 0, 0.22);\r\n\tz-index: 9999;\r\n\tpointer-events: auto;\r\n}\r\n\r\n.history-message {\r\n\tfont-size: 0.85rem;\r\n\tcolor: #333;\r\n\tbackground: transparent;\r\n\tpadding: 0 6px 0 0;\r\n\tborder-radius: 4px;\r\n\tfont-weight: 600;\r\n}\r\n\r\n.history-controls {\r\n\tdisplay: inline-flex;\r\n\talign-items: center;\r\n\tgap: 8px;\r\n}\r\n\r\n.history-btn {\r\n\tbackground: #222;\r\n\tcolor: #fff;\r\n\tborder: none;\r\n\tpadding: 6px 10px;\r\n\tborder-radius: 6px;\r\n\tfont-size: 1.1rem;\r\n\tcursor: pointer !important;\r\n\tbox-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);\r\n}\r\n\r\n.history-btn[disabled] {\r\n\topacity: 0.35;\r\n\tcursor: pointer !important;\r\n}\r\n\r\n.history-pos {\r\n\tfont-size: 0.85rem;\r\n\tcolor: #222;\r\n\tbackground: #f3f3f3;\r\n\tpadding: 4px 8px;\r\n\tborder-radius: 6px;\r\n}\r\n\r\n@media (max-width: 600px) {\r\n\t.history-bar {\r\n\t\tpadding: 4px 8px;\r\n\t}\r\n\t.history-btn {\r\n\t\tpadding: 5px 8px;\r\n\t\tfont-size: 1rem;\r\n\t}\r\n}\r\n</style>\r\n","// Maximum time allowed for a move in minutes\r\nexport const maxMoveTimeMins = 8;\r\nexport const newGameProbability = 0.02;\r\nexport const scoreFactor = 20;\r\nexport const minMovesToEnableDrawOffers = 4;\r\n","<template>\r\n\t<div class=\"container\" v-cloak>\r\n\t\t<div class=\"game-container\">\r\n\t\t\t<div class=\"game-header\">\r\n\t\t\t\t<h1>\r\n\t\t\t\t\t<img src=\"/logo-small.jpg\" alt=\"DistroChess\" class=\"game-logo\" />\r\n\t\t\t\t\t<span class=\"game-title-text\">{{ t.distroChess }}</span>\r\n\t\t\t\t\t<NuxtLink to=\"/faq\" class=\"btn-faq\">\r\n\t\t\t\t\t\t{{ t.faq.linkLabel }}\r\n\t\t\t\t\t</NuxtLink>\r\n\t\t\t\t\t<NuxtLink to=\"/leaderboard\" class=\"btn-faq\">\r\n\t\t\t\t\t\t{{ t.leaderboard.linkLabel }}\r\n\t\t\t\t\t</NuxtLink>\r\n\t\t\t\t</h1>\r\n\t\t\t\t<div class=\"user-info\">\r\n\t\t\t\t\t<div class=\"profile-dropdown\">\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tclass=\"btn-profile\"\r\n\t\t\t\t\t\t\t@click=\"toggleProfileMenu\"\r\n\t\t\t\t\t\t\t:aria-label=\"t.profile.button\"\r\n\t\t\t\t\t\t\tref=\"profileButton\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<svg\r\n\t\t\t\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\"\r\n\t\t\t\t\t\t\t\tviewBox=\"0 0 512 512\"\r\n\t\t\t\t\t\t\t\twidth=\"24\"\r\n\t\t\t\t\t\t\t\theight=\"24\"\r\n\t\t\t\t\t\t\t\tfill=\"currentColor\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<path\r\n\t\t\t\t\t\t\t\t\td=\"M256 0c141.385 0 256 114.615 256 256S397.385 512 256 512 0 397.385 0 256 114.615 0 256 0zm0 480c123.712 0 224-100.288 224-224S379.712 32 256 32 32 132.288 32 256s100.288 224 224 224z\"\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t<path\r\n\t\t\t\t\t\t\t\t\td=\"M256 192c35.346 0 64-28.654 64-64s-28.654-64-64-64-64 28.654-64 64 28.654 64 64 64zm0-96c17.673 0 32 14.327 32 32s-14.327 32-32 32-32-14.327-32-32 14.327-32 32-32zm116.8 192c-22.4-28.8-67.2-48-116.8-48s-94.4 19.2-116.8 48c-6.4 9.6-9.6 19.2-9.6 32 0 35.2 28.8 64 64 64h128c35.2 0 64-28.8 64-64 0-12.8-3.2-22.4-12.8-32zm-180.8 64c-17.6 0-32-14.4-32-32 0-3.2 0-6.4 3.2-9.6 12.8-19.2 51.2-38.4 92.8-38.4s80 19.2 92.8 38.4c3.2 3.2 3.2 6.4 3.2 9.6 0 17.6-14.4 32-32 32H192z\"\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t</svg>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<Teleport to=\"body\">\r\n\t\t\t\t\t\t\t<div\r\n\t\t\t\t\t\t\t\tv-if=\"isShowingProfileMenu\"\r\n\t\t\t\t\t\t\t\tclass=\"profile-menu\"\r\n\t\t\t\t\t\t\t\t:style=\"profileMenuPosition\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<div class=\"profile-menu-header\">\r\n\t\t\t\t\t\t\t\t\t<strong>{{ displayUser?.name }}</strong>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div class=\"profile-menu-item\">\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-label\">{{ t.profile.score }}</span>\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-value\">{{\r\n\t\t\t\t\t\t\t\t\t\tMath.round(displayUser?.score ?? 0)\r\n\t\t\t\t\t\t\t\t\t}}</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div class=\"profile-menu-item\">\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-label\">{{ t.profile.wins }}</span>\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-value\">{{\r\n\t\t\t\t\t\t\t\t\t\tdisplayUser?.wins?.length ?? 0\r\n\t\t\t\t\t\t\t\t\t}}</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div class=\"profile-menu-item\">\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-label\">{{ t.profile.losses }}</span>\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-value\">{{\r\n\t\t\t\t\t\t\t\t\t\tdisplayUser?.losses?.length ?? 0\r\n\t\t\t\t\t\t\t\t\t}}</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div class=\"profile-menu-item\">\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-label\">{{ t.profile.draws }}</span>\r\n\t\t\t\t\t\t\t\t\t<span class=\"profile-value\">{{\r\n\t\t\t\t\t\t\t\t\t\tdisplayUser?.draws?.length ?? 0\r\n\t\t\t\t\t\t\t\t\t}}</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div class=\"profile-menu-divider\"></div>\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tclass=\"profile-menu-settings\"\r\n\t\t\t\t\t\t\t\t\t@click=\"navigateToSettings\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<img src=\"/settings.svg\" alt=\"\" class=\"settings-icon-small\" />\r\n\t\t\t\t\t\t\t\t\t{{ t.settings.button }}\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tclass=\"profile-menu-settings btn-signout\"\r\n\t\t\t\t\t\t\t\t\t@click=\"handleSignout\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t{{ t.signout }}\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</Teleport>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\tclass=\"btn-team-chat\"\r\n\t\t\t\t\t\t@click=\"toggleChatModal\"\r\n\t\t\t\t\t\t:disabled=\"!canUseTeamChat || !currentGame\"\r\n\t\t\t\t\t\t:title=\"!canUseTeamChat ? t.teamChat.disabledHint : undefined\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t{{ t.teamChat.button }}\r\n\t\t\t\t\t\t<span v-if=\"chatUnreadCount > 0\" class=\"chat-badge\">\r\n\t\t\t\t\t\t\t{{ chatUnreadCount }}\r\n\t\t\t\t\t\t</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\t\t\t<div v-if=\"errorMessage\" class=\"game-alert\">\r\n\t\t\t\t{{ errorMessage }}\r\n\t\t\t</div>\r\n\r\n\t\t\t<div v-if=\"isGameLoading\" class=\"game-status\">\r\n\t\t\t\t<p>{{ t.loadingGame }}</p>\r\n\t\t\t</div>\r\n\t\t\t<div v-else-if=\"!currentGame\" class=\"game-status\">\r\n\t\t\t\t<p>{{ t.waitingForOpponent }}</p>\r\n\t\t\t\t<div class=\"loading-spinner\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div v-else class=\"active-game\">\r\n\t\t\t\t<div class=\"chessboard-area\">\r\n\t\t\t\t\t<ChessBoard\r\n\t\t\t\t\t\t:fen=\"displayFen\"\r\n\t\t\t\t\t\t:player-color=\"playerColor\"\r\n\t\t\t\t\t\t:is-viewing-history=\"isViewingHistory\"\r\n\t\t\t\t\t\t:is-draw-offered=\"isDrawOfferedToUser\"\r\n\t\t\t\t\t\t@move=\"handleMove\"\r\n\t\t\t\t\t\t@blocked-move=\"handleBlockedMove\"\r\n\t\t\t\t\t/>\r\n\r\n\t\t\t\t\t<div class=\"parent-history-bar\">\r\n\t\t\t\t\t\t<div class=\"history-row\">\r\n\t\t\t\t\t\t\t<div class=\"history-controls\">\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tclass=\"history-btn\"\r\n\t\t\t\t\t\t\t\t\t@click.prevent=\"goBack\"\r\n\t\t\t\t\t\t\t\t\t:disabled=\"isAtStart\"\r\n\t\t\t\t\t\t\t\t\t:aria-label=\"t.previousPosition\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t<span class=\"history-pos\"\r\n\t\t\t\t\t\t\t\t\t>{{ historyIndex + 1 }} / {{ totalPositions }}</span\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tclass=\"history-btn\"\r\n\t\t\t\t\t\t\t\t\t@click.prevent=\"goForward\"\r\n\t\t\t\t\t\t\t\t\t:disabled=\"isAtEnd\"\r\n\t\t\t\t\t\t\t\t\t:aria-label=\"t.nextPosition\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tv-if=\"isViewingHistory\"\r\n\t\t\t\t\t\t\tclass=\"history-pill history-pill-btn\"\r\n\t\t\t\t\t\t\t@click=\"exitHistory\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{{ t.exitHistory }}\r\n\t\t\t\t\t\t</button>\r\n\r\n\t\t\t\t\t\t<div\r\n\t\t\t\t\t\t\tclass=\"history-player\"\r\n\t\t\t\t\t\t\tv-if=\"currentGame && currentMovePlayerData\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<span class=\"move-by\">{{\r\n\t\t\t\t\t\t\t\tisViewingHistory ? t.moveBy : t.lastMoveBy\r\n\t\t\t\t\t\t\t}}</span>\r\n\t\t\t\t\t\t\t<span class=\"move-name\"\r\n\t\t\t\t\t\t\t\t>{{ currentMovePlayerData.name }} ({{ t.score }} :\r\n\t\t\t\t\t\t\t\t{{ Math.round(currentMovePlayerData.score) }})</span\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"game-id-container\">\r\n\t\t\t\t\t\t\t{{ t.gameId }}: <span id=\"game-id\">{{ currentGame.id }}</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"timer-section timer-below\">\r\n\t\t\t\t\t<h3 v-if=\"!isDrawOfferedToUser\">{{ t.yourTurn }}</h3>\r\n\t\t\t\t\t<h3 v-else class=\"draw-offered-title\">{{ t.drawOffered.title }}</h3>\r\n\t\t\t\t\t<div class=\"timer\" v-if=\"!isDrawOfferedToUser\">\r\n\t\t\t\t\t\t<!-- <div class=\"timer-label\">{{ t.timeRemaining }}:</div> -->\r\n\t\t\t\t\t\t<div class=\"timer-value\" :class=\"{ warning: timeRemaining < 20 }\">\r\n\t\t\t\t\t\t\t{{ formatTime(timeRemaining) }}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div v-if=\"isDrawOfferedToUser\" class=\"draw-offered-actions\">\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t:class=\"['btn-accept-draw', { pulse: isPulsingDrawButtons }]\"\r\n\t\t\t\t\t\t\t@click=\"handleAcceptDraw\"\r\n\t\t\t\t\t\t\t:disabled=\"!currentGame\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{{ t.drawOffered.accept }}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t:class=\"['btn-decline-draw', { pulse: isPulsingDrawButtons }]\"\r\n\t\t\t\t\t\t\t@click=\"handleDeclineDraw\"\r\n\t\t\t\t\t\t\t:disabled=\"!currentGame\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{{ t.drawOffered.decline }}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div v-else class=\"pass-btn-container\">\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tclass=\"btn-pass\"\r\n\t\t\t\t\t\t\t@click=\"handlePass\"\r\n\t\t\t\t\t\t\t:disabled=\"!currentGame\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{{ t.pass }}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tclass=\"btn-offer-draw\"\r\n\t\t\t\t\t\t\t@click=\"showOfferDrawModal\"\r\n\t\t\t\t\t\t\t:disabled=\"!currentGame || !canOfferDraw\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{{ t.offerDraw }}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t<div\r\n\t\tv-if=\"isShowWinModal\"\r\n\t\tclass=\"modal-overlay\"\r\n\t\t@click=\"isShowWinModal = false\"\r\n\t>\r\n\t\t<div class=\"modal-content\" @click.stop>\r\n\t\t\t<div class=\"win-header\">\r\n\t\t\t\t<span class=\"win-icon\" aria-hidden=\"true\"></span>\r\n\t\t\t\t<h1 class=\"win-title\">{{ t.winCongrats }}</h1>\r\n\t\t\t\t<span class=\"win-icon\" aria-hidden=\"true\"></span>\r\n\t\t\t</div>\r\n\t\t\t<p class=\"score-change\">\r\n\t\t\t\t{{\r\n\t\t\t\t\tt.winScoreChange({\r\n\t\t\t\t\t\tprevScore: prevScore ? Math.round(prevScore) : '?',\r\n\t\t\t\t\t\tnewScore: newScore ? Math.round(newScore) : '?',\r\n\t\t\t\t\t})\r\n\t\t\t\t}}\r\n\t\t\t</p>\r\n\t\t\t<button class=\"close-btn\" @click=\"isShowWinModal = false\">\r\n\t\t\t\t{{ t.close }}\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t</div>\r\n\t<div\r\n\t\tv-else-if=\"isShowDrawModal\"\r\n\t\tclass=\"modal-overlay\"\r\n\t\t@click=\"isShowDrawModal = false\"\r\n\t>\r\n\t\t<div class=\"modal-content\" @click.stop>\r\n\t\t\t<h1 class=\"win-title\">{{ t.gameDrawn }}</h1>\r\n\t\t\t<p class=\"score-change\">\r\n\t\t\t\t{{ t.noScoreChange }}\r\n\t\t\t</p>\r\n\t\t\t<button class=\"close-btn\" @click=\"isShowDrawModal = false\">\r\n\t\t\t\t{{ t.close }}\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t<div\r\n\t\tv-if=\"isMoveErrorModalVisible\"\r\n\t\tclass=\"modal-overlay error-modal\"\r\n\t\t@click=\"hideMoveErrorModal\"\r\n\t>\r\n\t\t<div class=\"modal-content error-modal-content\" @click.stop>\r\n\t\t\t<h2 class=\"error-title\">{{ t.moveErrors.notYourTurnTitle }}</h2>\r\n\t\t\t<p class=\"error-message\">{{ moveErrorModalMessage }}</p>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t<div\r\n\t\tv-if=\"isOfferDrawModalVisible\"\r\n\t\tclass=\"modal-overlay\"\r\n\t\t@click=\"isOfferDrawModalVisible = false\"\r\n\t>\r\n\t\t<div class=\"modal-content\" @click.stop>\r\n\t\t\t<h2 class=\"modal-title\">{{ t.drawOffer.title }}</h2>\r\n\t\t\t<p class=\"modal-message\" v-html=\"t.drawOffer.message\"></p>\r\n\t\t\t<div class=\"modal-actions\">\r\n\t\t\t\t<button class=\"btn-primary\" @click=\"handleOfferDraw\">\r\n\t\t\t\t\t{{ t.drawOffer.confirm }}\r\n\t\t\t\t</button>\r\n\t\t\t\t<button class=\"btn-secondary\" @click=\"isOfferDrawModalVisible = false\">\r\n\t\t\t\t\t{{ t.drawOffer.cancel }}\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t<div\r\n\t\tv-if=\"isChatOpen\"\r\n\t\tclass=\"modal-overlay chat-overlay\"\r\n\t\t@click=\"closeChatModal\"\r\n\t>\r\n\t\t<div\r\n\t\t\tclass=\"chat-modal\"\r\n\t\t\trole=\"dialog\"\r\n\t\t\taria-modal=\"true\"\r\n\t\t\t:aria-label=\"t.teamChat.title\"\r\n\t\t\t@click.stop\r\n\t\t>\r\n\t\t\t<div class=\"chat-header\">\r\n\t\t\t\t<div>\r\n\t\t\t\t\t<h2>{{ t.teamChat.title }}</h2>\r\n\t\t\t\t\t<p class=\"chat-subtitle\">{{ t.teamChat.subtitle }}</p>\r\n\t\t\t\t</div>\r\n\t\t\t\t<button\r\n\t\t\t\t\tclass=\"chat-close\"\r\n\t\t\t\t\t@click=\"closeChatModal\"\r\n\t\t\t\t\t:aria-label=\"t.close\"\r\n\t\t\t\t>\r\n\t\t\t\t\t\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t\t<div v-if=\"chatErrorMessage\" class=\"chat-error\">\r\n\t\t\t\t{{ chatErrorMessage }}\r\n\t\t\t</div>\r\n\t\t\t<div class=\"chat-body\" ref=\"chatBodyRef\">\r\n\t\t\t\t<div v-if=\"isChatLoading && !chatMessages.length\" class=\"chat-loading\">\r\n\t\t\t\t\t{{ t.teamChat.loading }}\r\n\t\t\t\t</div>\r\n\t\t\t\t<div v-else-if=\"!chatMessages.length\" class=\"chat-empty\">\r\n\t\t\t\t\t{{ t.teamChat.empty }}\r\n\t\t\t\t</div>\r\n\t\t\t\t<div v-else class=\"chat-messages\">\r\n\t\t\t\t\t<div\r\n\t\t\t\t\t\tv-for=\"msg in chatMessages\"\r\n\t\t\t\t\t\t:key=\"msg.id\"\r\n\t\t\t\t\t\tclass=\"chat-message\"\r\n\t\t\t\t\t\t:class=\"{ 'chat-message-self': msg.userId === user?._id }\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t<div class=\"chat-meta\">\r\n\t\t\t\t\t\t\t<span class=\"chat-author\">\r\n\t\t\t\t\t\t\t\t{{ resolveChatUserName(msg.userId) }}\r\n\t\t\t\t\t\t\t\t<span v-if=\"msg.userId === user?._id\" class=\"chat-self-tag\">\r\n\t\t\t\t\t\t\t\t\t{{ t.teamChat.you }}\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t<div class=\"chat-meta-details\">\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\t\t\t\tv-if=\"typeof msg.moveNumber === 'number'\"\r\n\t\t\t\t\t\t\t\t\tclass=\"chat-move\"\r\n\t\t\t\t\t\t\t\t\t@click=\"handleChatMoveJump(msg.moveNumber)\"\r\n\t\t\t\t\t\t\t\t\t:aria-label=\"\r\n\t\t\t\t\t\t\t\t\t\tt.teamChat.moveNumberLabel({ move: msg.moveNumber + 1 })\r\n\t\t\t\t\t\t\t\t\t\"\r\n\t\t\t\t\t\t\t\t\t:title=\"\r\n\t\t\t\t\t\t\t\t\t\tt.teamChat.moveNumberLabel({ move: msg.moveNumber + 1 })\r\n\t\t\t\t\t\t\t\t\t\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t{{ t.teamChat.moveNumberLabel({ move: msg.moveNumber + 1 }) }}\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t<span class=\"chat-time\">\r\n\t\t\t\t\t\t\t\t\t{{ formatChatTimestamp(msg.createdDateStr) }}\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<p class=\"chat-text\">{{ msg.message }}</p>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<form class=\"chat-form\" @submit.prevent=\"sendChatMessage\">\r\n\t\t\t\t<textarea\r\n\t\t\t\t\tclass=\"chat-input\"\r\n\t\t\t\t\trows=\"3\"\r\n\t\t\t\t\tv-model=\"chatInput\"\r\n\t\t\t\t\t:placeholder=\"t.teamChat.placeholder\"\r\n\t\t\t\t\t@keydown.enter.exact.prevent=\"sendChatMessage\"\r\n\t\t\t\t></textarea>\r\n\t\t\t\t<div class=\"chat-form-actions\">\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\t\tclass=\"chat-emoji-btn\"\r\n\t\t\t\t\t\t:aria-pressed=\"isEmojiPickerOpen\"\r\n\t\t\t\t\t\t@click=\"toggleEmojiPicker\"\r\n\t\t\t\t\t\t:title=\"t.teamChat.emojiToggle\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\ttype=\"submit\"\r\n\t\t\t\t\t\tclass=\"chat-send-btn\"\r\n\t\t\t\t\t\t:disabled=\"isChatSending || !chatInput.trim()\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t{{ isChatSending ? t.teamChat.sending : t.teamChat.send }}\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t\t<emoji-picker\r\n\t\t\t\t\tv-if=\"isEmojiPickerOpen\"\r\n\t\t\t\t\tclass=\"emoji-picker\"\r\n\t\t\t\t\t@emoji-click=\"handleEmojiSelect\"\r\n\t\t\t\t/>\r\n\t\t\t</form>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { Chess } from 'chess.js';\r\nimport 'emoji-picker-element';\r\nimport { computed, nextTick, onMounted, onUnmounted, ref, watch } from 'vue';\r\nimport ChessBoard from '~/components/ChessBoard.vue';\r\nimport { useAuth } from '~/composables/useAuth';\r\nimport { useEscapeKey } from '~/composables/useEscapeKey';\r\nimport { useI18n } from '~/composables/useI18n';\r\nimport { translateServerError } from '~/composables/useServerErrors';\r\nimport { maxMoveTimeMins, minMovesToEnableDrawOffers } from '~/constants/game';\r\nimport { formatDate } from '~/utils/formatDate';\r\n\r\ndefinePageMeta({\r\n\tssr: false,\r\n});\r\n\r\nconst router = useRouter();\r\nconst route = useRoute();\r\nconst { t, locale } = useI18n();\r\nconst { user, isAuthenticated, signout, getAuthHeader } = useAuth();\r\n\r\nconst currentGame = ref<any>(null);\r\nconst isGameLoading = ref(false);\r\nconst timeRemaining = ref(maxMoveTimeMins * 60);\r\nconst pollIntervalId = ref<ReturnType<typeof setInterval> | null>(null);\r\nconst timerIntervalId = ref<ReturnType<typeof setInterval> | null>(null);\r\nconst prevScore = ref<number | null>(null);\r\nconst newScore = ref<number | null>(null);\r\n\r\nconst isShowWinModal = ref(false);\r\nconst isShowDrawModal = ref(false);\r\nconst errorMessage = ref('');\r\nconst manualSignoutRedirect = ref<string | null>(null);\r\nlet loadSequence: Promise<void> = Promise.resolve();\r\nconst MOVE_ERROR_MODAL_DURATION_MS = 2000;\r\n\r\ntype TeamChatMessage = {\r\n\tid: string;\r\n\tgameId: string;\r\n\tside: 'white' | 'black';\r\n\tuserId: string;\r\n\tmessage: string;\r\n\tcreatedDateStr: string;\r\n\tmoveNumber: number | null;\r\n};\r\n\r\ntype EmojiClickEventDetail = {\r\n\tunicode?: string;\r\n\temoji?: {\r\n\t\tunicode?: string;\r\n\t};\r\n};\r\n\r\ntype TeamChatResponse = {\r\n\tmessages: TeamChatMessage[];\r\n\tlastSeenAt: string | null;\r\n};\r\n\r\nconst isChatOpen = ref(false);\r\nconst chatMessages = ref<TeamChatMessage[]>([]);\r\nconst chatInput = ref('');\r\nconst chatErrorMessage = ref('');\r\nconst isChatLoading = ref(false);\r\nconst isChatSending = ref(false);\r\nconst chatUnreadCount = ref(0);\r\nconst lastSeenChatTimestamp = ref<string | null>(null);\r\nconst lastPersistedChatTimestamp = ref<string | null>(null);\r\nconst pendingLastSeenUpload = ref<string | null>(null);\r\nconst isPersistingLastSeen = ref(false);\r\nconst chatBodyRef = ref<HTMLElement | null>(null);\r\nconst isEmojiPickerOpen = ref(false);\r\nconst pendingTimerReload = ref<LoadGameOptions | null>(null);\r\nconst isMoveErrorModalVisible = ref(false);\r\nconst moveErrorModalMessage = ref('');\r\nconst moveErrorModalTimerId = ref<ReturnType<typeof setTimeout> | null>(null);\r\n\r\nconst isShowingProfileMenu = ref(false);\r\nconst profileButton = ref<HTMLElement | null>(null);\r\nconst profileMenuPosition = ref<Record<string, string>>({});\r\nconst freshUserData = ref<any>(null);\r\nconst isOfferDrawModalVisible = ref(false);\r\nconst isPulsingDrawButtons = ref(false);\r\n\r\nconst isDrawOfferedToUser = computed(() => {\r\n\tif (!currentGame.value || !user.value) return false;\r\n\tconst drawOfferUserId = currentGame.value.drawOfferUserId;\r\n\tif (!drawOfferUserId) return false;\r\n\t// Draw is offered TO the current user if someone else offered it\r\n\treturn drawOfferUserId.toString() !== user.value._id.toString();\r\n});\r\n\r\nconst requestedGameId = computed(() => {\r\n\tconst raw = Array.isArray(route.query.gameId)\r\n\t\t? route.query.gameId[0]\r\n\t\t: route.query.gameId;\r\n\treturn typeof raw === 'string' && raw.length ? raw : undefined;\r\n});\r\n\r\nconst userTeamSide = computed<'white' | 'black' | null>(() => {\r\n\tif (currentGame.value && user.value) {\r\n\t\tif (listIncludesUser(currentGame.value.whiteUserIds, user.value._id)) {\r\n\t\t\treturn 'white';\r\n\t\t} else if (\r\n\t\t\tlistIncludesUser(currentGame.value.blackUserIds, user.value._id)\r\n\t\t) {\r\n\t\t\treturn 'black';\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n});\r\n\r\nconst canUseTeamChat = computed(() => {\r\n\t// console.log('canUseTeamChat:', currentGame.value, userTeamSide.value);\r\n\treturn Boolean(currentGame.value?._id && userTeamSide.value);\r\n});\r\n\r\nconst displayUser = computed(() => freshUserData.value || user.value);\r\n\r\nasync function fetchFreshUserData() {\r\n\tconst headers = getAuthHeader();\r\n\tif (!headers) return;\r\n\ttry {\r\n\t\tconst data = await $fetch('/api/user', { headers });\r\n\t\tfreshUserData.value = data;\r\n\t} catch (err) {\r\n\t\tconsole.error('Failed to fetch user data:', err);\r\n\t}\r\n}\r\n\r\nfunction listIncludesUser(list: any[] = [], value?: string | null) {\r\n\tif (!value) return false;\r\n\treturn list.some((entry) => entry?.toString?.() === value);\r\n}\r\n\r\nconst toggleProfileMenu = () => {\r\n\tisShowingProfileMenu.value = !isShowingProfileMenu.value;\r\n\r\n\tif (isShowingProfileMenu.value) {\r\n\t\tfetchFreshUserData();\r\n\t\tif (profileButton.value) {\r\n\t\t\tnextTick(() => {\r\n\t\t\t\tconst rect = profileButton.value!.getBoundingClientRect();\r\n\t\t\t\tconst menuWidth = 220; // min-width from CSS\r\n\t\t\t\tconst menuHeight = 350; // approximate height\r\n\t\t\t\tconst padding = 8;\r\n\t\t\t\tconst viewportWidth = window.innerWidth;\r\n\t\t\t\tconst viewportHeight = window.innerHeight;\r\n\r\n\t\t\t\t// Calculate initial position\r\n\t\t\t\tlet top = rect.bottom + padding;\r\n\t\t\t\tlet right = viewportWidth - rect.right;\r\n\r\n\t\t\t\t// Prevent overflow on the right\r\n\t\t\t\tconst leftPosition = viewportWidth - right - menuWidth;\r\n\t\t\t\tif (leftPosition < padding) {\r\n\t\t\t\t\tright = viewportWidth - menuWidth - padding;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Prevent overflow on the left\r\n\t\t\t\tif (right > viewportWidth - menuWidth - padding) {\r\n\t\t\t\t\tright = viewportWidth - menuWidth - padding;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Prevent overflow on the bottom\r\n\t\t\t\tif (top + menuHeight > viewportHeight - padding) {\r\n\t\t\t\t\t// Position above the button instead\r\n\t\t\t\t\ttop = rect.top - menuHeight - padding;\r\n\t\t\t\t\t// If still doesn't fit, position at the top with some padding\r\n\t\t\t\t\tif (top < padding) {\r\n\t\t\t\t\t\ttop = padding;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tprofileMenuPosition.value = {\r\n\t\t\t\t\tposition: 'fixed',\r\n\t\t\t\t\ttop: `${top}px`,\r\n\t\t\t\t\tright: `${right}px`,\r\n\t\t\t\t\tzIndex: '999999',\r\n\t\t\t\t};\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n};\r\n\r\nconst navigateToSettings = () => {\r\n\tisShowingProfileMenu.value = false;\r\n\trouter.push('/settings');\r\n};\r\n\r\nif (process.client) {\r\n\tonMounted(() => {\r\n\t\tconst handleClickOutside = (event: MouseEvent) => {\r\n\t\t\tconst target = event.target as HTMLElement;\r\n\t\t\tif (!target.closest('.profile-dropdown')) {\r\n\t\t\t\tisShowingProfileMenu.value = false;\r\n\t\t\t}\r\n\t\t};\r\n\t\tdocument.addEventListener('click', handleClickOutside);\r\n\t\tonUnmounted(() => {\r\n\t\t\tdocument.removeEventListener('click', handleClickOutside);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nuseEscapeKey((event) => {\r\n\tif (isShowingProfileMenu.value) {\r\n\t\tisShowingProfileMenu.value = false;\r\n\t\tevent.preventDefault();\r\n\t\treturn;\r\n\t}\r\n\tif (isOfferDrawModalVisible.value) {\r\n\t\tisOfferDrawModalVisible.value = false;\r\n\t\tevent.preventDefault();\r\n\t\treturn;\r\n\t}\r\n\tif (isChatOpen.value) {\r\n\t\tcloseChatModal();\r\n\t\tevent.preventDefault();\r\n\t\treturn;\r\n\t}\r\n\tif (isShowWinModal.value) {\r\n\t\tisShowWinModal.value = false;\r\n\t\tevent.preventDefault();\r\n\t\treturn;\r\n\t}\r\n\tif (isShowDrawModal.value) {\r\n\t\tisShowDrawModal.value = false;\r\n\t\tevent.preventDefault();\r\n\t}\r\n});\r\n\r\nfunction triggerWin(_prevScore?: number, _newScore?: number) {\r\n\tisShowWinModal.value = true;\r\n\tprevScore.value = _prevScore ?? null;\r\n\tnewScore.value = _newScore ?? null;\r\n\r\n\tif (typeof window !== 'undefined') {\r\n\t\timport('canvas-confetti').then((mod) => {\r\n\t\t\tmod.default({\r\n\t\t\t\tparticleCount: 200,\r\n\t\t\t\tspread: 90,\r\n\t\t\t\torigin: { y: 0.7 },\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\n\r\nconst currentFen = computed(() => {\r\n\treturn currentGame.value.history[currentGame.value.history.length - 1].fen;\r\n});\r\n\r\nconst historyIndex = ref(0);\r\n\r\nwatch(currentGame, (g) => {\r\n\tif (g && g.history && g.history.length)\r\n\t\thistoryIndex.value = g.history.length - 1;\r\n\telse historyIndex.value = 0;\r\n});\r\n\r\nconst totalPositions = computed(() => currentGame.value?.history?.length ?? 0);\r\nconst displayFen = computed(() => {\r\n\tif (!currentGame.value) return currentFen.value;\r\n\tconst idx = Math.min(\r\n\t\tMath.max(0, historyIndex.value),\r\n\t\tcurrentGame.value.history.length - 1\r\n\t);\r\n\treturn currentGame.value.history[idx].fen;\r\n});\r\n\r\nconst isViewingHistory = computed(() => {\r\n\treturn (\r\n\t\tcurrentGame.value &&\r\n\t\thistoryIndex.value !== currentGame.value.history.length - 1\r\n\t);\r\n});\r\n\r\nconst isAtStart = computed(() => historyIndex.value <= 0);\r\nconst isAtEnd = computed(() => {\r\n\tif (!currentGame.value) return true;\r\n\treturn historyIndex.value >= currentGame.value.history.length - 1;\r\n});\r\n\r\n// Allow draw offers only after more than inMovesToEnableDrawOffers moves\r\nconst canOfferDraw = computed(() => {\r\n\treturn (currentGame.value?.history?.length ?? 0) > minMovesToEnableDrawOffers;\r\n});\r\n\r\nfunction goBack() {\r\n\tif (historyIndex.value > 0) historyIndex.value--;\r\n}\r\n\r\nfunction goForward() {\r\n\tif (\r\n\t\tcurrentGame.value &&\r\n\t\thistoryIndex.value < currentGame.value.history.length - 1\r\n\t)\r\n\t\thistoryIndex.value++;\r\n}\r\n\r\nfunction exitHistory() {\r\n\tif (!currentGame.value) return;\r\n\thistoryIndex.value = currentGame.value.history.length - 1;\r\n}\r\n\r\nfunction jumpToHistoryPosition(targetIndex: number) {\r\n\tif (!currentGame.value || !currentGame.value.history?.length) return;\r\n\tconst maxIndex = currentGame.value.history.length - 1;\r\n\tconst nextIndex = Math.min(Math.max(0, targetIndex), maxIndex);\r\n\thistoryIndex.value = nextIndex;\r\n}\r\n\r\nfunction handleChatMoveJump(targetIndex: number) {\r\n\tjumpToHistoryPosition(targetIndex);\r\n\tcloseChatModal();\r\n}\r\n\r\nconst currentMovePlayerData = computed(() => {\r\n\tconst entry = currentGame.value.history[historyIndex.value];\r\n\tconst uid = entry.userId;\r\n\tconst map = (currentGame.value as any).userDataMap ?? {};\r\n\treturn map[uid];\r\n});\r\n\r\nconst playerColor = computed(() => {\r\n\tif (!currentGame.value || !user.value) return 'white';\r\n\r\n\tconst chess = new Chess(currentFen.value);\r\n\tconst currentTurn = chess.turn();\r\n\r\n\tif (currentGame.value.whiteUserIds?.includes(user.value._id)) {\r\n\t\treturn 'white';\r\n\t}\r\n\tif (currentGame.value.blackUserIds?.includes(user.value._id)) {\r\n\t\treturn 'black';\r\n\t}\r\n\r\n\treturn currentTurn === 'w' ? 'white' : 'black';\r\n});\r\n\r\nfunction handleSignout() {\r\n\tmanualSignoutRedirect.value = '/';\r\n\tsignout();\r\n\tstopPolling();\r\n\tstopTimer();\r\n\t// stopChatPolling();\r\n\tresetChatState();\r\n\tcurrentGame.value = null;\r\n\trouter.replace('/');\r\n}\r\n\r\nasync function handlePass() {\r\n\tif (!currentGame.value) return;\r\n\r\n\tconst currentGameId = currentGame.value._id;\r\n\tawait loadGame({\r\n\t\texcludeGameId: currentGameId,\r\n\t\tisForce: true,\r\n\t});\r\n}\r\n\r\nfunction showOfferDrawModal() {\r\n\tisOfferDrawModalVisible.value = true;\r\n}\r\n\r\nasync function handleOfferDraw() {\r\n\tif (!currentGame.value) return;\r\n\tisOfferDrawModalVisible.value = false;\r\n\r\n\ttry {\r\n\t\tconst authHeaders = getAuthHeader();\r\n\t\tawait $fetch('/api/draw-offer', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody: { gameId: currentGame.value._id },\r\n\t\t\theaders: authHeaders,\r\n\t\t});\r\n\t\t// Load next game after offering draw\r\n\t\tawait loadGame({\r\n\t\t\texcludeGameId: currentGame.value._id,\r\n\t\t\tisForce: true,\r\n\t\t});\r\n\t} catch (e: any) {\r\n\t\tconst friendly = translateServerError(e, t.value) || 'Failed to offer draw';\r\n\t\tconsole.error('Error offering draw:', friendly, e);\r\n\t}\r\n}\r\n\r\nasync function handleAcceptDraw() {\r\n\tif (!currentGame.value) return;\r\n\r\n\ttry {\r\n\t\tconst authHeaders = getAuthHeader();\r\n\t\tawait $fetch('/api/draw-respond', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody: { gameId: currentGame.value._id, isAcceptDraw: true },\r\n\t\t\theaders: authHeaders,\r\n\t\t});\r\n\t\tisShowDrawModal.value = true;\r\n\t\tawait loadGame({\r\n\t\t\texcludeGameId: currentGame.value._id,\r\n\t\t\tisForce: true,\r\n\t\t});\r\n\t} catch (e: any) {\r\n\t\tconst friendly =\r\n\t\t\ttranslateServerError(e, t.value) || 'Failed to accept draw';\r\n\t\tconsole.error('Error accepting draw:', friendly, e);\r\n\t}\r\n}\r\n\r\nasync function handleDeclineDraw() {\r\n\tif (!currentGame.value) return;\r\n\r\n\ttry {\r\n\t\tconst authHeaders = getAuthHeader();\r\n\t\tawait $fetch('/api/draw-respond', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody: { gameId: currentGame.value._id, isAcceptDraw: false },\r\n\t\t\theaders: authHeaders,\r\n\t\t});\r\n\t\t// Immediately load next game after declining\r\n\t\tawait loadGame({\r\n\t\t\texcludeGameId: currentGame.value._id,\r\n\t\t\tisForce: true,\r\n\t\t});\r\n\t} catch (e: any) {\r\n\t\tconst friendly =\r\n\t\t\ttranslateServerError(e, t.value) || 'Failed to decline draw';\r\n\t\tconsole.error('Error declining draw:', friendly, e);\r\n\t}\r\n}\r\n\r\ntype LoadGameOptions = {\r\n\texcludeGameId?: string;\r\n\trequestedGameId?: string;\r\n\tisForce?: boolean;\r\n};\r\n\r\nasync function loadGame(options: LoadGameOptions = {}) {\r\n\tconst isForce = Boolean(\r\n\t\toptions.isForce || options.excludeGameId || options.requestedGameId\r\n\t);\r\n\tif (isGameLoading.value && !isForce) {\r\n\t\treturn currentGame.value;\r\n\t}\r\n\r\n\tisGameLoading.value = true;\r\n\r\n\ttry {\r\n\t\tconst params = new URLSearchParams();\r\n\t\tif (options.excludeGameId) {\r\n\t\t\tparams.set('gameId', options.excludeGameId);\r\n\t\t}\r\n\t\tif (options.requestedGameId) {\r\n\t\t\tparams.set('requestedGameId', options.requestedGameId);\r\n\t\t}\r\n\t\tconst query = params.toString();\r\n\t\tconst url = query ? `/api/game?${query}` : '/api/game';\r\n\t\tconst authHeaders = getAuthHeader();\r\n\t\tconst response = await $fetch(\r\n\t\t\turl,\r\n\t\t\tauthHeaders ? { headers: authHeaders } : {}\r\n\t\t);\r\n\r\n\t\tif (response) {\r\n\t\t\tcurrentGame.value = response;\r\n\t\t\tstopPolling();\r\n\t\t\tstartTimer();\r\n\t\t} else {\r\n\t\t\tcurrentGame.value = null;\r\n\t\t\tstopTimer();\r\n\t\t\tstartPolling();\r\n\t\t}\r\n\r\n\t\treturn response;\r\n\t} catch (e) {\r\n\t\tif (!options.requestedGameId) {\r\n\t\t\tconsole.error('Error loading game:', e);\r\n\t\t\tcurrentGame.value = null;\r\n\t\t\tstartPolling();\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tthrow e;\r\n\t} finally {\r\n\t\tisGameLoading.value = false;\r\n\t}\r\n}\r\n\r\nasync function loadRequestedGame(gameId: string) {\r\n\terrorMessage.value = '';\r\n\ttry {\r\n\t\tconst response = await loadGame({\r\n\t\t\trequestedGameId: gameId,\r\n\t\t\tisForce: true,\r\n\t\t});\r\n\t\treturn Boolean(response);\r\n\t} catch (err: any) {\r\n\t\tconst statusMessage =\r\n\t\t\terr?.statusMessage ||\r\n\t\t\terr?.data?.statusMessage ||\r\n\t\t\terr?.response?.statusMessage ||\r\n\t\t\terr?.statusCode;\r\n\t\tif (statusMessage === 'GAME_NOT_FOUND') {\r\n\t\t\terrorMessage.value = t.value.requestedGameNotFound;\r\n\t\t} else if (statusMessage === 'GAME_NOT_AVAILABLE') {\r\n\t\t\terrorMessage.value = t.value.requestedGameNotAvailable;\r\n\t\t} else {\r\n\t\t\terrorMessage.value =\r\n\t\t\t\ttranslateServerError(err, t.value) || t.value.errors.ERR_GENERIC;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\nfunction isCurrentGame(gameId: string) {\r\n\tif (!currentGame.value) return false;\r\n\tconst currentId =\r\n\t\tcurrentGame.value._id?.toString?.() ?? currentGame.value._id;\r\n\treturn currentId === gameId || String(currentGame.value.id ?? '') === gameId;\r\n}\r\n\r\nfunction queueGameLoad() {\r\n\tloadSequence = loadSequence\r\n\t\t.catch(() => undefined)\r\n\t\t.then(() => loadAccordingToQuery())\r\n\t\t.catch((err) => {\r\n\t\t\tconsole.error('Failed to load game from queue', err);\r\n\t\t\terrorMessage.value =\r\n\t\t\t\ttranslateServerError(err, t.value) || t.value.errors.ERR_GENERIC;\r\n\t\t});\r\n}\r\n\r\nasync function loadAccordingToQuery() {\r\n\tif (!isAuthenticated.value) return;\r\n\r\n\tconst targetGameId = requestedGameId.value;\r\n\tif (targetGameId) {\r\n\t\tif (isCurrentGame(targetGameId)) {\r\n\t\t\terrorMessage.value = '';\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst loadedRequested = await loadRequestedGame(targetGameId);\r\n\t\tif (loadedRequested) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tawait loadGame({ isForce: true });\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (!currentGame.value) {\r\n\t\tawait loadGame();\r\n\t}\r\n}\r\n\r\nfunction redirectToSignin() {\r\n\tconst target = route.fullPath || '/game';\r\n\trouter.replace({\r\n\t\tpath: '/signin',\r\n\t\tquery: { redirect: target },\r\n\t});\r\n}\r\n\r\ntype MoveResponse = {\r\n\tfen: string;\r\n\tsuccess: boolean;\r\n\tresult: any;\r\n};\r\n\r\nfunction handleBlockedMove() {\r\n\t// Trigger pulse animation when move is blocked due to draw offer\r\n\tisPulsingDrawButtons.value = true;\r\n\tsetTimeout(() => {\r\n\t\tisPulsingDrawButtons.value = false;\r\n\t}, 600);\r\n}\r\n\r\nasync function handleMove(move: {\r\n\tfrom: string;\r\n\tto: string;\r\n\tpromotion?: string;\r\n}) {\r\n\tif (!currentGame.value) return;\r\n\r\n\ttry {\r\n\t\tconst moveData = {\r\n\t\t\tgameId: currentGame.value._id,\r\n\t\t\tmove: move.promotion ? { ...move, promotion: move.promotion } : move,\r\n\t\t};\r\n\r\n\t\tconst authHeaders = getAuthHeader();\r\n\t\tconst res = await $fetch<MoveResponse>('/api/move', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody: moveData,\r\n\t\t\theaders: authHeaders,\r\n\t\t});\r\n\t\tif (res?.result.gameResult === 'draw') {\r\n\t\t\tisShowDrawModal.value = true;\r\n\t\t} else if (['white-win', 'black-win'].includes(res?.result.gameResult)) {\r\n\t\t\ttriggerWin(res.result.prevScore, res.result.newScore);\r\n\t\t}\r\n\t\tstopTimer();\r\n\t\tawait loadGame({\r\n\t\t\texcludeGameId: currentGame.value._id,\r\n\t\t\tisForce: true,\r\n\t\t});\r\n\t} catch (e: any) {\r\n\t\tif (isNotYourTurnError(e)) {\r\n\t\t\tshowMoveErrorModal(t.value.moveErrors.notYourTurnMessage);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst friendly = translateServerError(e, t.value) || 'Failed to make move';\r\n\t\tconsole.error('Error making move:', friendly, e);\r\n\t}\r\n}\r\n\r\nfunction startTimer() {\r\n\tstopTimer();\r\n\ttimeRemaining.value = maxMoveTimeMins * 60;\r\n\r\n\ttimerIntervalId.value = setInterval(() => {\r\n\t\ttimeRemaining.value--;\r\n\r\n\t\tif (timeRemaining.value <= 0) {\r\n\t\t\tstopTimer();\r\n\t\t\tif (currentGame.value) {\r\n\t\t\t\tconst reloadOptions: LoadGameOptions = {\r\n\t\t\t\t\texcludeGameId: currentGame.value._id,\r\n\t\t\t\t\tisForce: true,\r\n\t\t\t\t};\r\n\t\t\t\tif (isChatOpen.value) {\r\n\t\t\t\t\tpendingTimerReload.value = reloadOptions;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvoid loadGame(reloadOptions);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}, 1000);\r\n}\r\n\r\nfunction stopTimer() {\r\n\tif (timerIntervalId.value) {\r\n\t\tclearInterval(timerIntervalId.value);\r\n\t\ttimerIntervalId.value = null;\r\n\t}\r\n}\r\n\r\nfunction startPolling() {\r\n\tstopPolling();\r\n\r\n\tpollIntervalId.value = setInterval(async () => {\r\n\t\tif (!currentGame.value) {\r\n\t\t\tawait loadGame();\r\n\t\t}\r\n\t}, 4000);\r\n}\r\n\r\nfunction stopPolling() {\r\n\tif (pollIntervalId.value) {\r\n\t\tclearInterval(pollIntervalId.value);\r\n\t\tpollIntervalId.value = null;\r\n\t}\r\n}\r\n\r\nfunction formatTime(seconds: number): string {\r\n\tconst mins = Math.floor(seconds / 60);\r\n\tconst secs = seconds % 60;\r\n\treturn `${mins}:${secs.toString().padStart(2, '0')}`;\r\n}\r\n\r\nfunction isTimestampLater(candidate: string | null, reference: string | null) {\r\n\tif (!candidate) return false;\r\n\tif (!reference) return true;\r\n\treturn new Date(candidate).getTime() > new Date(reference).getTime();\r\n}\r\n\r\nfunction toggleChatModal() {\r\n\tif (isChatOpen.value) closeChatModal();\r\n\telse openChatModal();\r\n}\r\n\r\nfunction openChatModal() {\r\n\tif (!canUseTeamChat.value) return;\r\n\tisChatOpen.value = true;\r\n\tfetchChatMessages({ force: true });\r\n\tscrollChatToBottom();\r\n}\r\n\r\nfunction closeChatModal() {\r\n\tif (!isChatOpen.value) return;\r\n\tisChatOpen.value = false;\r\n\tisEmojiPickerOpen.value = false;\r\n}\r\n\r\nasync function sendChatMessage() {\r\n\tif (isChatSending.value) return;\r\n\tconst trimmed = chatInput.value.trim();\r\n\tconst gameId = getCurrentGameId();\r\n\tif (!trimmed || !gameId) return;\r\n\tisChatSending.value = true;\r\n\tconst headers = getAuthHeader();\r\n\ttry {\r\n\t\tawait $fetch('/api/chat', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody: { gameId, message: trimmed },\r\n\t\t\t...(headers ? { headers } : {}),\r\n\t\t});\r\n\t\tchatInput.value = '';\r\n\t\tchatErrorMessage.value = '';\r\n\t\tawait fetchChatMessages({ force: true });\r\n\t\tawait scrollChatToBottom();\r\n\t} catch (err: any) {\r\n\t\tchatErrorMessage.value =\r\n\t\t\ttranslateServerError(err, t.value) || t.value.teamChat.sendError;\r\n\t} finally {\r\n\t\tisChatSending.value = false;\r\n\t}\r\n}\r\n\r\nfunction toggleEmojiPicker() {\r\n\tif (!isChatOpen.value) {\r\n\t\tisEmojiPickerOpen.value = false;\r\n\t\treturn;\r\n\t}\r\n\tisEmojiPickerOpen.value = !isEmojiPickerOpen.value;\r\n}\r\n\r\nfunction handleEmojiSelect(event: CustomEvent<EmojiClickEventDetail>) {\r\n\tconst detail = event.detail;\r\n\tconst emojiValue = detail?.unicode || (detail as any)?.emoji?.unicode;\r\n\tif (!emojiValue) return;\r\n\tchatInput.value += emojiValue;\r\n\tisEmojiPickerOpen.value = false;\r\n}\r\n\r\nfunction queuePersistLastSeen(timestamp: string | null) {\r\n\tif (!timestamp) return;\r\n\tif (\r\n\t\tlastPersistedChatTimestamp.value &&\r\n\t\t!isTimestampLater(timestamp, lastPersistedChatTimestamp.value)\r\n\t) {\r\n\t\treturn;\r\n\t}\r\n\tpendingLastSeenUpload.value = timestamp;\r\n\tif (!isPersistingLastSeen.value) {\r\n\t\tvoid persistPendingLastSeen();\r\n\t}\r\n}\r\n\r\nasync function persistPendingLastSeen() {\r\n\tconst timestamp = pendingLastSeenUpload.value;\r\n\tconst targetGameId = getCurrentGameId();\r\n\tif (!timestamp || !targetGameId) return;\r\n\tif (\r\n\t\tlastPersistedChatTimestamp.value &&\r\n\t\t!isTimestampLater(timestamp, lastPersistedChatTimestamp.value)\r\n\t) {\r\n\t\tpendingLastSeenUpload.value = null;\r\n\t\treturn;\r\n\t}\r\n\tisPersistingLastSeen.value = true;\r\n\tpendingLastSeenUpload.value = null;\r\n\tconst headers = getAuthHeader();\r\n\ttry {\r\n\t\tconst res = await $fetch<{ lastSeenAt: string }>('/api/chat/seen', {\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody: { gameId: targetGameId, lastSeenAt: timestamp },\r\n\t\t\t...(headers ? { headers } : {}),\r\n\t\t});\r\n\t\tif (targetGameId === getCurrentGameId()) {\r\n\t\t\tlastPersistedChatTimestamp.value = res.lastSeenAt ?? timestamp;\r\n\t\t}\r\n\t} catch (err) {\r\n\t\tconsole.error('Failed to persist chat last-seen timestamp', err);\r\n\t} finally {\r\n\t\tisPersistingLastSeen.value = false;\r\n\t\tif (pendingLastSeenUpload.value) {\r\n\t\t\tvoid persistPendingLastSeen();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction resolveChatUserName(userId: string) {\r\n\tconst map = (currentGame.value as any)?.userDataMap ?? {};\r\n\treturn map?.[userId]?.name ?? t.value.unknownPlayer;\r\n}\r\n\r\nfunction formatChatTimestamp(value: string) {\r\n\treturn formatDate(value, locale.value || 'en', '');\r\n}\r\n\r\nfunction clearMoveErrorModalTimer() {\r\n\tif (moveErrorModalTimerId.value) {\r\n\t\tclearTimeout(moveErrorModalTimerId.value);\r\n\t\tmoveErrorModalTimerId.value = null;\r\n\t}\r\n}\r\n\r\nfunction hideMoveErrorModal() {\r\n\tisMoveErrorModalVisible.value = false;\r\n\tmoveErrorModalMessage.value = '';\r\n\tclearMoveErrorModalTimer();\r\n}\r\n\r\nfunction scheduleNextGameLoad() {\r\n\tconst options: LoadGameOptions = { isForce: true };\r\n\tconst currentId = getCurrentGameId();\r\n\tif (currentId) {\r\n\t\toptions.excludeGameId = currentId;\r\n\t}\r\n\tvoid loadGame(options);\r\n}\r\n\r\nfunction showMoveErrorModal(message: string) {\r\n\tclearMoveErrorModalTimer();\r\n\tmoveErrorModalMessage.value = message;\r\n\tisMoveErrorModalVisible.value = true;\r\n\tmoveErrorModalTimerId.value = setTimeout(() => {\r\n\t\tmoveErrorModalTimerId.value = null;\r\n\t\thideMoveErrorModal();\r\n\t\tscheduleNextGameLoad();\r\n\t}, MOVE_ERROR_MODAL_DURATION_MS);\r\n}\r\n\r\nfunction isNotYourTurnError(err: any) {\r\n\tconst code =\r\n\t\terr?.statusMessage ||\r\n\t\terr?.data?.statusMessage ||\r\n\t\terr?.response?.statusMessage ||\r\n\t\terr?.response?._data?.statusMessage;\r\n\treturn code === 'ERR_NOT_YOUR_TURN';\r\n}\r\n\r\nfunction getCurrentGameId(): string | null {\r\n\tconst raw = currentGame.value?._id ?? null;\r\n\tif (!raw) return null;\r\n\treturn typeof raw === 'string' ? raw : raw?.toString?.() ?? null;\r\n}\r\n\r\nasync function fetchChatMessages(options: { force?: boolean } = {}) {\r\n\tif (!canUseTeamChat.value) return;\r\n\tconst gameId = getCurrentGameId();\r\n\tif (!gameId) return;\r\n\tif (isChatLoading.value && !options.force) return;\r\n\tisChatLoading.value = true;\r\n\tconst headers = getAuthHeader();\r\n\ttry {\r\n\t\tconst response = await $fetch<TeamChatResponse>('/api/chat', {\r\n\t\t\tquery: { gameId },\r\n\t\t\t...(headers ? { headers } : {}),\r\n\t\t});\r\n\t\tconst latestGameId = getCurrentGameId();\r\n\t\tif (latestGameId !== gameId) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tchatMessages.value = response.messages;\r\n\t\tchatErrorMessage.value = '';\r\n\t\tconst serverLastSeen = response.lastSeenAt;\r\n\t\tif (serverLastSeen) {\r\n\t\t\tif (isTimestampLater(serverLastSeen, lastPersistedChatTimestamp.value)) {\r\n\t\t\t\tlastPersistedChatTimestamp.value = serverLastSeen;\r\n\t\t\t}\r\n\t\t\tif (isTimestampLater(serverLastSeen, lastSeenChatTimestamp.value)) {\r\n\t\t\t\tlastSeenChatTimestamp.value = serverLastSeen;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tlastPersistedChatTimestamp.value = null;\r\n\t\t\tlastSeenChatTimestamp.value = null;\r\n\t\t}\r\n\r\n\t\tupdateUnreadCountFromMessages();\r\n\t} catch (err: any) {\r\n\t\tchatErrorMessage.value =\r\n\t\t\ttranslateServerError(err, t.value) || t.value.teamChat.loadError;\r\n\t} finally {\r\n\t\tisChatLoading.value = false;\r\n\t}\r\n}\r\n\r\n// function startChatPolling() {\r\n// \tstopChatPolling();\r\n// \tif (!canUseTeamChat.value || !getCurrentGameId()) return;\r\n// \tfetchChatMessages({ force: true });\r\n// \tchatIntervalId.value = setInterval(() => {\r\n// \t\tfetchChatMessages();\r\n// \t}, 5000);\r\n// }\r\n\r\n// function stopChatPolling() {\r\n// \tif (chatIntervalId.value) {\r\n// \t\tclearInterval(chatIntervalId.value);\r\n// \t\tchatIntervalId.value = null;\r\n// \t}\r\n// }\r\n\r\nfunction resetChatState() {\r\n\tchatMessages.value = [];\r\n\tchatInput.value = '';\r\n\tchatErrorMessage.value = '';\r\n\tchatUnreadCount.value = 0;\r\n\tlastSeenChatTimestamp.value = null;\r\n\tlastPersistedChatTimestamp.value = null;\r\n\tpendingLastSeenUpload.value = null;\r\n\tisChatOpen.value = false;\r\n\tisEmojiPickerOpen.value = false;\r\n\tpendingTimerReload.value = null;\r\n}\r\n\r\nfunction markChatAsRead() {\r\n\tconst lastMessage = chatMessages.value[chatMessages.value.length - 1];\r\n\tlet targetTimestamp: string | null = null;\r\n\tif (lastMessage) {\r\n\t\ttargetTimestamp = lastMessage.createdDateStr;\r\n\t} else if (!lastSeenChatTimestamp.value) {\r\n\t\ttargetTimestamp = new Date().toISOString();\r\n\t}\r\n\tif (targetTimestamp) {\r\n\t\tif (\r\n\t\t\tisTimestampLater(targetTimestamp, lastSeenChatTimestamp.value) ||\r\n\t\t\t!lastSeenChatTimestamp.value\r\n\t\t) {\r\n\t\t\tlastSeenChatTimestamp.value = targetTimestamp;\r\n\t\t}\r\n\t\tqueuePersistLastSeen(targetTimestamp);\r\n\t}\r\n\tchatUnreadCount.value = 0;\r\n}\r\n\r\nfunction updateUnreadCountFromMessages() {\r\n\tif (chatMessages.value.length) {\r\n\t\tif (lastSeenChatTimestamp.value) {\r\n\t\t\tconst lastSeen = new Date(lastSeenChatTimestamp.value).getTime();\r\n\t\t\tchatUnreadCount.value = chatMessages.value.filter((msg) => {\r\n\t\t\t\tconst msgTime = new Date(msg.createdDateStr).getTime();\r\n\t\t\t\treturn msgTime > lastSeen;\r\n\t\t\t}).length;\r\n\t\t} else {\r\n\t\t\tchatUnreadCount.value = chatMessages.value.length;\r\n\t\t}\r\n\t} else {\r\n\t\tchatUnreadCount.value = 0;\r\n\t}\r\n}\r\n\r\nasync function scrollChatToBottom() {\r\n\tawait nextTick();\r\n\tif (chatBodyRef.value) {\r\n\t\tchatBodyRef.value.scrollTop = chatBodyRef.value.scrollHeight;\r\n\t}\r\n}\r\n\r\nwatch(\r\n\t() => ({\r\n\t\tgameId: getCurrentGameId(),\r\n\t\tcanChat: canUseTeamChat.value,\r\n\t}),\r\n\t(newState, oldState) => {\r\n\t\tconst isGameChanged = newState.gameId !== oldState?.gameId;\r\n\t\tif (isGameChanged || !newState.canChat) {\r\n\t\t\tresetChatState();\r\n\t\t}\r\n\t\t// Fetch chat messages when game changes to update unread count\r\n\t\tif (newState.gameId && newState.canChat && isGameChanged) {\r\n\t\t\tfetchChatMessages({ force: true });\r\n\t\t}\r\n\t},\r\n\t{ immediate: true }\r\n);\r\n\r\nwatch(chatMessages, () => {\r\n\tif (isChatOpen.value) {\r\n\t\tmarkChatAsRead();\r\n\t\tscrollChatToBottom();\r\n\t} else {\r\n\t\tupdateUnreadCountFromMessages();\r\n\t}\r\n});\r\n\r\nwatch(isChatOpen, (open) => {\r\n\tif (open) {\r\n\t\tmarkChatAsRead();\r\n\t\tscrollChatToBottom();\r\n\t} else {\r\n\t\tisEmojiPickerOpen.value = false;\r\n\t\tmarkChatAsRead();\r\n\t\tif (pendingTimerReload.value) {\r\n\t\t\tconst options = pendingTimerReload.value;\r\n\t\t\tpendingTimerReload.value = null;\r\n\t\t\tvoid loadGame(options);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nwatch(\r\n\t() => isAuthenticated.value,\r\n\t(newVal) => {\r\n\t\tif (newVal) {\r\n\t\t\tqueueGameLoad();\r\n\t\t} else {\r\n\t\t\tstopPolling();\r\n\t\t\tstopTimer();\r\n\t\t\t// stopChatPolling();\r\n\t\t\tresetChatState();\r\n\t\t\tcurrentGame.value = null;\r\n\t\t\tif (manualSignoutRedirect.value) {\r\n\t\t\t\tmanualSignoutRedirect.value = null;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tredirectToSignin();\r\n\t\t}\r\n\t},\r\n\t{ immediate: true }\r\n);\r\n\r\nwatch(requestedGameId, (newVal, oldVal) => {\r\n\tif (!isAuthenticated.value) return;\r\n\tif (newVal === oldVal) return;\r\n\tqueueGameLoad();\r\n});\r\n\r\nonUnmounted(() => {\r\n\tstopPolling();\r\n\tstopTimer();\r\n\t// stopChatPolling();\r\n\tclearMoveErrorModalTimer();\r\n});\r\n</script>\r\n\r\n<style scoped>\r\n.container {\r\n\tmax-width: 1200px;\r\n\tmargin: 0 auto;\r\n\tpadding: 1.25rem;\r\n\tmin-height: 100vh;\r\n\tanimation: fadeInPage 0.15s ease-out;\r\n}\r\n\r\n@media (max-width: 600px) {\r\n\t.container {\r\n\t\tpadding: 0.5rem;\r\n\t}\r\n}\r\n\r\n@keyframes fadeInPage {\r\n\tfrom {\r\n\t\topacity: 0;\r\n\t\tvisibility: hidden;\r\n\t}\r\n\tto {\r\n\t\topacity: 1;\r\n\t\tvisibility: visible;\r\n\t}\r\n}\r\n\r\n.game-container {\r\n\tpadding: 1.25rem 0;\r\n}\r\n\r\n.game-header {\r\n\tdisplay: flex;\r\n\tjustify-content: space-between;\r\n\talign-items: center;\r\n\tmargin-bottom: 1.25rem;\r\n\tpadding-bottom: 0.5rem;\r\n\tborder-bottom: 2px solid #eee;\r\n\tflex-wrap: wrap;\r\n\tgap: 1rem;\r\n}\r\n\r\n.game-header h1 {\r\n\tmargin: 0;\r\n\tcolor: #333;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tgap: 0.75rem;\r\n}\r\n\r\n.game-logo {\r\n\theight: 48px;\r\n\twidth: auto;\r\n\tborder-radius: 8px;\r\n}\r\n\r\n.game-title-text {\r\n\tfont-size: 1.75rem;\r\n\tfont-weight: 600;\r\n\tcolor: inherit;\r\n}\r\n\r\n.user-info {\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tgap: 1rem;\r\n\tflex-wrap: wrap;\r\n}\r\n\r\n.user-info span {\r\n\tcolor: #666;\r\n\tfont-weight: 500;\r\n}\r\n\r\n.btn-signout {\r\n\tbackground: #f44336 !important;\r\n\tborder-color: #f44336 !important;\r\n\tcolor: #fff !important;\r\n}\r\n\r\n.btn-faq {\r\n\tpadding: 0.5rem 1rem;\r\n\tborder: 1px solid #5cb85c;\r\n\tcolor: #fff;\r\n\tborder-radius: 4px;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 500;\r\n\ttext-decoration: none;\r\n\tbackground: #5cb85c;\r\n\ttransition: all 0.2s ease;\r\n\tmargin-left: 0.75rem;\r\n}\r\n\r\n.btn-faq:hover {\r\n\tbackground: #4a9d4a;\r\n\tborder-color: #4a9d4a;\r\n}\r\n\r\n.profile-dropdown {\r\n\tposition: relative;\r\n\tz-index: 100000;\r\n}\r\n\r\n.btn-profile {\r\n\tpadding: 0.5rem;\r\n\tborder: 2px solid #5cb85c;\r\n\tbackground: #5cb85c;\r\n\tcolor: #fff;\r\n\tborder-radius: 50%;\r\n\tcursor: pointer;\r\n\ttransition: all 0.2s ease;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\twidth: 44px;\r\n\theight: 44px;\r\n}\r\n\r\n.btn-profile:hover {\r\n\tbackground: #4a9d4a;\r\n\tborder-color: #4a9d4a;\r\n\ttransform: scale(1.1);\r\n}\r\n\r\n.btn-profile svg {\r\n\twidth: 24px;\r\n\theight: 24px;\r\n}\r\n\r\n.profile-menu {\r\n\tbackground: #fff;\r\n\tborder: 1px solid #ddd;\r\n\tborder-radius: 12px;\r\n\tbox-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);\r\n\toverflow: hidden;\r\n\tmin-width: 220px;\r\n\tmax-width: calc(100vw - 16px);\r\n\tmax-height: calc(100vh - 16px);\r\n\tanimation: slideDownMenu 0.2s ease-out;\r\n\tpointer-events: auto;\r\n\toverflow-y: auto;\r\n}\r\n\r\n@keyframes slideDownMenu {\r\n\tfrom {\r\n\t\topacity: 0;\r\n\t\ttransform: translateY(-10px);\r\n\t}\r\n\tto {\r\n\t\topacity: 1;\r\n\t\ttransform: translateY(0);\r\n\t}\r\n}\r\n\r\n.profile-menu-header {\r\n\tpadding: 1rem;\r\n\tbackground: #f9f9f9;\r\n\tborder-bottom: 1px solid #eee;\r\n\ttext-align: center;\r\n\tfont-size: 1rem;\r\n\tcolor: #333;\r\n}\r\n\r\n.profile-menu-item {\r\n\tpadding: 0.75rem 1rem;\r\n\tdisplay: flex;\r\n\tjustify-content: space-between;\r\n\talign-items: center;\r\n\tborder-bottom: 1px solid #f5f5f5;\r\n\tfont-size: 0.9rem;\r\n}\r\n\r\n.profile-label {\r\n\tcolor: #666;\r\n\tfont-weight: 500;\r\n}\r\n\r\n.profile-value {\r\n\tcolor: #333;\r\n\tfont-weight: 600;\r\n}\r\n\r\n.profile-menu-divider {\r\n\theight: 1px;\r\n\tbackground: #ddd;\r\n\tmargin: 0.5rem 0;\r\n}\r\n\r\n.profile-menu-settings {\r\n\tpadding: 0.5rem 1rem;\r\n\tmargin: 0.75rem;\r\n\tborder: 1px solid #5cb85c;\r\n\tbackground: #5cb85c;\r\n\tcolor: #fff;\r\n\tborder-radius: 4px;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 500;\r\n\ttext-decoration: none;\r\n\ttransition: background 0.2s, transform 0.1s;\r\n\tdisplay: inline-flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tgap: 0.4rem;\r\n\twidth: calc(100% - 1.5rem);\r\n\tbox-sizing: border-box;\r\n\tcursor: pointer;\r\n\tfont-family: inherit;\r\n}\r\n\r\n.profile-menu-settings:hover {\r\n\tbackground: #4a9d4a;\r\n\tborder-color: #4a9d4a;\r\n\ttransform: translateY(-1px);\r\n}\r\n\r\n.settings-icon-small {\r\n\twidth: 16px;\r\n\theight: 16px;\r\n}\r\n\r\n.btn-team-chat {\r\n\tpadding: 0.5rem 1rem;\r\n\tborder-radius: 4px;\r\n\tborder: 1px solid #2563eb;\r\n\tbackground: #2563eb;\r\n\tcolor: #fff;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 500;\r\n\tcursor: pointer;\r\n\tdisplay: inline-flex;\r\n\talign-items: center;\r\n\tgap: 0.35rem;\r\n\ttransition: all 0.2s ease;\r\n}\r\n\r\n.btn-team-chat:disabled {\r\n\topacity: 0.45;\r\n\tcursor: not-allowed;\r\n}\r\n\r\n.btn-team-chat:not(:disabled):hover {\r\n\tbackground: #1d4ed8;\r\n\tborder-color: #1d4ed8;\r\n}\r\n\r\n.chat-badge {\r\n\tbackground: #f97316;\r\n\tcolor: #fff;\r\n\tborder-radius: 999px;\r\n\tpadding: 0 0.45rem;\r\n\tfont-size: 0.7rem;\r\n\tfont-weight: 700;\r\n\tline-height: 1.4;\r\n}\r\n\r\n.btn-signout:hover {\r\n\tbackground: #d32f2f;\r\n\tborder-color: #d32f2f;\r\n}\r\n\r\n.game-status {\r\n\ttext-align: center;\r\n\tpadding: 2.5rem 1.5rem;\r\n}\r\n\r\n.game-alert {\r\n\tmargin-bottom: 1rem;\r\n\tpadding: 0.75rem 1rem;\r\n\tborder-radius: 8px;\r\n\tbackground: #fff6e5;\r\n\tcolor: #92400e;\r\n\tborder: 1px solid #fcd34d;\r\n\tfont-weight: 500;\r\n}\r\n\r\n.game-status p {\r\n\tfont-size: 1.5rem;\r\n\tcolor: #666;\r\n\tmargin-bottom: 2rem;\r\n}\r\n\r\n.loading-spinner {\r\n\twidth: 50px;\r\n\theight: 50px;\r\n\tborder: 4px solid #f3f3f3;\r\n\tborder-top: 4px solid #74d66d;\r\n\tborder-radius: 50%;\r\n\tanimation: spin 1s linear infinite;\r\n\tmargin: 0 auto;\r\n}\r\n\r\n@keyframes spin {\r\n\t0% {\r\n\t\ttransform: rotate(0deg);\r\n\t}\r\n\t100% {\r\n\t\ttransform: rotate(360deg);\r\n\t}\r\n}\r\n\r\n.active-game {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\talign-items: center;\r\n\tgap: 0.5rem;\r\n\tmax-width: 600px;\r\n\tmargin: 0 auto;\r\n\tpadding: 0.5rem;\r\n}\r\n\r\n@media (max-width: 600px) {\r\n\t.active-game {\r\n\t\tpadding: 0.25rem;\r\n\t\tgap: 0.25rem;\r\n\t}\r\n}\r\n\r\n.chessboard-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tbackground: #fff;\r\n\tborder-radius: 16px;\r\n\tbox-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);\r\n\tmargin-top: 0.75rem;\r\n\tmargin-bottom: 0.25rem;\r\n\twidth: 100%;\r\n\tmax-width: min(480px, 95vw);\r\n\tpadding: 0.25rem 0.5rem;\r\n}\r\n\r\n.chessboard-area > * {\r\n\twidth: 100%;\r\n\tdisplay: block;\r\n}\r\n\r\n.timer-section {\r\n\tbackground: #f9f9f9;\r\n\tpadding: 1.25rem;\r\n\tborder-radius: 8px;\r\n\tbox-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\r\n}\r\n\r\n.pass-btn-container {\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\tgap: 0.75rem;\r\n\tmargin-top: 0.5rem;\r\n\tflex-wrap: wrap;\r\n}\r\n\r\n.btn-pass {\r\n\tpadding: 0.5rem 1rem;\r\n\tbackground: #64748b;\r\n\tcolor: white;\r\n\tborder: 1px solid #64748b;\r\n\tborder-radius: 4px;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 800;\r\n\tcursor: pointer;\r\n\ttransition: all 0.2s ease;\r\n\twidth: 120px;\r\n}\r\n\r\n.btn-pass:disabled {\r\n\topacity: 0.5;\r\n\tcursor: not-allowed;\r\n}\r\n\r\n.btn-pass:not(:disabled):hover {\r\n\tbackground: #475569;\r\n\tborder-color: #475569;\r\n}\r\n\r\n.btn-offer-draw {\r\n\tpadding: 0.5rem 1rem;\r\n\tbackground: #f59e0b;\r\n\t/* color: white; */\r\n\tborder: 1px solid #f59e0b;\r\n\tborder-radius: 4px;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 800;\r\n\tcursor: pointer;\r\n\ttransition: all 0.2s ease;\r\n\twidth: 120px;\r\n}\r\n\r\n.btn-offer-draw:disabled {\r\n\topacity: 0.5;\r\n\tcursor: not-allowed;\r\n}\r\n\r\n.btn-offer-draw:not(:disabled):hover {\r\n\tbackground: #d97706;\r\n\tborder-color: #d97706;\r\n}\r\n\r\n.draw-offered-title {\r\n\tcolor: #f59e0b;\r\n\tfont-size: 1.5rem;\r\n\ttext-align: center;\r\n\tmargin: 0 0 1rem 0;\r\n}\r\n\r\n.draw-offered-actions {\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\tgap: 0.75rem;\r\n\tmargin-top: 0.5rem;\r\n\tflex-wrap: wrap;\r\n}\r\n\r\n.btn-accept-draw {\r\n\tpadding: 0.5rem 1rem;\r\n\tbackground: #22c55e;\r\n\tcolor: white;\r\n\tborder: 1px solid #22c55e;\r\n\tborder-radius: 4px;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 500;\r\n\tcursor: pointer;\r\n\ttransition: all 0.2s ease;\r\n\tmin-width: 140px;\r\n}\r\n\r\n.btn-accept-draw:disabled {\r\n\topacity: 0.5;\r\n\tcursor: not-allowed;\r\n}\r\n\r\n.btn-accept-draw:not(:disabled):hover {\r\n\tbackground: #16a34a;\r\n\tborder-color: #16a34a;\r\n}\r\n\r\n.btn-decline-draw {\r\n\tpadding: 0.5rem 1rem;\r\n\tbackground: #64748b;\r\n\tcolor: white;\r\n\tborder: 1px solid #64748b;\r\n\tborder-radius: 4px;\r\n\tfont-size: 0.9rem;\r\n\tfont-weight: 500;\r\n\tcursor: pointer;\r\n\ttransition: all 0.2s ease;\r\n\tmin-width: 140px;\r\n}\r\n\r\n.btn-decline-draw:disabled {\r\n\topacity: 0.5;\r\n\tcursor: not-allowed;\r\n}\r\n\r\n.btn-decline-draw:not(:disabled):hover {\r\n\tbackground: #475569;\r\n\tborder-color: #475569;\r\n}\r\n\r\n@keyframes pulseButton {\r\n\t0% {\r\n\t\ttransform: scale(1);\r\n\t}\r\n\t50% {\r\n\t\ttransform: scale(1.1);\r\n\t}\r\n\t100% {\r\n\t\ttransform: scale(1);\r\n\t}\r\n}\r\n\r\n.btn-accept-draw.pulse,\r\n.btn-decline-draw.pulse {\r\n\tanimation: pulseButton 0.3s ease-in-out 2;\r\n}\r\n\r\n.timer-section.timer-below {\r\n\twidth: 100%;\r\n\tmax-width: min(480px, 95vw);\r\n\tmargin: 0 auto;\r\n}\r\n\r\n@media (max-width: 600px) {\r\n\t.timer-section {\r\n\t\tpadding: 1rem;\r\n\t}\r\n\r\n\t.timer-section h3 {\r\n\t\tfont-size: 1.25rem;\r\n\t}\r\n}\r\n\r\n.timer-section h3 {\r\n\tmargin: 0 0 0.5rem 0;\r\n\tcolor: #333;\r\n\tfont-size: 1.5rem;\r\n\ttext-align: center;\r\n}\r\n\r\n.timer {\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tgap: 0.35rem;\r\n\tfont-size: 1.25rem;\r\n}\r\n\r\n.timer-label {\r\n\tcolor: #666;\r\n\tfont-weight: 500;\r\n}\r\n\r\n.timer-value {\r\n\tcolor: #2d8a26;\r\n\tfont-weight: bold;\r\n\tfont-size: 1.5rem;\r\n\tfont-family: 'Courier New', monospace;\r\n}\r\n\r\n.timer-value.warning {\r\n\tcolor: #f44336;\r\n\tanimation: pulse 1s ease-in-out infinite;\r\n}\r\n\r\n@keyframes pulse {\r\n\t0%,\r\n\t100% {\r\n\t\topacity: 1;\r\n\t}\r\n\t50% {\r\n\t\topacity: 0.6;\r\n\t}\r\n}\r\n\r\n.parent-history-bar {\r\n\twidth: 100%;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tgap: 4px;\r\n\tmargin-top: 0.25rem;\r\n\tmargin-bottom: 0.25rem;\r\n\tposition: relative;\r\n}\r\n\r\n.parent-history-bar .history-row {\r\n\twidth: 100%;\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tgap: 0.65rem;\r\n}\r\n\r\n.parent-history-bar .history-controls {\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tgap: 12px;\r\n}\r\n\r\n.parent-history-bar .history-pill {\r\n\tfont-weight: 700;\r\n\tcolor: #1e293b;\r\n\tbackground: #e2e8f0;\r\n\tborder: 1px solid #cbd5f5;\r\n\tborder-radius: 999px;\r\n\tpadding: 0.25rem 0.85rem;\r\n\tfont-size: 0.85rem;\r\n\ttext-transform: uppercase;\r\n\tletter-spacing: 0.04em;\r\n\tmargin-top: 0.5rem;\r\n}\r\n\r\n.parent-history-bar .history-pill-btn {\r\n\tcursor: pointer;\r\n\ttransition: all 0.2s ease;\r\n\tfont-family: inherit;\r\n}\r\n\r\n.parent-history-bar .history-pill-btn:hover {\r\n\tbackground: #cbd5e1;\r\n\tborder-color: #94a3b8;\r\n\ttransform: translateY(-1px);\r\n}\r\n\r\n.parent-history-bar .history-btn {\r\n\tbackground: #222;\r\n\tcolor: #fff;\r\n\tborder: none;\r\n\tpadding: 6px 10px;\r\n\tborder-radius: 6px;\r\n\tcursor: pointer;\r\n\tmin-width: 40px;\r\n\theight: 36px;\r\n\tdisplay: inline-flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n}\r\n\r\n.parent-history-bar .history-pos {\r\n\tdisplay: inline-block;\r\n\twhite-space: nowrap;\r\n\tfont-size: 0.95rem;\r\n\tcolor: #222;\r\n\tbackground: #f3f3f3;\r\n\tpadding: 6px 10px;\r\n\tborder-radius: 6px;\r\n}\r\n\r\n.parent-history-bar .history-player {\r\n\tmargin-top: 8px;\r\n\tfont-size: 0.95rem;\r\n\tcolor: #444;\r\n\ttext-align: center;\r\n\twidth: 100%;\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tgap: 8px;\r\n}\r\n\r\n.parent-history-bar .game-id-container {\r\n\tmargin-top: 6px;\r\n\tfont-size: 0.9rem;\r\n\tcolor: #666;\r\n\ttext-align: center;\r\n}\r\n\r\n.parent-history-bar #game-id {\r\n\tcolor: #333;\r\n\tfont-weight: 600;\r\n\tdisplay: inline-block;\r\n\tanimation: pulseGameId 0.5s ease-in-out 3;\r\n}\r\n\r\n@keyframes pulseGameId {\r\n\t0% {\r\n\t\ttransform: scale(1);\r\n\t\tcolor: #333;\r\n\t\tfont-weight: 600;\r\n\t}\r\n\t50% {\r\n\t\ttransform: scale(1.8);\r\n\t\tcolor: #74d66d;\r\n\t\tfont-weight: 900;\r\n\t}\r\n\t100% {\r\n\t\ttransform: scale(1);\r\n\t\tcolor: #333;\r\n\t\tfont-weight: 600;\r\n\t}\r\n}\r\n\r\n.parent-history-bar .move-by {\r\n\tfont-weight: 600;\r\n\tcolor: #666;\r\n}\r\n\r\n.parent-history-bar .move-name {\r\n\tcolor: #333;\r\n\tfont-weight: 500;\r\n}\r\n\r\n.parent-history-bar .history-btn[disabled] {\r\n\topacity: 0.35;\r\n\tcursor: default;\r\n\tbackground: #555;\r\n\tcolor: #ddd;\r\n}\r\n\r\n.modal-overlay {\r\n\tposition: fixed;\r\n\ttop: 0;\r\n\tleft: 0;\r\n\twidth: 100vw;\r\n\theight: 100vh;\r\n\tbackground: rgba(0, 0, 0, 0.5);\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tz-index: 9999;\r\n}\r\n\r\n.modal-content {\r\n\tbackground: #fff;\r\n\tpadding: 3rem 2rem;\r\n\tborder-radius: 16px;\r\n\tbox-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\r\n\ttext-align: center;\r\n\twidth: min(90vw, 520px);\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\talign-items: center;\r\n\tgap: 1.5rem;\r\n}\r\n\r\n.error-modal-content {\r\n\tborder-top: 4px solid #f97316;\r\n\tgap: 0.75rem;\r\n\tpadding: 2rem 1.5rem;\r\n}\r\n\r\n.error-title {\r\n\tmargin: 0;\r\n\tcolor: #b45309;\r\n\tfont-size: 1.6rem;\r\n}\r\n\r\n.error-message {\r\n\tmargin: 0;\r\n\tcolor: #92400e;\r\n\tfont-size: 1rem;\r\n}\r\n\r\n.win-header {\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tgap: 0.75rem;\r\n\twidth: 100%;\r\n}\r\n\r\n.win-icon {\r\n\tfont-size: 2.5rem;\r\n}\r\n\r\n.win-title {\r\n\tfont-size: 2.2rem;\r\n\tcolor: #74d66d;\r\n\tmargin: 0;\r\n}\r\n\r\n.score-change {\r\n\tmargin: 0;\r\n\tfont-size: 1.1rem;\r\n\tcolor: #444;\r\n\tline-height: 1.45;\r\n}\r\n\r\n.close-btn {\r\n\tpadding: 0.75rem 2rem;\r\n\tfont-size: 1.1rem;\r\n\tbackground: #74d66d;\r\n\tcolor: #fff;\r\n\tborder: none;\r\n\tborder-radius: 8px;\r\n\tcursor: pointer;\r\n\ttransition: background 0.2s;\r\n\tmin-width: 160px;\r\n}\r\n\r\n.close-btn:hover {\r\n\tbackground: #388e3c;\r\n}\r\n\r\n.modal-title {\r\n\tfont-size: 1.8rem;\r\n\tcolor: #333;\r\n\tmargin: 0 0 1rem 0;\r\n}\r\n\r\n.modal-message {\r\n\tmargin: 0 0 1.5rem 0;\r\n\tfont-size: 1rem;\r\n\tcolor: #444;\r\n\tline-height: 1.6;\r\n}\r\n\r\n.modal-actions {\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\tgap: 0.75rem;\r\n\tflex-wrap: wrap;\r\n\twidth: 100%;\r\n}\r\n\r\n.btn-primary {\r\n\tpadding: 0.75rem 1.5rem;\r\n\tfont-size: 1rem;\r\n\tbackground: #f59e0b;\r\n\t/* color: #fff; */\r\n\tborder: none;\r\n\tborder-radius: 8px;\r\n\tcursor: pointer;\r\n\ttransition: background 0.2s;\r\n\tmin-width: 160px;\r\n\tfont-weight: 800;\r\n}\r\n\r\n.btn-primary:hover {\r\n\tbackground: #d97706;\r\n}\r\n\r\n.btn-secondary {\r\n\tpadding: 0.75rem 1.5rem;\r\n\tfont-size: 1rem;\r\n\tbackground: #e5e7eb;\r\n\tcolor: #374151;\r\n\tborder: none;\r\n\tborder-radius: 8px;\r\n\tcursor: pointer;\r\n\ttransition: background 0.2s;\r\n\tmin-width: 160px;\r\n\tfont-weight: 800;\r\n}\r\n\r\n.btn-secondary:hover {\r\n\tbackground: #d1d5db;\r\n}\r\n\r\n.chat-overlay {\r\n\tz-index: 10000;\r\n}\r\n\r\n.chat-modal {\r\n\tbackground: #fff;\r\n\tborder-radius: 16px;\r\n\tbox-shadow: 0 8px 32px rgba(15, 23, 42, 0.25);\r\n\tpadding: 1.5rem;\r\n\twidth: min(92vw, 480px);\r\n\tmax-height: 85vh;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 1rem;\r\n}\r\n\r\n.chat-header {\r\n\tdisplay: flex;\r\n\tjustify-content: space-between;\r\n\talign-items: flex-start;\r\n\tgap: 1rem;\r\n}\r\n\r\n.chat-header h2 {\r\n\tmargin: 0;\r\n\tfont-size: 1.5rem;\r\n\tcolor: #0f172a;\r\n}\r\n\r\n.chat-subtitle {\r\n\tmargin: 0.15rem 0 0;\r\n\tcolor: #475569;\r\n\tfont-size: 0.9rem;\r\n}\r\n\r\n.chat-close {\r\n\tborder: none;\r\n\tbackground: transparent;\r\n\tfont-size: 1.5rem;\r\n\tline-height: 1;\r\n\tcursor: pointer;\r\n\tcolor: #475569;\r\n}\r\n\r\n.chat-error {\r\n\tbackground: #fef3c7;\r\n\tcolor: #92400e;\r\n\tborder: 1px solid #fde68a;\r\n\tborder-radius: 10px;\r\n\tpadding: 0.5rem 0.75rem;\r\n\tfont-size: 0.85rem;\r\n}\r\n\r\n.chat-body {\r\n\tbackground: #f8fafc;\r\n\tborder-radius: 12px;\r\n\tpadding: 0.75rem;\r\n\tmax-height: 45vh;\r\n\toverflow-y: auto;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 0.75rem;\r\n}\r\n\r\n.chat-loading,\r\n.chat-empty {\r\n\tcolor: #64748b;\r\n\ttext-align: center;\r\n\tfont-size: 0.9rem;\r\n\tpadding: 1rem 0;\r\n}\r\n\r\n.chat-messages {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 0.5rem;\r\n}\r\n\r\n.chat-message {\r\n\tbackground: #fff;\r\n\tborder-radius: 12px;\r\n\tpadding: 0.5rem 0.75rem;\r\n\tbox-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 0.25rem;\r\n}\r\n\r\n.chat-message-self {\r\n\tbackground: #dbeafe;\r\n\talign-self: flex-end;\r\n}\r\n\r\n.chat-meta {\r\n\tdisplay: flex;\r\n\tjustify-content: space-between;\r\n\talign-items: center;\r\n\tgap: 0.35rem;\r\n\tflex-wrap: wrap;\r\n\tfont-size: 0.75rem;\r\n\tcolor: #64748b;\r\n}\r\n\r\n.chat-meta-details {\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tgap: 0.35rem;\r\n\tcolor: inherit;\r\n}\r\n\r\n.chat-author {\r\n\tfont-weight: 600;\r\n\tcolor: #0f172a;\r\n}\r\n\r\n.chat-message-self .chat-author {\r\n\tcolor: #1e3a8a;\r\n}\r\n\r\n.chat-message-self .chat-meta {\r\n\tcolor: #1e3a8a;\r\n}\r\n\r\n.chat-move {\r\n\tfont-weight: 600;\r\n\tcolor: inherit;\r\n\tbackground: transparent;\r\n\tborder: 1px solid currentColor;\r\n\tborder-radius: 999px;\r\n\tpadding: 0.1rem 0.55rem;\r\n\tfont-size: 0.75rem;\r\n\tline-height: 1.2;\r\n\tcursor: pointer;\r\n\tappearance: none;\r\n\t-webkit-appearance: none;\r\n\ttransition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;\r\n}\r\n\r\n.chat-move:hover {\r\n\tbackground: rgba(15, 23, 42, 0.08);\r\n}\r\n\r\n.chat-message-self .chat-move:hover {\r\n\tbackground: rgba(30, 58, 138, 0.15);\r\n}\r\n\r\n.chat-move:focus-visible {\r\n\toutline: 2px solid #2563eb;\r\n\toutline-offset: 2px;\r\n}\r\n\r\n.chat-self-tag {\r\n\tmargin-left: 0.35rem;\r\n\tpadding: 0 0.4rem;\r\n\tborder-radius: 999px;\r\n\tbackground: rgba(37, 99, 235, 0.17);\r\n\tfont-size: 0.65rem;\r\n\tfont-weight: 700;\r\n\tletter-spacing: 0.05em;\r\n\ttext-transform: uppercase;\r\n}\r\n\r\n.chat-time {\r\n\tcolor: inherit;\r\n\twhite-space: nowrap;\r\n}\r\n\r\n.chat-text {\r\n\tmargin: 0;\r\n\tcolor: #0f172a;\r\n\tword-break: break-word;\r\n}\r\n\r\n.chat-form {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 0.75rem;\r\n}\r\n\r\n.chat-input {\r\n\twidth: 100%;\r\n\tborder: 1px solid #cbd5f5;\r\n\tborder-radius: 10px;\r\n\tpadding: 0.75rem;\r\n\tfont-size: 0.95rem;\r\n\tfont-family: inherit;\r\n\tresize: none;\r\n}\r\n\r\n.chat-input:focus {\r\n\toutline: 2px solid #2563eb;\r\n\toutline-offset: 1px;\r\n}\r\n\r\n.chat-form-actions {\r\n\tdisplay: flex;\r\n\tjustify-content: flex-end;\r\n\talign-items: center;\r\n\tgap: 0.5rem;\r\n}\r\n\r\n.chat-emoji-btn {\r\n\twidth: 38px;\r\n\theight: 38px;\r\n\tborder-radius: 50%;\r\n\tborder: 1px solid #cbd5f5;\r\n\tbackground: #fff;\r\n\tfont-size: 1.1rem;\r\n\tline-height: 1;\r\n\tcursor: pointer;\r\n\ttransition: background 0.2s ease, border-color 0.2s ease;\r\n}\r\n\r\n.chat-emoji-btn[aria-pressed='true'] {\r\n\tbackground: #e0f2fe;\r\n\tborder-color: #0ea5e9;\r\n}\r\n\r\n.chat-emoji-btn:hover:not(:disabled) {\r\n\tbackground: #f1f5f9;\r\n}\r\n\r\n.chat-send-btn {\r\n\tborder: none;\r\n\tborder-radius: 999px;\r\n\tbackground: #2563eb;\r\n\tcolor: #fff;\r\n\tfont-weight: 600;\r\n\tpadding: 0.5rem 1.5rem;\r\n\tcursor: pointer;\r\n\ttransition: opacity 0.2s ease;\r\n}\r\n\r\n.chat-send-btn:disabled {\r\n\topacity: 0.5;\r\n\tcursor: not-allowed;\r\n}\r\n\r\n.emoji-picker {\r\n\twidth: 100%;\r\n\tmax-height: 280px;\r\n\tborder-radius: 12px;\r\n\tbox-shadow: 0 4px 20px rgba(15, 23, 42, 0.15);\r\n\toverflow: hidden;\r\n}\r\n\r\n@media (max-width: 768px) {\r\n\t.game-header {\r\n\t\tjustify-content: center;\r\n\t}\r\n\r\n\t.game-header h1 {\r\n\t\tflex-basis: 100%;\r\n\t\tjustify-content: center;\r\n\t\ttext-align: center;\r\n\t}\r\n\r\n\t.user-info {\r\n\t\tflex-basis: 100%;\r\n\t\tjustify-content: center;\r\n\t}\r\n\r\n\t.game-title-text {\r\n\t\tfont-size: 1.25rem;\r\n\t}\r\n\r\n\t.game-logo {\r\n\t\theight: 52px;\r\n\t\tborder-radius: 8px;\r\n\t}\r\n\r\n\t.btn-faq {\r\n\t\tpadding: 0.4rem 0.7rem;\r\n\t\tfont-size: 0.8rem;\r\n\t\tmargin-left: 0.5rem;\r\n\t}\r\n\r\n\t.btn-profile {\r\n\t\twidth: 40px;\r\n\t\theight: 40px;\r\n\t}\r\n\r\n\t.btn-team-chat,\r\n\t.btn-signout {\r\n\t\tpadding: 0.4rem 0.8rem;\r\n\t\tfont-size: 0.85rem;\r\n\t}\r\n}\r\n\r\n@media (max-width: 600px) {\r\n\t.user-info {\r\n\t\tflex-direction: row;\r\n\t\talign-items: center;\r\n\t\tjustify-content: center;\r\n\t}\r\n\r\n\t.active-game {\r\n\t\tpadding: 0.25rem;\r\n\t\tgap: 0.5rem;\r\n\t}\r\n\r\n\t.timer-section {\r\n\t\tpadding: 1rem;\r\n\t}\r\n\r\n\t.timer-section h3 {\r\n\t\tfont-size: 1.25rem;\r\n\t}\r\n\r\n\t.timer {\r\n\t\tfont-size: 1rem;\r\n\t}\r\n\r\n\t.timer-value {\r\n\t\tfont-size: 1.25rem;\r\n\t}\r\n\r\n\t.modal-content {\r\n\t\tpadding: 2.5rem 1.5rem;\r\n\t\twidth: min(95vw, 420px);\r\n\t}\r\n\r\n\t.win-title {\r\n\t\tfont-size: 1.8rem;\r\n\t}\r\n}\r\n</style>\r\n"],"file":"BHUSe8qr.js"}