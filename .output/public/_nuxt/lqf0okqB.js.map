{"version":3,"file":"lqf0okqB.js","sources":["../../../composables/useServerErrors.ts","../../../composables/useAuth.ts"],"sourcesContent":["export function translateServerError(errOrCode: any, translations: any) {\r\n\t// Try common locations for server-side error code\r\n\tconst maybeCode =\r\n\t\terrOrCode &&\r\n\t\t(typeof errOrCode === 'string'\r\n\t\t\t? errOrCode\r\n\t\t\t: errOrCode.statusMessage ||\r\n\t\t\t  errOrCode.data?.statusMessage ||\r\n\t\t\t  errOrCode.code ||\r\n\t\t\t  errOrCode.error ||\r\n\t\t\t  errOrCode.message);\r\n\r\n\tif (!maybeCode)\r\n\t\treturn (\r\n\t\t\t(translations?.errors && translations.errors.ERR_GENERIC) ||\r\n\t\t\t'An error occurred'\r\n\t\t);\r\n\r\n\tconst key = String(maybeCode);\r\n\tif (translations?.errors && translations.errors[key])\r\n\t\treturn translations.errors[key];\r\n\t// If it's a server code but missing translation, fall back to generic\r\n\tif (key.startsWith('ERR_'))\r\n\t\treturn (translations?.errors && translations.errors.ERR_GENERIC) || key;\r\n\t// Otherwise return the message/string as-is\r\n\treturn key;\r\n}\r\n","import { useState } from 'nuxt/app';\r\nimport { computed, onMounted, watch } from 'vue';\r\nimport { useI18n } from './useI18n';\r\nimport { translateServerError } from './useServerErrors';\r\n\r\nexport type AuthPayload = {\r\n\tuser: {\r\n\t\t_id: string;\r\n\t\temail: string;\r\n\t\tname: string;\r\n\t\tpreferredLocale?: string;\r\n\t\tscore: number;\r\n\t\twins?: string[];\r\n\t\tlosses?: string[];\r\n\t\tdraws?: string[];\r\n\t\tunsubscribeDate?: Date | null;\r\n\t\tduckOpinion?: 'favor' | 'opposed';\r\n\t};\r\n\ttoken: string;\r\n};\r\n\r\nexport function useAuth() {\r\n\tconst auth = useState<AuthPayload | null>('auth', () => null);\r\n\tconst { t, setLocale, locale } = useI18n();\r\n\r\n\tonMounted(() => {\r\n\t\tif (typeof window !== 'undefined') {\r\n\t\t\ttry {\r\n\t\t\t\tconst raw = localStorage.getItem('auth');\r\n\t\t\t\tif (raw) auth.value = JSON.parse(raw);\r\n\t\t\t} catch (_) {\r\n\t\t\t\t// ignore parse errors\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (auth.value?.user?.preferredLocale) {\r\n\t\t\tsetLocale(auth.value.user.preferredLocale, true);\r\n\t\t}\r\n\t});\r\n\r\n\twatch(\r\n\t\tauth,\r\n\t\t(val) => {\r\n\t\t\tif (typeof window === 'undefined') return;\r\n\t\t\tif (val) localStorage.setItem('auth', JSON.stringify(val));\r\n\t\t\telse localStorage.removeItem('auth');\r\n\t\t\tif (val?.user?.preferredLocale) {\r\n\t\t\t\tsetLocale(val.user.preferredLocale, true);\r\n\t\t\t}\r\n\t\t},\r\n\t\t{ deep: true }\r\n\t);\r\n\r\n\tconst isAuthenticated = computed(() => !!auth.value);\r\n\r\n\tasync function signup(name: string, email: string, password: string) {\r\n\t\ttry {\r\n\t\t\tconst preferredLocale = locale.value;\r\n\t\t\tconst response = await $fetch<AuthPayload>('/api/auth/signup', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tbody: { name, email, password, locale: preferredLocale },\r\n\t\t\t});\r\n\t\t\tauth.value = response;\r\n\t\t\tif (response.user?.preferredLocale) {\r\n\t\t\t\tsetLocale(response.user.preferredLocale, true);\r\n\t\t\t} else {\r\n\t\t\t\tsetLocale(preferredLocale, true);\r\n\t\t\t}\r\n\t\t\treturn { success: true };\r\n\t\t} catch (error: any) {\r\n\t\t\tconsole.error('Signup error:', error);\r\n\t\t\treturn {\r\n\t\t\t\tsuccess: false,\r\n\t\t\t\terror: translateServerError(error, t.value) || 'Signup failed',\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tasync function signin(email: string, password: string) {\r\n\t\ttry {\r\n\t\t\tconst response = await $fetch<AuthPayload>('/api/auth/signin', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tbody: { email, password },\r\n\t\t\t});\r\n\t\t\tauth.value = response;\r\n\t\t\tif (response.user?.preferredLocale) {\r\n\t\t\t\tsetLocale(response.user.preferredLocale, true);\r\n\t\t\t}\r\n\t\t\treturn { success: true };\r\n\t\t} catch (error: any) {\r\n\t\t\tconsole.error('Signin error:', error);\r\n\t\t\treturn {\r\n\t\t\t\tsuccess: false,\r\n\t\t\t\terror: translateServerError(error, t.value) || 'Signin failed',\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tfunction signout() {\r\n\t\tauth.value = null;\r\n\t}\r\n\r\n\tasync function requestPasswordReset(email: string) {\r\n\t\ttry {\r\n\t\t\tawait $fetch('/api/auth/forgot-password', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tbody: { email, locale: locale.value },\r\n\t\t\t});\r\n\t\t\treturn { success: true };\r\n\t\t} catch (error: any) {\r\n\t\t\tconsole.error('Forgot password error:', error);\r\n\t\t\treturn {\r\n\t\t\t\tsuccess: false,\r\n\t\t\t\terror:\r\n\t\t\t\t\ttranslateServerError(error, t.value) ||\r\n\t\t\t\t\tt.value.errors?.ERR_GENERIC ||\r\n\t\t\t\t\t'Request failed',\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tasync function resetPassword(token: string, password: string) {\r\n\t\ttry {\r\n\t\t\tawait $fetch('/api/auth/reset-password', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tbody: { token, password },\r\n\t\t\t});\r\n\t\t\treturn { success: true };\r\n\t\t} catch (error: any) {\r\n\t\t\tconsole.error('Reset password error:', error);\r\n\t\t\treturn {\r\n\t\t\t\tsuccess: false,\r\n\t\t\t\terror:\r\n\t\t\t\t\ttranslateServerError(error, t.value) ||\r\n\t\t\t\t\tt.value.errors?.ERR_GENERIC ||\r\n\t\t\t\t\t'Reset failed',\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tfunction getAuthHeader() {\r\n\t\tif (auth.value?.token) {\r\n\t\t\treturn { Authorization: `Bearer ${auth.value.token}` };\r\n\t\t}\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\treturn {\r\n\t\tauth: computed(() => auth.value),\r\n\t\tuser: computed(() => auth.value?.user || null),\r\n\t\tisAuthenticated,\r\n\t\tsignup,\r\n\t\tsignin,\r\n\t\tsignout,\r\n\t\trequestPasswordReset,\r\n\t\tresetPassword,\r\n\t\tgetAuthHeader,\r\n\t};\r\n}\r\n"],"names":["translateServerError","errOrCode","translations","maybeCode","key","useAuth","auth","useState","setLocale","locale","useI18n","onMounted","raw","watch","val","isAuthenticated","computed","signup","name","email","password","preferredLocale","response","error","signin","signout","requestPasswordReset","resetPassword","token","getAuthHeader"],"mappings":"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"}